<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)" /><meta name="author" content="JaeHo YooN" /><meta property="og:locale" content="en" /><meta name="description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><meta property="og:description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><link rel="canonical" href="https://dkssud8150.github.io/posts/yolo/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/yolo/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-21T15:10:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo YooN"},"dateModified":"2022-12-30T21:30:39+09:00","datePublished":"2022-04-21T15:10:00+09:00","description":"Do focus on developing ‘your ability’ rather than waste time on making you famous.","headline":"[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/yolo/"},"url":"https://dkssud8150.github.io/posts/yolo/"}</script><title>[데브코스] 10주차 - DeepLearning Yolo v3 coding (1) | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-21 15:10:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 21, 2022, 3:10 PM +0900" >Apr 21, 2022</em> </span> <span> Updated <em class="timeago" date="2022-12-30 21:30:39 +0900 " data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 30, 2022, 9:30 PM +0900" >Dec 30, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9405 words"> <em>52 min</em> read</span></div></div></div><div class="post-content"><p><br /></p><h1 id="yolo-v3">Yolo v3</h1><h2 id="architecture">Architecture <a href="#architecture" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/dev/week10/day5/architecture.png" data-proofer-ignore></p><p>backbone는 darknet53을 사용했고, 이렇게 나온 feature map과 추가적으로 연산한 후의 feature map들을 다 추출해서 합치게 된다. 이를 통해 크기가 각기 다른 객체들을 잘 탐지할 수 있다. 13x13 feature map에서는 grid가 13일 것이고, 그렇다면 큰 객체를 잘 찾을 수 있고, 52x52 feature map에서는 작은 객체를 잘 찾을 수 있을 것이다.</p><p>darknet을 구현하고, 연구한 사람의 <a href="https://github.com/alexeyAB/darknet">github</a>는 다음과 같다. 이 곳을 들어가면 darknet이 구현되어 있는데, c++로 구현되어 있어 pytorch를 사용하는데 있어서 모델을 변경시키거나 커스터마이징하기가 다소 복잡하다. 따라서 직접 구현을 해볼 것이다.</p><p><br /></p><h2 id="prepare-data">prepare data <a href="#prepare-data" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>yolo format yolo 데이터 폴더에는 한 폴더 안에 이미지와 annotation 파일이 함께 있다.</ul><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>yolodata
  ⊢ train
    ⊢ a.jpg
    ⊢ a.txt
    ⊢ b.jpg
    ⊢ b.txt
    ...
  ⊢ eval
  ∟ test
</pre></table></code></div></div><p>따라서 jpg 파일들을 먼저 불러온 다음 그에 맞게 해당하는 annotation을 불러오도록 만든다.</p><p><br /></p><p>yolo의 labeling format은 [class_index, x_center, y_center, width, height]로 되어 있다. 이 때, x,y,w,h는 전체 이미지에 대해 normalize되어 있다. 따라서 전체 이미지를 곱해줘야 실제 위치들이 나타난다.</p><p><br /></p><ul><li>PASCAL VOC format</ul><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>voc20xx
  ⊢ jpegimages
    ⊢ a.jpg
    ⊢ b.jpg
    ⊢ c.jpg
    ...
  ⊢ annotations
    ⊢ a.xml
    ⊢ b.xml
    ⊢ c.xml
  ∟ imagesets
    ⊢ train.txt
    ⊢ eval.txt
</pre></table></code></div></div><p>pascal voc 의 경우 annotation과 이미지는 다른 폴더에 들어가 있고, imagesets라는 폴더는 train, eval 데이터에 대한 정보들을 저장한 곳이다. train.txt를 보게 되면 경로도 없고, 확장자도 없이 파일명만 넣어져 있다.</p><p><br /></p><ul><li>KITTI format</ul><p>kitti의 label format은 다음과 같다.</p><pre><code class="language-txt">Truck 0.00 0 -1.57 599.41 156.40 629.75 189.25 2.85 2.63 12.34 0.47 1.49 69.44 -1.56
</code></pre><p><img data-src="/assets/img/dev/week10/day5/kitti.png" data-proofer-ignore></p><ul><li>type: 총 9개의 클래스에 대한 정보이다. tram은 길거리에 있는 기차를 말하고, misc는 구별하기 어려운 애매한 차량들을 지칭하는 것이고, doncares는 너무 멀리 있어서 점으로 보이거나, 잘려서 보이는 차량들에 대한 클래스로 지정해놓은 것이다.<li>truncated : 차량이 이미지에서 벗어난 정도를 나타낸다. 0~1사이의 값으로 표현된다.<li>occluded : 다른 오브젝트에 의해 가려진 정도를 나타낸다. 0은 전체가 다 보이는 것, 1은 일부만 ,2는 많이 가려진 정도, 3은 아예 안보이는 것으로 나타낸다.<li>alpha : 객체의 각도를 나타낸다.<li>bbox : left, top, right, bottom에 대한 bounding box 좌표를 나타낸다.</ul><p><br /></p><p>더 깔끔한 데이터셋을 만들기 위해 PASCAL VOC format을 사용하여 모델을 구성하고자 한다. 그리고 xml파일이 아닌 txt파일로 사용할 것이다. kitti를 yolo로 바꾸고, 다시 pascal voc format으로 진행할 것이다.</p><p>먼저 kitti를 yolo로 변환하는 것에는 <a href="https://github.com/ssaru/convert2Yolo">convert2Yolo</a>라는 깃허브 사이트가 있어서 이를 클론하여 사용하면 편하다.</p><p><br /></p><p><br /></p><p>annotation이 잘 되어 있는지를 확인해봐야 하므로, labeling tool을 사용하여 확인해봐야 한다. 종류에는 labelimg(https://github.com/tzutalin/labelImg)와 yolo_label(https://github.com/developer0hye/Yolo_Label) 이 있다. window는 후자, linux는 전자의 프로그램을 사용하는 것이 좋을 것 같다. 이 프로그램을 통해 직접 annotation을 제작할 수도 있고, 조도를 바꾸는 등의 다양한 기능을 제공한다.</p><p><img data-src="/assets/img/dev/week10/day4/labelImg.jpg" data-proofer-ignore> <img data-src="/assets/img/dev/week10/day4/yololabel.gif" data-proofer-ignore></p><p><br /></p><p><br /></p><p><br /></p><p>이제 직접 데이터를 다운받고, 정리를 해주자.</p><p>먼저 데이터를 다운받는 방법에는 KITTI Dataset 홈페이지를 들어가서 다운받아도 되지만, 코드로 구현을 해서 다운을 받을수도 있다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>curl https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_image_2.zip <span class="nt">--create-dirs</span> ./datasets/KITTI/ <span class="nt">-o</span> ./datasets/KITTI/img_kitti.zip
<span class="nb">cd</span> ./datasets/KITTI <span class="o">&amp;&amp;</span> unzip <span class="nt">-d</span> <span class="nb">.</span> img_kitti.zip

curl https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_label_2.zip <span class="nt">--create-dirs</span> ./datasets/KITTI/train/Annotations <span class="nt">-o</span> ./datasets/KITTI/train/Annotations/lab_kitti.zip
<span class="nb">cd</span> ./datasets/KITTI/train/Annotations <span class="o">&amp;&amp;</span> unzip <span class="nt">-d</span> <span class="nb">.</span> lab_kitti.zip
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">curl &lt;url&gt; --create-dirs &lt;folder name to download&gt; -o &lt;dir/zip file name.zip&gt;</code> <code class="language-plaintext highlighter-rouge">cd &lt;dir&gt; &amp;&amp; unzip -d &lt;dir to upzip&gt; &lt;zip filename.zip&gt;</code></p><p>자신이 다운받고자 하는 폴더의 경로를 설정해서 타이핑하면 된다. 나의 경로는 다음과 같다.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>./datasets
  ∟ KITTI
    ⊢ train
      ⊢ Annotations
        ⊢ 000000.txt
        ⊢ 000001.txt
        ⊢ 000002.txt
        ...
      ⊢ ImageSets
        ∟ train.txt
      ∟ JPEGimages
        ⊢ 000000.png
        ⊢ 000001.png
        ⊢ 000002.png
        ...
    ∟ test
      ⊢ ImageSets
        ∟ test.txt
      ∟ JPEGimages
        ⊢ 000000.png
        ⊢ 000001.png
        ⊢ 000002.png
        ...
</pre></table></code></div></div><p>이미지는 train과 test가 함께 있으므로 KITTI폴더에 다운 받은 후 알맞게 분배하고 이름도 변경해주고, Annotation의 경우 train에 대한 것뿐이므로 train폴더에 풀고 경로에 맞게 집어넣어준다.</p><p>그 다음 imageset의 파일들을 생성하기 위해서는 다음과 같은 코드를 사용하여 파일을 만들어준다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>datasets/KITTI/train&gt; <span class="nb">dir</span> /b /s .<span class="se">\A</span>nnotations<span class="se">\*</span>.txt <span class="o">&gt;&gt;</span> ./ImageSets/train.txt
</pre></table></code></div></div><p><br /></p><pre><code class="language-txt">C:\Users\dkssu\dev\datasets\KITTI\train\Annotations\000000.txt
C:\Users\dkssu\dev\datasets\KITTI\train\Annotations\000001.txt
C:\Users\dkssu\dev\datasets\KITTI\train\Annotations\000002.txt
C:\Users\dkssu\dev\datasets\KITTI\train\Annotations\000003.txt
C:\Users\dkssu\dev\datasets\KITTI\train\Annotations\000004.txt
...
</code></pre><p>여기에서 경로와 확장자를 다 지워준다.</p><pre><code class="language-txt">000000
000001
000002
000003
000004
...
</code></pre><p><br /></p><p>test도 동일하게 만들어준다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>datasets/KITTI/test&gt; <span class="nb">dir</span> /b /s .<span class="se">\J</span>PEGimages<span class="se">\*</span>.png <span class="o">&gt;&gt;</span> ./ImageSets/test.txt
</pre></table></code></div></div><pre><code class="language-txt">000000
000001
000002
000003
000004
...
</code></pre><p><br /></p><p><br /></p><h3 id="configuration">configuration <a href="#configuration" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>파라미터에 대한 파일은 다음 주소로 들어가 파일을 다운로드한다.</p><p><a href="https://github.com/dkssud8150/dev_yolov3/blob/master/config/yolov3.cfg">https://github.com/dkssud8150/dev_yolov3/blob/master/config/yolov3.cfg</a></p><p><br /></p><p>config 파일에서 network 부분의 config 파라미터만 불러온다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1"># watch parse the yolov3 configuaraion about network
</span><span class="k">def</span> <span class="nf">parse_hyperparam_config</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">'#'</span><span class="p">)]</span> <span class="c1"># #으로 시작하지 않는 줄만 저장
</span>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">().</span><span class="nf">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="c1"># module에 대한 definition
</span>    <span class="n">module_defs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># layer devision
</span>        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">"["</span><span class="p">):</span>
          <span class="n">type_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">"net"</span><span class="p">:</span> <span class="c1"># net은 network의 hyperparameter는 저장 x
</span>              <span class="n">module_defs</span><span class="p">.</span><span class="nf">append</span><span class="p">({})</span> <span class="c1"># dictionary
</span>              <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
              <span class="k">if</span> <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'batch_normalize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># default bat normalize
</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">!=</span> <span class="s">'net'</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)</span>
            <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">module_defs</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">#</code>로 되어 있는 것은 주석이므로 제거하고, 나머지를 lines에 저장한다. 좌우 빈칸이 존재할 수 있으므로 삭제해준다. 그 다음으로 <code class="language-plaintext highlighter-rouge">[</code>로 시작되는 부분은 아래 부분들이 어떤 부분의 내용인지를 나타내는 것이므로 저장을 해놓아야 한다. net이면 network, 즉 criterion이나 optimizer에 대한 hyperparameter들에 대한 것이고, convolutional은 convolution을 할 때의 filter 사이즈나 stride 값이다.</p><p>batch normalize는 0으로 default로 설정하고, network에 대한 것들만 보기 위해서 net 부분에서의 key와 value를 <code class="language-plaintext highlighter-rouge">=</code>을 기준으로 입력해준다. 결과를 출력해주면 다음과 같다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">[{</span><span class="s1">'type'</span>: <span class="s1">'net'</span>, <span class="s1">'batch'</span>: <span class="s1">'4'</span>, <span class="s1">'subdivisions'</span>: <span class="s1">'1'</span>, <span class="s1">'width'</span>: <span class="s1">'640'</span>, <span class="s1">'height'</span>: <span class="s1">'480'</span>, <span class="s1">'channels'</span>: <span class="s1">'3'</span>, <span class="s1">'class'</span>: <span class="s1">'8'</span>, <span class="s1">'momentum'</span>: <span class="s1">'0.9'</span>, <span class="s1">'decay'</span>: <span class="s1">'0.0005'</span>, <span class="s1">'angle'</span>: <span class="s1">'0'</span>, <span class="s1">'saturation'</span>: <span class="s1">'1.5'</span>, <span class="s1">'exposure'</span>: <span class="s1">'1.5'</span>, <span class="s1">'hue'</span>: <span class="s1">'.1'</span>, <span class="s1">'ignore_cls'</span>: <span class="s1">'99'</span>, <span class="s1">'learning_rate'</span>: <span class="s1">'0.01'</span>, <span class="s1">'burn_in'</span>: <span class="s1">'1000'</span>, <span class="s1">'max_batches'</span>: <span class="s1">'500200'</span>, <span class="s1">'policy'</span>: <span class="s1">'steps'</span>, <span class="s1">'steps'</span>: <span class="s1">'400000,450000'</span>, <span class="s1">'scales'</span>: <span class="s1">'.1,.1'</span><span class="o">}]</span>
</pre></table></code></div></div><p><br /></p><p>저장한 param들에서 원하는 데이터들만 추출한다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1"># get the data to want to be ours.
</span><span class="k">def</span> <span class="nf">get_hyperparam</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'net'</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'batch'</span><span class="p">])</span>
            <span class="n">subdivision</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'subdivisions'</span><span class="p">])</span>
            <span class="n">momentum</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'momentum'</span><span class="p">])</span>
            <span class="n">decay</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'decay'</span><span class="p">])</span>
            <span class="n">saturation</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'saturation'</span><span class="p">])</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'learning_rate'</span><span class="p">])</span>
            <span class="n">burn_in</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'burn_in'</span><span class="p">])</span>
            <span class="n">max_batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'max_batches'</span><span class="p">])</span>
            <span class="n">lr_policy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">'policy'</span><span class="p">]</span>
            <span class="n">in_width</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'width'</span><span class="p">])</span>
            <span class="n">in_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'height'</span><span class="p">])</span>
            <span class="n">in_channels</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'channels'</span><span class="p">])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'classes'</span><span class="p">])</span>
            <span class="n">ignore_class</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'ignore_cls'</span><span class="p">])</span>

            <span class="k">return</span><span class="p">{</span><span class="s">'batch'</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
                   <span class="s">'subdivision'</span><span class="p">:</span> <span class="n">subdivision</span><span class="p">,</span>
                   <span class="s">'momentum'</span><span class="p">:</span> <span class="n">momentum</span><span class="p">,</span>
                   <span class="s">'decay'</span><span class="p">:</span> <span class="n">decay</span><span class="p">,</span>
                   <span class="s">'saturation'</span><span class="p">:</span> <span class="n">saturation</span><span class="p">,</span>
                   <span class="s">'lr'</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
                   <span class="s">'burn_in'</span><span class="p">:</span> <span class="n">burn_in</span><span class="p">,</span>
                   <span class="s">'max_batch'</span><span class="p">:</span> <span class="n">max_batch</span><span class="p">,</span>
                   <span class="s">'lr_policy'</span><span class="p">:</span> <span class="n">lr_policy</span><span class="p">,</span>
                   <span class="s">'in_width'</span><span class="p">:</span> <span class="n">in_width</span><span class="p">,</span>
                   <span class="s">'in_height'</span><span class="p">:</span> <span class="n">in_height</span><span class="p">,</span>
                   <span class="s">'in_channels'</span><span class="p">:</span> <span class="n">in_channels</span><span class="p">,</span>
                   <span class="s">'classes'</span><span class="p">:</span> <span class="n">classes</span><span class="p">,</span>
                   <span class="s">'ignore_class'</span><span class="p">:</span> <span class="n">ignore_class</span><span class="p">}</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
</pre></table></code></div></div><p>이렇게 저장된 결과물을 출력해보면 다음과 같다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span><span class="s1">'batch'</span>: 4, <span class="s1">'subdivision'</span>: 1, <span class="s1">'momentum'</span>: 0.9, <span class="s1">'decay'</span>: 0.0005, <span class="s1">'saturation'</span>: 1.5, <span class="s1">'lr'</span>: 0.01, <span class="s1">'burn_in'</span>: 1000, <span class="s1">'max_batch'</span>: 500200, <span class="s1">'lr_policy'</span>: <span class="s1">'steps'</span>, <span class="s1">'in_width'</span>: 640, <span class="s1">'in_height'</span>: 480, <span class="s1">'in_channels'</span>: 3, <span class="s1">'classes'</span>: 8, <span class="s1">'ignore_class'</span>: 99<span class="o">}</span>
</pre></table></code></div></div><p><br /></p><h2 id="dataloader">Dataloader <a href="#dataloader" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>데이터셋을 만들고, loader까지 하기 위해 폴더를 생성하고 거기서 작업을 한다.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>...
  ⊢ dataloader
    ⊢ __init__.py
    ⊢ yolo_data.py
</pre></table></code></div></div><h3 id="yolo_datapy">yolo_data.py <a href="#yolo_datapy" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="k">class</span> <span class="nc">Yolodata</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span> <span class="c1"># torch utils data의 dataset을 상속받는다.
</span>
    <span class="c1"># format path
</span>    <span class="n">file_dir</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">anno_dir</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">file_txt</span> <span class="o">=</span> <span class="s">''</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="s">'C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">dkssu</span><span class="se">\\</span><span class="s">dev</span><span class="se">\\</span><span class="s">datasets</span><span class="se">\\</span><span class="s">KITTI</span><span class="se">\\</span><span class="s">'</span>
    <span class="c1"># train dataset path
</span>    <span class="n">train_img</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">JPEGimages'</span>
    <span class="n">train_txt</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">Annotations'</span>
    <span class="c1"># valud dataset path
</span>    <span class="n">valid_img</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">JPEGimages'</span>
    <span class="n">valid_txt</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">Annotations'</span>

    <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Car'</span><span class="p">,</span> <span class="s">'Van'</span><span class="p">,</span> <span class="s">'Truck'</span><span class="p">,</span> <span class="s">'Pedestrian'</span><span class="p">,</span> <span class="s">'Persion_sitting'</span><span class="p">,</span> <span class="s">'Cyclist'</span><span class="p">,</span> <span class="s">'Tram'</span><span class="p">,</span> <span class="s">'Misc'</span><span class="p">]</span> <span class="c1"># doncare는 x
</span>    <span class="n">num_classes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="p">[]</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cfg_param</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yolodata</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_class</span> <span class="o">=</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'classes'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_train</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_img</span>
            <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_txt</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">ImageSets</span><span class="se">\\</span><span class="s">train.txt'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">valid_img</span>
            <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">valid_txt</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">ImageSets</span><span class="se">\\</span><span class="s">valid.txt'</span>


        <span class="n">img_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'UTF-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">()]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_names</span><span class="p">:</span>
            <span class="c1">#print(i)
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".JPG"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".JPG"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".png"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".png"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".PNG"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".PNG"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span>
</pre></table></code></div></div><p>dataset이 있는 곳의 dir을 base_dir로 정의해주고, 그 안에 있는 image와 annotation 파일들의 경로를 지정한다. 클래스 이름들도 미리 정의를 해주고, 생성과 편집을 편리하게 하기 위해 file_dir, anno_dir, file_txt 변수를 만들어 상황에 맞게 이곳에 집어넣는다.</p><p>그 다음 이미지의 이름들이 적힌 ImageSets의 txt파일을 불러와 img_names 리스트에 저장시켜준다. 이 때, replace를 하지 않으면 1줄씩 띄워져서 저장이 되므로 enter를 지우고 저장시킨다. 저장된 파일명을 통해 image_data를 불러온다. 확장자가 어떤 것인지 모르므로 다 적용시켜서 붙여준다.</p><p><br /></p><p><br /></p><ul><li>image data</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">Image</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">).</span><span class="nf">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">img_origin_h</span><span class="p">,</span> <span class="n">img_origin_w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># img shape : [H,W,C]
</span></pre></table></code></div></div><p>이미지 경로를 받아서 이미지 파일을 열어 저장하고, 이미지의 크기도 저장한다.</p><p><br /></p><ul><li>annotation data</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre>        <span class="c1"># annotation dir이 있는지 확인, txt파일 읽기
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span><span class="p">):</span>
            <span class="n">txt_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'.png'</span><span class="p">,</span> <span class="s">'.PNG'</span><span class="p">,</span> <span class="s">'.jpg'</span><span class="p">,</span> <span class="s">'.JPG'</span><span class="p">]:</span>
                <span class="n">txt_name</span> <span class="o">=</span> <span class="n">txt_name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">'.txt'</span><span class="p">)</span>
            <span class="n">anno_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">+</span> <span class="n">txt_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">anno_path</span><span class="p">):</span>
                <span class="k">return</span>
            
            <span class="n">bbox</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">anno_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># annotation about each image
</span>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
                    <span class="n">gt_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)]</span> <span class="c1"># [class, center_x, center_y, width, height]
</span>
                    <span class="c1"># skip when abnormal data
</span>                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">gt_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">cls</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                
                    <span class="n">bbox</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="n">cls</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

            <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="c1"># skip empty target
</span>            <span class="n">empty_target</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1"># even if object does not exist in image, we have to put bbox data
</span>            <span class="k">if</span> <span class="n">bbox</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">empty_target</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span> <span class="c1"># bbox의 형태가 객체가 2개일경우 [[a,b,c,d,e],[a,b,c,d,e]] 이므로, 형태를 맞추기 위해 [[]]로 생성
</span>            
            <span class="c1"># data augmentation
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">bbox</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">))</span>

            <span class="c1"># 해당 데이터가 몇번째 배치인지 확인하기 위한 index
</span>            <span class="c1"># 지금 getitem으로 얻은 데이터는 1개의 이미지에 대한 것인데, 학습을 위해서는 batch size로 묶어야 하므로 index를 추가
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_target</span><span class="p">:</span>
                <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">bbox</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 객체 개수만큼 크기를 생성
</span>
                <span class="n">target_data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">batch_idx</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bbox</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># batch index의 x는 1, y는 객체 개수의 array로 만들어줘서, bbox와 concat
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">anno_path</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># test or valid mode
</span>            <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><ul><li>len</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">)</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><h2 id="train">train <a href="#train" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="c1"># only use valid data
</span>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">batch</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span> 
    <span class="c1"># skip invalid data
</span>    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>
    <span class="c1"># print(targets[0].shape, targets[1].shape)
</span>    <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span> <span class="c1"># mk 3dim -&gt; 4dim, 0index = batch
</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="c1"># insert 0 index of box of dataloader function, instead of zero 
</span>        <span class="n">boxes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># print(targets.shape)
</span>    <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span>
</pre></table></code></div></div><p>customdataset을 구성하게 되면 datset은 각 이미지마다의 정보들을 불러온다. 그러나 학습에서는 batch 단위로 학습을 하기 때문에 batch 단위로 만들어줘야 한다. 이것을 위해 collate_fn을 사용한다. 대부분 이 함수를 직접 선언해주고 사용한다.</p><p>batch를 인자로 받아 사용되고, batch는 batch크기로 dataset의 값들을 저장해놓은 변수이다. 이에 대해 batch의 각 단위들을 읽어불러오며 비어있지 않은 값들을 저장시킨다. Yolodata에서 리턴하는 값들은 img, target, anno_path이므로 <code class="language-plaintext highlighter-rouge">zip(*iterables)</code> 함수를 사용하여 batch size 단위로 묶어서 저장한다.</p><p><a href="https://excelsior-cjh.tistory.com/100">zip(*iterables) 참고 사이트</a></p><p>list(zip(*batch))를 통해 zip을 통해 같은 index의 위치에 있는 요소들끼리 묶어서 tuple을 만들고, 다 묶은 것들을 list로 묶어놓는다. 이렇게 만들어진 정보들을 stack을 통해 차원 하나를 더 생성한 것이다.</p><p><code class="language-plaintext highlighter-rouge">torch.Size([3, 608, 608]) =&gt; torch.Size([1, 3, 608, 608])</code></p><p><br /></p><p>target의 경우, 우리의 yolodata 클래스를 들어가보면 batch idx 자리가 있는데, 모두 0으로 만들어져 있다. 이것을 0 대신 해당 batch index를 삽입한다. 그리고 targets.shape에 대한 코드들을 출력해보면 다음과 같다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>torch.Size<span class="o">([</span>1, 6]<span class="o">)</span> torch.Size<span class="o">([</span>8, 6]<span class="o">)</span>
torch.Size<span class="o">([</span>9, 6]<span class="o">)</span>
</pre></table></code></div></div><p>확인을 위해 batch를 2로 주었을 때의 출력이고, 위의 size를 먼저보게 되면 1,8이 객체 수를 의미한다. 각 image마다의 객체 수를 1개로 합치는 것이 <code class="language-plaintext highlighter-rouge">torch.cat</code>이다. 추후 코드를 짤 때도 batch마다의 총 객체 수를 통해 구현을 할 예정이므로 이렇게 묶어주었다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">Dataloader</span>

<span class="s">''' train '''</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">using_gpus</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"train"</span><span class="p">)</span>
    
    <span class="c1"># dataloader
</span>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="nc">Yolodata</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                       <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                       <span class="n">cfg_param</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">)</span>
    
    <span class="n">train_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> 
                              <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'batch'</span><span class="p">],</span>
                              <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                              <span class="n">drop_last</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                              <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate_fn</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"iter {}, img {}, targets {}, anno_path {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">i</span> <span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target_data</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">anno_path</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"gt_data {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">target_data</span><span class="p">))</span>
        <span class="k">break</span>
</pre></table></code></div></div><p>만든 dataset을 torch.utils.data.dataloader에 있는 Dataloader를 통해 학습에 맞는 형태로 생성한다. 위에서도 말했듯이 collate_fn을 생성해줘야 학습에 맞는 크기로 구성이된다.</p><ul><li>num_workers : cpu와 gpu의 데이터 교류를 담당하는데, 0 이면 default값으로 single process와 비슷하게 진행된다. 0 이상을 넣게 되면 multi threading 방식으로 진행된다.<li>pin_memory : 이미지나 데이터 array를 gpu로 올릴 때 memory의 위치를 할당할지 말지에 대한 인자이다.</ul><p><br /></p><p>출력을 보게 되면 다음과 같다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iter 0, img torch.Size<span class="o">([</span>1, 375, 1242, 3]<span class="o">)</span>, targets torch.Size<span class="o">([</span>1, 5, 6]<span class="o">)</span>, anno_path <span class="o">[</span><span class="s1">'C:\\Users\\dkssu\\dev\\datasets\\KITTI\\train\\Annotations\\000545.txt'</span><span class="o">]</span>
</pre></table></code></div></div><p>target에 대해 조금 더 자세히 보기 위해 000545.txt도 함께 본다. 이 txt의 내용은 다음과 같고, 그 아래는 gt_data즉 target_data를 출력한 것이다.</p><pre><code class="language-txt">0 0.906 0.564 0.185 0.212
1 0.499 0.54 0.043 0.139
0 0.589 0.569 0.076 0.095
7 0.421 0.525 0.024 0.039
1 0.42 0.499 0.021 0.077
</code></pre><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>gt_data tensor<span class="o">([[[</span>0.0000, 0.0000, 0.9060, 0.5640, 0.1850, 0.2120],
         <span class="o">[</span>0.0000, 1.0000, 0.4990, 0.5400, 0.0430, 0.1390],
         <span class="o">[</span>0.0000, 0.0000, 0.5890, 0.5690, 0.0760, 0.0950],
         <span class="o">[</span>0.0000, 7.0000, 0.4210, 0.5250, 0.0240, 0.0390],
         <span class="o">[</span>0.0000, 1.0000, 0.4200, 0.4990, 0.0210, 0.0770]]],
</pre></table></code></div></div><p>txt파일과 비교하여 보았을 때 target_data의 1번째는 batch index에 대한 것이고, 2번째는 object index, 3~6은 bbox에 대한 정보가 담겨져 있다.</p><p><br /></p><p><br /></p><h2 id="data-transform">Data Transform <a href="#data-transform" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>

<span class="kn">import</span> <span class="n">imgaug</span> <span class="k">as</span> <span class="n">ia</span>
<span class="kn">from</span> <span class="n">imgaug</span> <span class="kn">import</span> <span class="n">augmenters</span> <span class="k">as</span> <span class="n">iaa</span>
<span class="kn">from</span> <span class="n">imgaug.augmentables.bbs</span> <span class="kn">import</span> <span class="n">BoundingBox</span><span class="p">,</span> <span class="n">BoundingBoxesOnImage</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="n">xywh2xyxy_np</span>
</pre></table></code></div></div><p>필요한 패키지들을 import한다. imgaug란 data augmentation(데이터 증강)에 사용되는 툴로 사용법은 <a href="https://github.com/aleju/imgaug">깃허브</a>에 나와있다. 일반적으로 transform을 할 때 분류 태스크에서는 큰 문제가 생기지 않으나 object detection의 경우 이미지 크기를 변환시키거나 affine하면 그에 따라 bounding box도 변형되어야 한다. 그러므로 이를 잘 지원해주는 툴이 imgaug 이다. 사용을 위해서는 설치가 필요하다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>pip <span class="nb">install </span>imgaug
</pre></table></code></div></div><p><br /></p><h3 id="data_transformpy">data_transform.py <a href="#data_transformpy" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1"># absolute bbox
</span><span class="k">class</span> <span class="nc">AbsoluteLabels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> <span class="c1"># yolodata코드에서 transform이 들어갈 때 (img, bbox)가 data로 들어옴
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">w</span> <span class="c1"># cx, w *= w
</span>        <span class="n">label</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">h</span> <span class="c1"># cy, h *= h
</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># relative bbox
</span><span class="k">class</span> <span class="nc">RelativeLabels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">w</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>
</pre></table></code></div></div><p>annotation 파일에 있는 데이터들은 이미지 크기에 대해 정규화되어 있다. 이것을 transform하기 위해 정규화를 풀어줘야 한다. 그래야 transform을 해도 정보를 잃지 않는다. 우리는 data를 (img, bbox)의 형태로 집어넣기 때문에 이에 대해 각각을 처리해준다.</p><p>정규화를 풀어주고 transform을 하고 난 후에는 다시 상대적 값으로 변환해줘야 한다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ResizeImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_size</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">new_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">new_size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>
</pre></table></code></div></div><p>이미지 data augmentation을 위해 resize하는 class를 정의한다. 이 때, interpolation이란 보간을 의미하는데, 이미지를 변환할 때 생기는 빈 공간등을 처리하는 방식을 정의한다. 그리고, cv2 툴을 사용하여 resize하는데, label은 어차피 상대적인 값이므로 resize를 하지 않아도, 나중에 resize된 w,h를 곱해주면 자동으로 적용이 된다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ToTensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># normalize, transpose HWC to CHW
</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nc">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>
</pre></table></code></div></div><p>학습을 위해서는 tensor형태로 변환해줘야 한다. 우리가 가지고 있는 image 차원은 [H,W,C]인데, tensor의 차원은 [C,H,W]이어야 하므로 이를 transpose해야 하고, 이미지들을 정규화하여 집어넣게 된다.</p><p>label은 tensor로만 변환하여 리턴한다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1"># util/tools.py
</span><span class="k">def</span> <span class="nf">xywh2xyxy_np</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># centerx - w/2 = minx
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># miny
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># maxx
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># maxy
</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></table></code></div></div><p>이 부분은 편의를 위해 정의해놓은 함수로 tools.py에 위치시켜놓는다. 현재 우리가 가지고 있는 bbox는 [center_x, center_y, w, h] 이므로 imgaug의 포맷을 맞춰주기 위해 [min x, min y, max x, max y] 의 형태로 바꾼다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c1"># augmentation template, 
# 앞으로 다른 augmentation을 사용할 때 이 template을 상속받아서 구현할 것이다. 공통적으로 augmentation을 할 때마다 bbox가 augmentation방식에 따라 값이 변해야 하므로
</span><span class="k">class</span> <span class="nc">ImgAug</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">augmentations</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">augmentations</span> <span class="o">=</span> <span class="n">augmentations</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># unpack data
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># convert xywh to minx,miny,maxx,maxy because of imgAug format
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="nf">xywh2xyxy_np</span><span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># 0 index is class info
</span>
        <span class="c1"># convert bbox to imgaug format
</span>        <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="nc">BoundingBoxesOnImage</span><span class="p">(</span>
                                <span class="p">[</span><span class="nc">BoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">],</span>
                                <span class="n">shape</span><span class="o">=</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1">#apply augmentation
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">augmentations</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
                                                 <span class="n">bounding_boxes</span><span class="o">=</span><span class="n">bounding_boxes</span><span class="p">)</span>

        <span class="c1"># 예외 처리, 이미지 밖으로 나가는 bounding box를 제거
</span>        <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">bounding_boxes</span><span class="p">.</span><span class="nf">clip_out_of_image</span><span class="p">()</span>

        <span class="c1"># convert bounding boxes to np.array()
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">bounding_boxes</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span> <span class="c1"># memory assignment
</span>        <span class="k">for</span> <span class="n">box_idx</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">bounding_boxes</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">y2</span> <span class="c1"># x1,y1,x2,y2 멤버 변수를 가지고 있음
</span>
            <span class="c1"># return [x, y, w, h], 원래의 포맷은 xywh이므로 다시 변환
</span>            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">label</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">boxes</span>


<span class="k">class</span> <span class="nc">DefaultAug</span><span class="p">(</span><span class="n">ImgAug</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">augmentations</span> <span class="o">=</span> <span class="n">iaa</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">([</span>
                                    <span class="n">iaa</span><span class="p">.</span><span class="nc">Sharpen</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                                    <span class="n">iaa</span><span class="p">.</span><span class="nc">Affine</span><span class="p">(</span><span class="n">rotate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">translate_percent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
                                    <span class="p">])</span>
</pre></table></code></div></div><p>imgAug 클래스는 추후에 우리가 적용시킬 다양한 augmentation의 템플릿으로 사용할 용도로 정의한 것으로 image와 label을 정의한 augmentation을 적용시켜서 리턴해주는 방식이다. 각기 다른 augmnetation 클래스마다 작성해줄 수 있지만, 이렇게 하면 코드도 길어지고, 반복적인 작업을 줄일 수 있다. 먼저 numpy형태로 변환해준 bbox들을 위에서 정의해놓은 xywh2xyxy_np를 사용하여 변환시켜준다. 그렇게 변환된 [minx,miny,maxx,maxy] 형태의 bbox들은 imgaug를 사용하여 imgaug 포맷으로 변환한다. 그 후 미리 정의한 augmentation을 적용 시키고, 이미지 밖으로 나가는 boundingbox 좌표들은 제거한다. 그 후 원래의 형태인 xywh 포맷으로 변환시켜준 후 리턴한다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_transformations</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">is_train</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
        <span class="n">data_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span><span class="nc">AbsoluteLabels</span><span class="p">(),</span>
                                             <span class="nc">DefaultAug</span><span class="p">(),</span>
                                             <span class="nc">RelativeLabels</span><span class="p">(),</span>
                                             <span class="nc">ResizeImage</span><span class="p">(</span><span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">],</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])),</span>
                                             <span class="nc">ToTensor</span><span class="p">(),</span>
        <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span><span class="nc">AbsoluteLabels</span><span class="p">(),</span>
                                             <span class="nc">DefaultAug</span><span class="p">(),</span>
                                             <span class="nc">RelativeLabels</span><span class="p">(),</span>
                                             <span class="nc">ResizeImage</span><span class="p">(</span><span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">],</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])),</span>
                                             <span class="nc">ToTensor</span><span class="p">(),</span>
        <span class="p">])</span>

    <span class="k">return</span> <span class="n">data_transform</span>
</pre></table></code></div></div><p>다 정의해준 클래스들을 통해 transform 묶음에 집어넣는다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>

        <span class="nf">drawBox</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">())</span> <span class="c1"># detach는 backprop나 등등의 torch의 graph에서 떼내는 것이고, gpu이면 cpu로 데이터를 복사
</span>        <span class="k">break</span>
</pre></table></code></div></div><p>그렇게 augmentation이 적용된 이미지를 살펴보기 위해 drawbox 함수를 만들어서 선언한다. drawBox 함수는 아래와 같다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">drawBox</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">*</span> <span class="mi">255</span>

    <span class="k">if</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">fromarray</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>

    <span class="c1"># draw = ImageDraw.Draw(img_data)
</span>    <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></table></code></div></div><p>채널이 3, 즉 컬러 이미지라면 원래 형태는 tensor(C,H,W)이므로 이를 다시 표현하기 위해 (W,H,C)로 변화하고 0~255에 대한 데이터타입으로 uint8로 지정한다.</p><p><br /></p><p><br /></p><h2 id="architecture-1">Architecture <a href="#architecture-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="utiltoolspy">util/tools.py <a href="#utiltoolspy" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>yolov3.cfg에서 convolutional에 대한 것만 추출한다. 방식은 network에 대한 module_defs를 추출하는 것과 동일하다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c1"># parse model layer configuration
</span><span class="k">def</span> <span class="nf">parse_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">'#'</span><span class="p">)]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">().</span><span class="nf">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="n">module_defs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">type_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">"["</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">'net'</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">module_defs</span><span class="p">.</span><span class="nf">append</span><span class="p">({})</span>
            <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
            <span class="k">if</span> <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'batch_normalize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">"net"</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">module_defs</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><h3 id="modelyolov3py">model/yolov3.py <a href="#modelyolov3py" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'batch'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_channels'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'classes'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span> <span class="o">=</span> <span class="nf">parse_model_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">layer_info</span><span class="p">):</span>
        <span class="n">module_list</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">()</span>
        <span class="n">in_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">in_channels</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">layer_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">layer_info</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">])</span>
</pre></table></code></div></div><p>이를 출력해보면 다음과같다.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>0 convolutional
1 convolutional
2 convolutional
3 convolutional
4 shortcut
5 convolutional
6 convolutional
7 convolutional
8 shortcut
...
81 convolutional
82 yolo
83 route
84 convolutional
85 upsample
86 route
87 convolutional
88 convolutional
89 convolutional
90 convolutional
91 convolutional
92 convolutional
93 convolutional
94 yolo
95 route
96 convolutional
97 upsample
98 route
99 convolutional
100 convolutional
...
</pre></table></code></div></div><p>다음과 같이 convolutional과 yolo, route, upsample 등의 layer로 구성되어 있다.</p><p>여기서 convolutional은 우리가 아는 convolution에 대한 값들이다. 그리고, shortcut와 route는 그림과 함께 살펴봐야 한다.</p><p><img data-src="/assets\img\dev\week10\day5\architecture.png" data-proofer-ignore></p><p>먼저 그림에서 봤을 때, 분홍색 부분이 residual block이다. residual block이란 지난 값을 연산 후의 값과 더하여 연산량을 줄이는 방식을 말한다. 식은 <code class="language-plaintext highlighter-rouge">g(x) = F(x) + x</code>이고, 이전 layer의 출력값을 x, 연산에 의한 값을 f(x), 현재 출력값을 g(x)라고 한다. 자세한 내용은 https://coding-yoon.tistory.com/141 이 사이트를 참고하는 것이 좋을 것 같다. 그래서 residual block에서 지난 값 x를 가져올 때 shortcut의 값만큼 이전의 layer에서의 값을 가져온다는 것이다. 즉 shortcut가 -3이면 현재 layer에서 3개 layer이전의 값인 x를 더하여 g(x)를 구한다.</p><p>route도 얼마나 이전의 layer인지를 뜻하는 것으로, 그림에서 3번째 강아지 사진과 2번째 사진 사이에 <code class="language-plaintext highlighter-rouge">*</code> 연산을 하는 곳이 있다. 이것은 concat한다는 의미로, route = -4이면 4개 이전의 layer의 feature map과 concat하는 것이고, route = 95 이면 95번째 layer의 값을 concat한다는 것이다.</p><p>좀 더 자세히 설명하기 위해 config 파일을 가져와보았다.</p><pre><code class="language-txt">[shortcut]
from=-3
activation=linear

######################

[route]
layers = -4

...

[route]
layers = -1, 61
</code></pre><p>shortcut layer의 경우 from=-3이라 되어 있다. 이는 3개 이전의 layer와 더한다는 것이다. 그러나 route의 경우 2가지 경우가 있다. layers = -4인 경우에는 그냥 4개 이전의 layer의 feature map을 그대로 가져와 input으로 사용하겠다는 의미이고, layer = -1, 61이면 1개 이전의 layer와 61번째 layer를 concat하겠다는 의미이다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">layer_info</span><span class="p">):</span> <span class="c1"># init layer setting
</span>        <span class="n">module_list</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">()</span> <span class="c1"># layer를 하나하나 정의하는 것은 너무 오래 걸리고 옛날방식이다. module에 대한 list를 만들어주는 메서드
</span>        <span class="n">in_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">in_channels</span><span class="p">]</span> <span class="c1"># first channels of input
</span>        <span class="k">for</span> <span class="n">layer_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">layer_info</span><span class="p">):</span> 
            <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">()</span> <span class="c1"># 많은 layer들을 하나의 묶음으로 만들어주는 메서드
</span>            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="nf">make_conv_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="c1"># conv layer add
</span>                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">'filters'</span><span class="p">]))</span> <span class="c1"># store each module's input channels
</span>            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'shortcut'</span><span class="p">:</span>            
                <span class="nf">make_shortcut_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>   <span class="c1"># shortcut layer add
</span>                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'route'</span><span class="p">:</span>
                <span class="nf">make_route_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>      <span class="c1"># route layer add
</span>                <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s">'layers'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>                    <span class="c1"># layers에 있는 정보들을 다 가져옴
</span>                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                 
                    <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>                          <span class="c1"># 1개인 경우에는 거기에 있는 feature map을 그대로 사용
</span>                <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="c1"># 2개인 경우 concat
</span>                
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'upsample'</span><span class="p">:</span>
                <span class="nf">make_upsample_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="c1"># upsample layer add
</span>                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># width, height만 커지므로 channel은 동일
</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'yolo'</span><span class="p">:</span>
                <span class="n">yololayer</span> <span class="o">=</span> <span class="nc">Yololayer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">in_width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">in_height</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">training</span><span class="p">)</span>
                <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_yolo'</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">)</span>
                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                
            <span class="n">module_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module_list</span>
</pre></table></code></div></div><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">make_conv_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_channels</span> <span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'filters'</span><span class="p">])</span> <span class="c1"># output channel size
</span>    <span class="n">size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">])</span> <span class="c1"># kernel size
</span>    <span class="n">stride</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'stride'</span><span class="p">])</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="c1"># layer_info['pad']
</span>    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_conv'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">pad</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'batch_normalize'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_bn'</span><span class="p">,</span>
                            <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'leaky'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_act'</span><span class="p">,</span>
                            <span class="n">nn</span><span class="p">.</span><span class="nc">LeakyReLU</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'relu'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_act'</span><span class="p">,</span>
                            <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">make_shortcut_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">"_shortcut"</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Identity</span><span class="p">())</span> <span class="c1"># modulelist에서 info 타입이 맞지 않으면 복잡해지므로 빈 공간으로 init
</span>
<span class="k">def</span> <span class="nf">make_route_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">"_route"</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Identity</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">make_upsample_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'stride'</span><span class="p">])</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_upsample'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">))</span>
</pre></table></code></div></div><p>add_module 메서드는 (이름, 함수)로 구성되어 있어 각각의 역할에 대한 이름과 기능을 추가한다. config 파일에서 conv layer 관련해서는 batch_normalize, activation 등이 존재했기 때문에 이 또한 추가해주었다.</p><p>shortcut와 route는 기본적으로 구성되어야 할 함수가 없으므로 빈 공간으로 집어넣어 주었다. Identity를 하면 입력을 그대로 출력으로 내뱉어준다.</p><p>upsample layer의 경우 stride가 존재하고, upsample에 대한 torch 함수가 지원되므로 이를 사용한다. upsample을 할 때 빈 공간을 어떻게 채울지에 대한 mode도 설정해준다.</p><p><br /></p><ul><li>yolo layer</ul><p>yolo에 대한 layer는 연산이 복잡하기 때문에 따로 class를 구현했다. yolov3.cfg 파일에서 yolo에 대한 정보는 다음과 같고, mask과 anchor는 anchor가 총 9개가 정의되어 있는데, 각 yolo layer마다 9개 모두를 사용하지 않는다. mask에 해당하는 index의 anchor들만 사용한다. 그래서 아래의 경우는 3,4,5 즉 50,71~ 43,212 만을 사용한다. 50,71은 anchor 박스의 크기를 나타내는 것으로 width = 50, height = 71이다.</p><p>classes는 class의 개수이고, ignore_thresh는 loss 계산할 때 박스들이 threshold이상인 것만 positive로 정의하고, 나머지는 negative로 정의할 때 사용되는 값이다.</p><pre><code class="language-txt">[yolo]
mask = 3,4,5
anchors = 15,36,  30,49,  19,115,  50,71,  76,106,  43,212, 115,145, 129,230, 194,280
classes=8
num=9
jitter=.3
ignore_thresh = .5
truth_thresh = 1
random=1
</code></pre><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Yololayer</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_width</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">in_height</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_train</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yololayer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'classes'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ignore_thresh</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'ignore_thresh'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">box_attr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">+</span> <span class="mi">5</span>                     <span class="c1"># output channel = box[4] + objectness[1] + class_prob[n]
</span>        <span class="n">mask_idxes</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'mask'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>
        <span class="n">anchor_all</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'anchors'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span> <span class="c1"># w1,h1 , w2,h2 , w3,h3 , ... 로 되어 있으므로 이것을 다시 w,h 를 묶어줘야 한다.
</span>        <span class="n">anchor_all</span> <span class="o">=</span> <span class="p">[(</span><span class="n">anchor_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">anchor_all</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">anchor_all</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="n">anchor_all</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mask_idxes</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="n">in_width</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="n">in_height</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c1"># feature map의 1 grid가 차지하는 픽셀의 값 == n x n
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lw</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="c1"># bounding box를 뽑을 수 있게 sigmoid나 exponantional을 취해줌
</span>        <span class="c1"># x is input. [N C H W]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># feature map's width, height
</span>        <span class="n">self</span><span class="p">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">anchor</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># 연산을 할 때 동일한 곳에 올라가 있어야함, cpu input이라면 cpu에, gpu input이라면 gpu에
</span>        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="n">torch</span><span class="p">.</span><span class="nf">div</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">in_width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">,</span> <span class="n">rounding_mode</span> <span class="o">=</span> <span class="s">'floor'</span><span class="p">),</span> 
                                    <span class="n">torch</span><span class="p">.</span><span class="nf">div</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">in_height</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span><span class="p">,</span> <span class="n">rounding_mode</span> <span class="o">=</span> <span class="s">'floor'</span><span class="p">)]).</span><span class="nf">to</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># stride = input size / feature map size
</span>
        <span class="c1"># if kitti data, n_classes = 8, C = (8 + 5) * 3 = 39, yolo layer 이전의 filters 즉 output channels을 보면 다 39인 것을 확인할 수 있다.
</span>        <span class="c1"># [batch, box_attrib * anchor, lh, lw] ex) [1,39,19,19]
</span>        <span class="c1"># 4dim -&gt; 5dim [batch, anchor, lh, lw, box_attrib]
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">anchor</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">box_attr</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span> <span class="c1"># permute를 통해 dimension 순서를 변경, configuouse를 해야 바뀐채로 진행됨
</span>        <span class="k">return</span> <span class="n">x</span>
</pre></table></code></div></div><p>stride의 경우 convolutional에서 사용되는 stride와는 다르다. 이 때의 stride는 feature map에서 grid로 나뉘어져 있는데, 이 한 grid가 차지하는 픽셀의 크기를 의미한다.</p><p>x가 현재에는 4dimension [batch, box_attribute * number of anchor, lh, lw] 을 가지고 있는데, 이를 보기 편하도록 5dim [batch, anchor, lh, lw, box_attrib] 으로 변환한다. 이를 위해 view를 통해 변환해주고, box_attrib의 속성을 맨 뒤로 보내주기 위해 permute 메서드를 사용한다. 그 후 실제 변환을 유지시키기 위해 contiguous()도 추가한 후 리턴한다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    <span class="n">model</span> <span class="o">=</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg_param</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="nf">named_parameters</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"name : {}, shape : {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
</pre></table></code></div></div><p>이것들을 입력받아 출력을 해보면 다음과 같이 출력된다.</p><pre><code class="language-txt">name : module_list.0.layer_0_conv.weight, shape : torch.Size([32, 3, 3, 3])
name : module_list.0.layer_0_conv.bias, shape : torch.Size([32])
name : module_list.0.layer_0_bn.weight, shape : torch.Size([32])
name : module_list.0.layer_0_bn.bias, shape : torch.Size([32])
name : module_list.1.layer_1_conv.weight, shape : torch.Size([64, 32, 3, 3])
name : module_list.1.layer_1_conv.bias, shape : torch.Size([64])
...
name : module_list.104.layer_104_bn.bias, shape : torch.Size([256])
name : module_list.105.layer_105_conv.weight, shape : torch.Size([39, 256, 1, 1])
name : module_list.105.layer_105_conv.bias, shape : torch.Size([39])
</code></pre><p><br /></p><p>추가적으로 입력의 이미지 크기가 608 x 608 이라 했을 때, 이것들이 network들을 거치면서 1/2씩 크기가 작아진다. 그래서 304, 152, 76, 38, 19 로 작아진다. 그래서 4번 reshape이 되어도 계속 짝수가 되도록 만들어줘야 한다.</p><p>그리고 yolov3에서는 출력이 총 3번 이루어지는데, 19x19, 38x38, 76x76으로 output이 만들어진다. 출력에 대한 것은 뒤에 다시 살펴보도록 하자.</p><p><br /></p><p>위의 부분들이 잘 마무리되었으면 이제 실제 모델 학습에 사용될 forward를 구현해야 한다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">yolo_result</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 최종 output들은 yolo layer에서 나옴
</span>        <span class="n">layer_result</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># shortcut, route에서 사용하기 위해 저장
</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">module_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'shortcut'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">layer_result</span><span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="s">'from'</span><span class="p">])]</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'yolo'</span><span class="p">:</span>
                <span class="n">yolo_x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">yolo_x</span><span class="p">)</span>
                <span class="n">yolo_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">yolo_x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'upsample'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'route'</span><span class="p">:</span>
                <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="s">'layers'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">layer_result</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"idx : {}, result : {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">layer_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">yolo_result</span>
</pre></table></code></div></div><p>미리 전부 선언해주었기 때문에 forward는 다소 단순하게 구현할 수 있다. 미리 만들어둔 layer들과 module_cfg 파일의 값들을 1줄씩 함께 읽어나가며 연산을 진행한다. type에 따라 식들이 달라질 수 있으므로 다 처리해주고, 우리가 실제로 출력받는 값들은 yolo layer에서 출력이 되므로 이에 대한 값들을 저장하기 위홰 yolo_result 리스트를 선언하고, shortcut이나 route에서 이전 값들을 재사용해야 하므로 layer의 출력값들을 저장할 수 있는 layer_result도 만들어준다.</p><p>shortcut이나 route의 경우 미리 만들어둔 layer를 사용하지 않고도 연산이 가능한데, 이 이유는 위에서도 말했듯이 zip을 진행하는데 두 개의 list의 크기가 맞지 않으면 연산이 복잡해지기 때문에 빈 공간으로 선언해둔 것이다.</p><p>이들을 직접 print해보면 다음과 같은 출력들을 볼 수 있다.</p><pre><code class="language-txt">idx : 0, result : torch.Size([1, 32, 608, 608])
idx : 1, result : torch.Size([1, 64, 304, 304])
idx : 2, result : torch.Size([1, 32, 304, 304])
idx : 3, result : torch.Size([1, 64, 304, 304])
idx : 4, result : torch.Size([1, 64, 304, 304])
...
idx : 103, result : torch.Size([1, 128, 76, 76])
idx : 104, result : torch.Size([1, 256, 76, 76])
idx : 105, result : torch.Size([1, 39, 76, 76])
idx : 106, result : torch.Size([1, 3, 76, 76, 13])
</code></pre><p>총 106층의 layer가 존재하고, 그에 맞게 각각의 결과들이 존재한다. 결과의 shape은 [batch, channels, height, width] 이다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>    <span class="n">model</span> <span class="o">=</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg_param</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># yolo layer는 3개, 19x19 grid, box attr가 8개 클래스와 box 4와 objectness 1, 3개의 anchor, batch 1
</span>        <span class="c1"># 19x19, 38x38, 76x76의 grid를 가지는 출력값 3개를 받는다.
</span>        <span class="nf">print</span><span class="p">(</span><span class="s">"shape : {} {} {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></table></code></div></div><p>결과를 출력해보면 다음과 같은 shape들을 볼 수 있다.</p><pre><code class="language-txt">shape : torch.Size([1, 3, 19, 19, 13]) torch.Size([1, 3, 38, 38, 13]) torch.Size([1, 3, 76, 76, 13])
</code></pre><p>우리의 입력은 608x608이다. 맞춰주기 위해 config파일에서 width, height를 608로 수정하였다. input size는 위의 idx0 에서 확인할 수 있다. 이를 $ 2^5 $로 나누게 되면 19x19 이 된다. 19x19, 38x38, 76x76의 grid에 대한 출력을 받을 수 있게 된다. 1은 batch size, 3은 anchor 개수, 13은 n_classes[8] + objectness score[1] + box point[4]이다.</p><p><br /></p><p><br /></p><ul><li>weight initialize</ul><p>모델의 파라미터들을 초기화하여 조금 더 나은 학습 환경을 만들어준다. 초기화 방법은 kaiming_uniform_을 사용한다. 이에 대해서는 다음 url을 참고하여 더 자세히 볼 수 있다.</p><p>https://pytorch.org/docs/stable/nn.init.html?highlight=kaiming#torch.nn.init.kaiming_uniform_</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1"># model/yolov3.py
</span>    <span class="k">def</span> <span class="nf">initialize_weights</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># track all layers
</span>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">kaiming_uniform_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span> <span class="c1"># weight initializing
</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># scale
</span>                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1"># shift
</span>            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">kaiming_uniform_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># yolov3.py
</span>    <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">initialize_weights</span><span class="p">()</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><h2 id="train-1">Train <a href="#train-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>train을 위해 새로운 directory를 생성한다.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>...
    ⊢ __init__.py
    ∟ train.py
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1"># train.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="p">,</span> <span class="n">hyparam</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">torchwriter</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">eval_loader</span> <span class="o">=</span> <span class="n">eval_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_batch</span> <span class="o">=</span> <span class="n">hyparam</span><span class="p">[</span><span class="s">'max_batch'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="nc">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'lr'</span><span class="p">],</span> <span class="n">momentum</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'momentum'</span><span class="p">])</span>

        <span class="n">self</span><span class="p">.</span><span class="n">scheduler_multistep</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="nc">MultiStepLR</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">,</span> 
                                                             <span class="n">milestones</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">60</span><span class="p">],</span>
                                                             <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">run_iter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="c1"># drop the batch when invalid values
</span>            <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">input_img</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">input_img</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targets</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
            

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">run_iter</span><span class="p">()</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># yolov3.py
</span>    <span class="n">train</span> <span class="o">=</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hyparam</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">)</span>
    <span class="n">train</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
</pre></table></code></div></div><p>실제 학습을 진행할 코드로 model, train_loader, valid_loader, cfg파일 내용을 가져온다. cfg파일에 max_batch라는 내용도 있는데, 이는 최대 batch를 나타낸다. 즉 몇 batch까지만 진행을 할 것인지에 대한 내용이다.</p><p>최적화 함수로는 SGD를 사용하고, lr은 cfg파일에 있는 그대로 사용하고, momentum또한 작성되어 있는대로 사용한다.</p><p>scheduler도 선언해주었는데, 이는 학습을 진행할 때마다 learning rate값이 줄어들어야 더 정교하게 학습이 가능하다. 떨어지는 빈도를 설정해주어야 하는데, 우리는 MultiStepLR을 사용하였다. milestones의 경우 언제 learning rate를 수정할 것인지에 대한 것이고, gamma는 얼마나 수정시킬 것인지에 대한 값이다.</p><p>지정해준 trainer를 run하게 되면 학습이 진행된다. 그러나 이는 epoch 단위로 돌아가게 되어있고, run_iter에서 각각의 batch마다 학습을 진행하도록 만들어진다. yolo_data.py에서 train_loader가 가지고 있는 값들에는 img, target_data, anno_path이므로 이를 받아주어 출력해보면 다음과 같다.</p><pre><code class="language-txt">torch.Size([1, 3, 608, 608]) torch.Size([1, 4, 6])
torch.Size([1, 3, 608, 608]) torch.Size([1, 6, 6])
torch.Size([1, 3, 608, 608]) torch.Size([1, 4, 6])
torch.Size([1, 3, 608, 608]) torch.Size([1, 2, 6])
</code></pre><p>앞은 input size에 대한 정보이고, 두번째는 target에 대한 정보이다. [batch, number of object, box attrib + class info]로 구성되어 있다.</p><p><br /></p><p><br /></p></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/yolo/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/yolo.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/classlog/'>Classlog</a>, <a href='/categories/devcourse/'>devcourse</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devcourse/" class="post-tag no-text-decoration" >devcourse</a> <a href="/tags/deeplearning/" class="post-tag no-text-decoration" >deeplearning</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[데브코스] 10주차 - DeepLearning Yolo v3 coding (1) - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/yolo/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[데브코스] 10주차 - DeepLearning Yolo v3 coding (1) - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/yolo/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/yolo/&amp;text=[데브코스] 10주차 - DeepLearning Yolo v3 coding (1) - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/yolo/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/numpy/"><div class="card-body"> <em class="timeago small" date="2022-04-11 14:40:00 +0900" >Apr 11, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning Numpy & Matplotlib</h3><div class="text-muted small"><p> Numpy Numpy 설치 및 불러오기 pip install numpy import numpy as np 파이썬의 리스트는 머신러닝에서 가장 많이 사용되는 구조 중 하나일 것이다. 그러나 이 리스트는 연산 속도가 느리다. 그래서 연산을 효과적으로 할 수 있도록 하기 위해 만든 것이 Numpy이다. Numpy 연산 속도 nump...</p></div></div></a></div><div class="card"> <a href="/posts/dplearn/"><div class="card-body"> <em class="timeago small" date="2022-04-12 15:40:00 +0900" >Apr 12, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning AI & machine learning</h3><div class="text-muted small"><p> 기계 학습 어떤 컴퓨터 프로그램이 T라는 작업을 수행할 때, 이 프로그램의 성능이 P라는 척도로 평가했을 때 경험 E를 통해 성능이 개선된다면 이 프로그램은 학습한다고 말할 수 있다. 따라서 최적의 알고리즘을 찾는 행위를 기계 학습이라 할 수 있다. 기계 학습의 중심은 경험, 과업, 성능에 있다. 예전에는 지식 기반의 학습을 했다. 즉, 인간이...</p></div></div></a></div><div class="card"> <a href="/posts/mlmath/"><div class="card-body"> <em class="timeago small" date="2022-04-13 15:40:00 +0900" >Apr 13, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning Mathematics for Machine Learning</h3><div class="text-muted small"><p> 기계 학습에서 수학은 손실함수를 정의하고 손실함수의 최저점을 찾아주는 최적화 이론에 사용된다. 제어를 함에 있어서도 수학이 필요하다. 선형대수 데이터는 벡터나 행렬, 텐서 형태로 되어 있는데, 이에 대한 공간을 이해하고, 연산을 하기 위해서는 선형대수가 필요하다. 벡터와 행렬 벡터는 요소의 종료와 크기를 표현한다. [x \in R^n] ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/od/" class="btn btn-outline-primary" prompt="Older"><p>[데브코스] 10주차 - DeepLearning Object Detection</p></a> <a href="/posts/yolo2/" class="btn btn-outline-primary" prompt="Newer"><p>[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>