<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)" /><meta name="author" content="JaeHo YooN" /><meta property="og:locale" content="en" /><meta name="description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><meta property="og:description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><link rel="canonical" href="https://dkssud8150.github.io/posts/yolo2/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/yolo2/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-25T22:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo YooN"},"dateModified":"2022-05-17T02:56:35+09:00","datePublished":"2022-04-25T22:30:00+09:00","description":"Do focus on developing ‘your ability’ rather than waste time on making you famous.","headline":"[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/yolo2/"},"url":"https://dkssud8150.github.io/posts/yolo2/"}</script><title>[데브코스] 10주차 - DeepLearning Yolo v3 coding (2) | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[데브코스] 10주차 - DeepLearning Yolo v3 coding (2)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-25 22:30:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 25, 2022, 10:30 PM +0900" >Apr 25, 2022</em> </span> <span> Updated <em class="timeago" date="2022-05-17 02:56:35 +0900 " data-toggle="tooltip" data-placement="bottom" title="Tue, May 17, 2022, 2:56 AM +0900" >May 17, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="10113 words"> <em>56 min</em> read</span></div></div></div><div class="post-content"><p><br /></p><h1 id="yolo-v3">Yolo v3</h1><h2 id="loss">Loss <a href="#loss" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">training</span><span class="p">):</span>
        <span class="p">...</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span> <span class="o">=</span> <span class="nf">parse_model_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">yolo_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">module_list</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yololayer</span><span class="p">)]</span>
</pre></table></code></div></div><p>진행하기 전에 Darknet53에서 yolo_layers를 추가한다. 이는 darknet53 클래스 내에서 module_list, 즉 우리가 만들어준 layer들에서 Yololayer에 해당하는 것만 저장되어 있는 멤버 변수이다. 추후에 yololayer에서의 anchor과 stride를 사용하기 위해 선언해주었다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Yololoss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">n_class</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yololoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_class</span> <span class="o">=</span> <span class="n">n_class</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mseloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># mean squared entropy
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bceloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BCELoss</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># binary cross entropy
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bcelogloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)).</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># take log for BCE        
</span></pre></table></code></div></div><p>추후 loss를 구할 때 사용할 mseloss와 bcelogloss를 선언해놓는다. mseloss의 경우 두 입력값의 제곱의 차를 통해 loss를 구하는 것이다. bcelogloss의 경우 bceloss에 log를 취해준 방법이다.</p><p><br /></p><p>loss를 구하기 위해 함수를 생성한다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="c1"># loss_class, loss_box, loss_objectness
</span>        <span class="n">lcls</span><span class="p">,</span> <span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> 
        
        <span class="c1"># predict idx, bbox for 3 yolo layers
</span>        <span class="k">for</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">pout</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
            <span class="c1"># pout.shape : [batch, anchors, grid_h, grid_w, box_attrib]
</span>            <span class="nf">print</span><span class="p">(</span><span class="s">"yolo {}, shape {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">pidx</span><span class="p">,</span> <span class="n">pout</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
</pre></table></code></div></div><p>학습을 통해 예측된 값이 pred로 들어오고, targets가 GT값이다. 이를 실행해보면 출력은 다음과 같은 형태로 된다. 각 yololayer에서의 bbox의 개수를 구해보면, anchor * grid_h * grid_w 이다. 따라서 0번째 layer는 3 * 19 * 19이고, 3개의 layer에서의 총 box 개수는 22743개가 된다. 이 많은 box들에 대해 loss를 구하게 되면 연산량이 너무 많아진다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>yolo 0, shape torch.Size<span class="o">([</span>2, 3, 19, 19, 13]<span class="o">)</span>
yolo 1, shape torch.Size<span class="o">([</span>2, 3, 38, 38, 13]<span class="o">)</span>
yolo 2, shape torch.Size<span class="o">([</span>2, 3, 76, 76, 13]<span class="o">)</span>
</pre></table></code></div></div><p>box들에는 positive prediction과 negative prediction이 존재한다. positive, negative란 예측한 bbox가 gt bbox와 얼마나 겹치는지를 계산한 후 특정 threshold보다 높으면 positive, 낮으면 negative이다. 우리가 loss를 구하는 종류에는 objectness 에 대한 loss, class score에 대한 loss, bbox에 대한 loss가 있어야 한다. 보통은 bbox loss와 class loss는 positive predict로만 구하고, objectness loss는 negative predict로만 구하는데, 만약 pos : neg = 0.01 : 0.99 의 비율을 가진다면, loss가 노이즈가 너무 많이 생기는 현상이 발생할 수 있다.</p><p>따라서 positive에 대한 값들만 추출해서 loss를 계산하고자 했다.</p><p><br /></p><p><br /></p><hr /><p><br /></p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="c1"># loss_class, loss_box, loss_objectness
</span>        <span class="n">lcls</span><span class="p">,</span> <span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">tanchors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_targets</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">)</span>
</pre></table></code></div></div><p>먼저 추후에 저장할 각 loss들을 0으로 된 tensor로 선언해둔다. 그리고 positive에 대한 값들만 추출하기 위한 함수, get_targets를 선언한다.</p><p>들어가기 전 각 인자들의 shape를 살펴보자.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>pred : torch.Size<span class="o">([</span>2, 3, 19, 19, 13]<span class="o">)</span>, targets : torch.Size<span class="o">([</span>9, 6]<span class="o">)</span>
</pre></table></code></div></div><ul><li>pred : [batch, num of anchor, grid_y, grid_x, box_attrib]<li>targets : [num of targets in batch, (batch_id, class_id, box[4])]</ul><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre>    <span class="c1"># for comparing prediction and gt conveniently, we transpose shape
</span>    <span class="k">def</span> <span class="nf">get_targets</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="n">num_anch</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">num_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                  <span class="c1"># num of targets in batch
</span>        <span class="n">tcls</span><span class="p">,</span> <span class="n">tboxes</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">anch</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>    <span class="c1"># output : target_class, target_box, index, anchor
</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>        <span class="c1"># make targets to 7-dim, [batch_id, cls_id, cx, cy, w, h, anchor_id]
</span>
        <span class="c1"># anchor index
</span>        <span class="c1"># ai.shape = (1x3) =&gt; 3x1, and repeat targets's num
</span>        <span class="n">ai</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="p">.</span><span class="n">device</span><span class="p">).</span><span class="nf">float</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">)</span>
        <span class="c1"># to make targets to be anchor's number, targets.shape multiple anchor's num(3)
</span>        
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">targets</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ai</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#print("targets : ", targets.shape)
</span>        <span class="c1"># [batch_id, class_id, box_cx, box_cy, box_w, box_h, anchor_id]
</span>        
        <span class="k">for</span> <span class="n">yi</span><span class="p">,</span> <span class="n">yl</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">yololayer</span><span class="p">):</span>
            <span class="c1"># 각 yolo layer feature map에 맞게 설정
</span>            <span class="c1"># cfg 파일에서의 anchors는 608에 대한 값, 19x19, 38x38에 대한 값으로 만들어줘야 함
</span>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">yl</span><span class="p">.</span><span class="n">anchor</span> <span class="o">/</span> <span class="n">yl</span><span class="p">.</span><span class="n">stride</span> 
            <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">yi</span><span class="p">].</span><span class="n">shape</span><span class="p">)[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="c1"># [1,1,grid_w, grid_h, grid_w, grid_h,1]
</span>
            <span class="c1"># multiple [box_cx, box_cy,box_w,box_y] * grid size, to unpack normalize
</span>            <span class="c1"># targets's[2:6] is to be some number dependent on grid size
</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">*</span> <span class="n">gain</span>


            <span class="k">if</span> <span class="n">num_targets</span><span class="p">:</span>
                <span class="c1"># in figure2 of yolov3 paper, w, h of bounding box is anchor size * exp(prediction's w) or exp(prediction's h)
</span>                <span class="c1"># so, r = exp(prediction_w) = box_w / anchor_w
</span>                <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span>
                <span class="c1"># r.shape : torch.Size([3, 15, 2]) t.shape : torch.Size([3, 15, 7]) anchors[:, None].shape : torch.Size([3, 1, 2])
</span>
                <span class="c1"># extract maximum exp(prediction_w)
</span>                <span class="c1"># select the ratios less than 4, remove the too large ratios
</span>                <span class="c1"># print(r)
</span>                <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">r</span><span class="p">).</span><span class="nf">max</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span>
                <span class="c1"># print("max : ", torch.max(r, 1. / r).max(dim = 2)[0])
</span>                <span class="c1"># print(j)
</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># extract value for true
</span>            <span class="k">else</span><span class="p">:</span> <span class="c1"># num_targets == 0
</span>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># batch_id, class_id with long and transpose using filtered data to had proper anchor shape 
</span>            <span class="n">batch</span><span class="p">,</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">].</span><span class="nf">long</span><span class="p">().</span><span class="n">T</span>

            <span class="n">gt_xy</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">gt_wh</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

            <span class="c1"># define the Cx, Cy in figure2. Cx Cy is index of grid
</span>            <span class="c1"># if in 19x19 gt_xy is 17.2,17.3, Cx Cy about object is 17,17
</span>            <span class="n">gt_ij</span> <span class="o">=</span> <span class="n">gt_xy</span><span class="p">.</span><span class="nf">long</span><span class="p">()</span> <span class="c1"># make integer from float type
</span>            <span class="n">gt_i</span><span class="p">,</span> <span class="n">gt_j</span> <span class="o">=</span> <span class="n">gt_ij</span><span class="p">.</span><span class="n">T</span> <span class="c1"># make independent each value
</span>
            <span class="c1"># anchor index
</span>            <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">].</span><span class="nf">long</span><span class="p">()</span>

            <span class="c1"># add indices
</span>            <span class="c1"># clamp() : 19x19 이상의 값이 되지 않기 위해
</span>            <span class="c1"># always 0 &lt; gt_j &lt; grid_h -1 
</span>            <span class="n">tindices</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gt_j</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">gt_i</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

            <span class="c1"># add target box
</span>            <span class="c1"># prediction_x, prediction_y normalized is box_x - Cx, or box_y - Cy in figure2   
</span>            <span class="c1"># shape : [p_x, p_y, gt_w, gt_h]
</span>            <span class="n">tboxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">gt_xy</span><span class="o">-</span><span class="n">gt_ij</span><span class="p">,</span> <span class="n">gt_wh</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># add anchor
</span>            <span class="c1"># a is index of anchor box to guess positive box, so insert anchor box for indices
</span>            <span class="n">anch</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

            <span class="c1"># add class
</span>            <span class="n">tcls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tcls</span><span class="p">,</span> <span class="n">tboxes</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anch</span>
</pre></table></code></div></div><p>필요한 상수들을 지정해주고, 출력값인 tcls, tboxes, indices, anch를 먼저 할당해둔다.</p><ul><li>gain : cfg 파일에서의 anchor 박스의 크기를 맞게 설정하고, box 좌표들의 정규화를 풀어주기 위한 변수이다.<li>ai : anchor index, 우리는 targets에 anchor id도 추가할 것이므로 arange를 통해 0,1,2 index를 만들고, 동일한 dtype을 맞추고, 연산의 정확성을 위해 float로 생성했으며, 생성한 arange는 (1,3)의 shape을 가지므로 이를 (3,1)으로 변환한다. 그리고 타겟의 수만큼 생성한다. <code class="language-plaintext highlighter-rouge"> num_targets : 9 , ai.shape : torch.Size([3, 9]) tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0.], [1., 1., 1., 1., 1., 1., 1., 1., 1.], [2., 2., 2., 2., 2., 2., 2., 2., 2.]]) </code><li>targets : 각 target마다 anchor가 3개씩 있으므로 개수를 맞게 만들어주기 위해 repeat를 했다. 즉 각 anchor마다의 GT target 값을 가져야 하기 때문에 이를 맞춰주었다. ai는 2차원이므로 같은 차원으로 만들어줘야 concat이 되기에 마지막 차원을 None값으로 채워 같은 차원으로 맞추었다.<li>targets[0].shape : [batch_id, class_id, box_cx, box_cy, box_w, box_h, anchor_id]<ul><li>ai.shape : torch.Size([3, 12])<li>targets before : torch.Size([12, 6])<li>targets after : torch.Size([3, 12, 7])<ul><li>각 targets마다 7가지의 속성을 가지고 있는데, 이것을 anchor 개수만큼 생성했기 때문에 3,12,7이 되었다. 이 때, 12는 객체 개수이다.</ul></ul><li>yi, yl : yololayers index(0,1,2), yololayers’ layer<li>anchor : cfg 파일의 anchor들은 608크기에서의 값들이다. 그러므로 이를 feature map에 맞게 재설정해야 한다. 그래서 Yololayer에서 계산한 anchor들을 stride로 나눈다. stride란 feature map의 1grid가 가지는 픽셀의 값이다. 즉 19x19이면 input_size 608 / feature map size 19로 나눈 값이다.<ul><li>anchors.shape : torch.Size([3, 2])</ul><li>t : 앞서 채워준 gain[2:6]에는 grid_w, grid_h, grid_w, grid_h 가 들어있고, 나머지는 1로 되어 있다. box좌표들의 정규화를 풀어주기 위해 targets와 gain을 곱한다.</ul><p><img data-src="/assets/img/dev/week10/day5/figure2.png" data-proofer-ignore></p><ul><li>r : 위의 그림을 보면 $ box_w = anchor_w * \exp{(t_w)} $ 이다. 따라서 $ r = exp(t_w) = box_w / anchor_w $이 된다. t는 [batch_id, class_id, box_cx, box_cy, box_w, box_h, anchor_id]의 형태를 가지고 있으므로, 4,5번째 index값인 box_w, box_h만을 사용하여 $ exp{(t_w)} $ 를 계산한다. 연산을 위해 동일한 차원으로 만들어줘야 해서 anchors[:, None]을 통해 3차원으로 만든다. 이 때, t_w는 predict_w, 즉 예측한 박스의 w를 의미한다.<li>j : w,h 중에서 r과 1/r 중 큰 값을 저장하고, w와 h와 비교해서 큰 값을 추출하고, 너무 큰 값들은 제거한다. 그렇게 되면 True, False의 bool로 이루어진 list가 되서 True인 것들에 대한 것들만 추출한다.<li>이렇게 추출된 t는 적절한 anchor 사이즈를 갖는 데이터들로만 필터링하게 된다.<li>batch, cls : t는 7dim을 가지는 변수이고, 그 중 0 index는 batch, 1 index는 class이므로 [:, :2] 로 작성한다. 그 값들을 int값으로 변환하기 위해 long을 붙이고, 열별로 되어 있던 데이터를 1열로 만들기 위해 transpose했다.<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>  t[:,:2] : 
   tensor([[0., 0.],
      [0., 0.],
      [1., 0.],
      [1., 0.],
      [1., 0.],
      [0., 0.],
      [0., 0.],
      [1., 0.],
      [1., 0.],
      [0., 0.],
      [0., 0.],
      [1., 0.],
      [1., 0.]])
  batch, class : torch.Size([13]), torch.Size([13]) 
</pre></table></code></div></div><li>indices : [batch index, anchor index, Cy, Cx], Cy,Cx는 위의 그림에서 Cy,Cx를 의미하는데, 이는 몇번째 grid인지에 대한 상수이다. 만약 gt_xy가 17.2, 17.3를 가진다면 17x17의 index를 가지게 되고, Cx,Cy = 17이 된다. 이 때, clamp 메서드를 사용했는데, 이는 값의 범위를 지정해서 그 이하 또는 이상의 값이 되지 않도록 필터링해준다.<li>tboxes : 필터링해서 유의미한 타겟에 대한 박스만을 넣어준다. 이 때, gt_xy - gt_ij를 하는 이유는 위의 그림에서 볼 수 있듯이 tx,ty는 feature map의 절대 위치가 아닌 한 그리드 안에서의 위치 좌표를 나타낸다. 따라서 gt_ij가 Cx,Cy를 나타내므로 이를 빼주는 방식으로 0~1 값을 가질 수 있게 된다.<li>anch : 유의미한 타겟에 대한 박스라고 생각한 값들에 사용한 anchor값들을 anch에 삽입<li>tcls : 위에서 이미 positive라고 생각한 타겟에 대한 리스트로 t를 필터링했으므로 이에 대한 cls들만 집어넣어주면 된다.</ul><p><br /></p><p><strong>get_targets를 통해 한 yololayer당 num_targets의 개수만큼의, 즉 1개의 객체당 1개의 anchor박스만을 가지게 만들었다.</strong></p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="c1"># loss_class, loss_box, loss_objectness
</span>        <span class="n">lcls</span><span class="p">,</span> <span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> 

        <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">tanchors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_targets</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">pout</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
            <span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">tindices</span><span class="p">[</span><span class="n">pidx</span><span class="p">]</span>
            <span class="c1"># objectness information
</span>            <span class="n">tobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">pout</span><span class="p">[...,</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">num_targets</span> <span class="o">=</span> <span class="n">batch_id</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of object in the batch size
</span>
            <span class="k">if</span> <span class="n">num_targets</span><span class="p">:</span>
                <span class="c1"># pout shape : [batch, anchor, grid_h, grid_w, box_attrib]
</span>                <span class="c1"># get the only box_attrib information in grid, so then we can know batch index, anchor index
</span>                <span class="n">ba</span> <span class="o">=</span> <span class="n">pout</span><span class="p">[</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span>
                <span class="n">pred_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> 
                <span class="n">pred_wh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">tanchors</span><span class="p">[</span><span class="n">pidx</span><span class="p">]</span>
                <span class="n">pred_box</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">pred_xy</span><span class="p">,</span> <span class="n">pred_wh</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># pred_x,pred_y,pred_w,pred_h
</span>
                <span class="c1"># iou
</span>                <span class="n">iou</span> <span class="o">=</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">pred_box</span><span class="p">,</span> <span class="n">tbox</span><span class="p">[</span><span class="n">pidx</span><span class="p">],</span> <span class="n">xyxy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># can get iou about each box 
</span>
                <span class="c1"># box loss
</span>                <span class="c1">## MSE(Mean Squared loss)
</span>                <span class="c1"># mse_loss_wh = self.mseloss(pred_box[...,2:4], tbox[pidx][...,2:4]])
</span>                <span class="c1"># mse_loss_xy = self.mseloss(pred_box[...,0:2], tbox[pidx][...,0:2]])
</span>                <span class="c1"># print("MSE loss_xy : {}, loss_wh : {}".format(mse_loss_wh, mse_loss_xy)) 
</span>
                <span class="n">lbox</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">iou</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span> <span class="c1"># iou의 평균값들, 3 layer가 다 더해지도록
</span>

                <span class="c1"># class loss
</span>                <span class="k">if</span> <span class="n">ba</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># xywh, obj_info, cls_info
</span>                    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">5</span><span class="p">:],</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="c1"># one hot encoding for the corresponding class
</span>                    <span class="c1"># if the information is for the 0th class, insert 1 into 0 index
</span>                    <span class="n">t</span><span class="p">[</span><span class="nb">range</span><span class="p">[</span><span class="n">num_targets</span><span class="p">],</span> <span class="n">tcls</span><span class="p">[</span><span class="n">pidx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> 

                    <span class="c1"># compute probability(ba[:,5:]) about class and list for 0 of non correct or 1 of correct (t) and sum
</span>                    <span class="n">lcls</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bcelogloss</span><span class="p">(</span><span class="n">ba</span><span class="p">[:,</span><span class="mi">5</span><span class="p">:],</span><span class="n">t</span><span class="p">)</span>


                <span class="c1"># objectness loss
</span>                <span class="c1"># gt box and prediction box are coincide -&gt; positive = 1, negative = 0
</span>                <span class="c1"># instead of dividing into 0 or 1, insert as a value between 0 and 1 
</span>                <span class="n">tobj</span><span class="p">[</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">iou</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">type</span><span class="p">(</span><span class="n">tobj</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>


            <span class="c1"># we can get also objectness loss, even if num_target is 0
</span>            <span class="n">lobj</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bcelogloss</span><span class="p">(</span><span class="n">pout</span><span class="p">[...,</span><span class="mi">4</span><span class="p">],</span> <span class="n">tobj</span><span class="p">)</span>
                
        <span class="c1"># assign loss weight, to set balence for each loss
</span>        <span class="n">lcls</span> <span class="o">*=</span> <span class="mf">0.05</span>
        <span class="n">lobj</span> <span class="o">*=</span> <span class="mf">1.0</span>
        <span class="n">lbox</span> <span class="o">*=</span> <span class="mf">0.5</span>

        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">lcls</span> <span class="o">+</span> <span class="n">lbox</span> <span class="o">+</span> <span class="n">lobj</span>
        
        <span class="c1"># define the loss graph visualization
</span>        <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_loss</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lcls</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lobj</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lbox</span><span class="p">.</span><span class="nf">item</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">loss_list</span>
</pre></table></code></div></div><ul><li>lcls, lbox, lobj : 추후에 loss를 계산하는데 사용될 리스트들을 미리 메모리 할당<li>for문 : 예측한 모든 pred, yolo layer에서의 출력값들을 루프를 돌면서 19x19, 38x38, 76x76 feature map에서의 예측값들에 대해 모든 boxes인 22743개를 다 보는 것이 아닌 방금 구했던 positive라고 판단되는 box들만 본다. tcls, tbox 등에 들어있는 것들은 len() = 3을 가진 각각의 feature map에서의 positive box에 대한 정보가 담겨져 있다.<li>tobj : objectness에 대한 값이므로 마지막 shape을 1로 고정시킨 상태로 생성했다. tobj의 shape을 보면 [2, 3, 19, 19]의 크기를 가진다. 0 대신 <code class="language-plaintext highlighter-rouge">:5</code>를 하면 [2, 3, 19, 19, 5]가 될 것이다.<li>num_targets : batch_id는 num_targets만큼 길이를 가지고 있다. (왜 batch_id가 num_targets 길이를 가지고 있는가)<li>ba : 해당 grid안에 특정 anchor index, batch index를 가진 box의 속성만을 가져온다. shape는 [num_targets, 13]이다. 즉 각 target에 대한 box_attrib를 가져온다. box attribution[13]에는 bbox[4] + objectness score[1] + classes score[8]로 구성되어 있다.<li>pred_xy, pred_wh : figure2에서처럼 box_x, box_y는 sigmoid 처리를 하고, box_w, box_h는 exp처리를 하고, anchor box 크기를 곱해준다. (pred_xy에 Cx, Cy는 왜 안곱해주는거지)</ul><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1"># box_a, box_b IOU
# xyxy is value for whether or not boxes are [minx,miny,maxx,maxy]
# when we divided by 0 eps use to prevent error
</span><span class="k">def</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">xyxy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">):</span>
    <span class="n">box1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">.</span><span class="n">T</span>
    <span class="n">box2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">.</span><span class="n">T</span> 

    <span class="k">if</span> <span class="n">xyxy</span><span class="p">:</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># intersection
</span>    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">b1_x2</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">b1_x1</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">)).</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">b1_y1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">)).</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># union
</span>    <span class="n">b1_w</span><span class="p">,</span> <span class="n">b1_h</span> <span class="o">=</span> <span class="n">b1_x2</span> <span class="o">-</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">-</span> <span class="n">b1_y1</span> <span class="o">*</span> <span class="n">eps</span>
    <span class="n">b2_w</span><span class="p">,</span> <span class="n">b2_h</span> <span class="o">=</span> <span class="n">b2_x2</span> <span class="o">-</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">-</span> <span class="n">b2_y1</span> <span class="o">*</span> <span class="n">eps</span>

    <span class="c1"># get two area and subtract intersection once.
</span>    <span class="n">union</span> <span class="o">=</span> <span class="n">b1_w</span> <span class="o">*</span> <span class="n">b1_h</span> <span class="o">+</span> <span class="n">b2_w</span> <span class="o">*</span> <span class="n">b2_h</span> <span class="o">-</span> <span class="n">inter</span> <span class="o">*</span> <span class="n">eps</span>

    <span class="c1"># IOU
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="n">union</span>

    <span class="k">return</span> <span class="n">iou</span>
</pre></table></code></div></div><p>bbox의 iou를 구하는 함수를 선언했다. 여기서 xyxy는 bbox의 포맷이 [minx, miny, maxx, maxy]인지아닌지에 대한 값이다. 그리고 eps, epsilon은 나눗셈을 할 때, 0으로 나누게 되면 에러가 생기게 되므로 이를 방지하기 위해 만든 매우 작은 상수이다.</p><p>이 때, 전치를 하지 않을 경우에는 [20, 4]의 shape을 가진다. 이 상태로 계산을 하려면 아래의 식들을 수정해줘야 한다. 전치의 의미는 단지 계산의 과정의 차이이다.</p><p>center_x, center_y, w, h 에 대해 box의 min x, min y, max x, max y 를 구하고, 그것들을 통해 교집합을 구한다. 영역의 교집합이므로 특정 상수가 나오는 것이 아닌 공간의 크기가 교집합이 되고, 이를 합집합 영역의 크기와 나누게 되면 iou를 구할 수 있게 된다.</p><p><br /></p><p><br /></p><p>다시 compute_loss로 돌아가서 살펴보도록 하자.</p><ul><li>iou : 두 박스를 통해 IOU를 구한다. pred_box는 한 yololayer당 객체 개수만큼의 box를 가지고 있고, tbox[pidx] 또한 동일한 크기의 shape을 가지고 있다.<li>mseloss : bbox에 대한 loss를 구할 때, MSEloss를 사용하게 되면, 두 박스의 제곱의 차로 구하기 때문에 값이 많이 튈 수 있다. 해당 yololayer index에서의 필터링한 tbox에서의 x,y,w,h 각각과 predicted bbox의 x,y,w,h를 비교한다.<li>lbox : iou는 num_targets와 같은 길이를 가진다. 즉, 각 object 1개마다의 box들의 iou를 구한다. iou의 값들은 항상 0~1사이의 값을 가진다. 그래서 1-iou의 평균으로 loss를 구했다.<li>class loss : ba에는 bbox[4] + objectness score[1] + classes score[8]가 있으므로 예외 처리를 위해, 즉 classes score가 있을 경우에는 classes score에 대한 loss를 구한다. class에 대한 shape에 대해서만 연산할 것이므로 ba[…, 5:]에 대해서만 메모리 공간을 생성했다.<li>t : 해당 target class에 맞는 위치의 index에만 1로 바꾸는 one hot encoding 방식이다. 즉, 총 num_targets의 개수가 있고, 1개의 targets 공간마다 target class에 대한 곳에만 1로 만든다.<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>  tensor([[1., 0., 0., 0., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.],
          [0., 0., 0., 1., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.],
          [1., 0., 0., 0., 0., 0., 0., 0.]])
</pre></table></code></div></div><ul><li>총 8개의 class가 있고, 방금 필터링한 tcls가 있는데, 이 class의 index에만 1을 부여하는 식이다.</ul><li>lcls : 구한 one-hot 벡터와 예측한 각 class에 대한 확률값을 통해 bcelogitloss를 사용해서 lcls를 구한다.<li>lobj : 각 object에 대해 0 또는 1의 값으로 loss를 구할 수 있지만, 조금 더 정확한 연산을 위해 iou 값을 집어넣어준다. 그리고 이것과 pred의 4index, objectness score과 BCE loss를 사용하여 loss를 구한다.<li>loss’s weight : 모든 loss들에 동등한 크기로 계산을 할 수 있지만, 밸런스를 맞게 조정하고, 더 정확한 계산을 위해서는 각 loss에 weight를 부여해야 한다.</ul><p>이렇게 구해진 최종 loss를 리턴하는데, 추후에 loss graph를 그릴 때 사용하기 위해 loss list에 total_loss, lcls, lobj, lbox를 넣어서 리턴한다.</p><p><br /></p><p><br /></p><h2 id="최종-train">최종 train <a href="#최종-train" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># yolov3.py
</span><span class="kn">from</span> <span class="n">tensorboardX</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="p">...</span>
    <span class="n">torchwriter</span> <span class="o">=</span> <span class="nc">SummaryWriter</span><span class="p">(</span><span class="s">"./output/tensorboard"</span><span class="p">)</span>
</pre></table></code></div></div><p>시각화하기 위해 사용하는 함수로 tensorboard를 사용할 것이다. 이를 위해 미리 선언해주고, trainer의 인자로 넣어준다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">loss.loss</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="p">,</span> <span class="n">hyparam</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">torchwriter</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">eval_loader</span> <span class="o">=</span> <span class="n">eval_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_batch</span> <span class="o">=</span> <span class="n">hyparam</span><span class="p">[</span><span class="s">'max_batch'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">yololoss</span> <span class="o">=</span> <span class="nc">Yololoss</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="nc">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'lr'</span><span class="p">],</span> <span class="n">momentum</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'momentum'</span><span class="p">])</span>

        <span class="n">self</span><span class="p">.</span><span class="n">scheduler_multistep</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="nc">MultiStepLR</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">,</span> 
                                                             <span class="n">milestones</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">60</span><span class="p">],</span>
                                                             <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>            <span class="c1"># 학습을 진행할 때마다 lr이 떨어져야 더 정교하게 학습이 가능하다. 떨어지는 빈도를 multisteplr로 설정
</span>        <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span> <span class="o">=</span> <span class="n">torchwriter</span>

    <span class="k">def</span> <span class="nf">run_iter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="c1"># drop the batch when invalid values
</span>            <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">input_img</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"input {} {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">input_img</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targets</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span> <span class="c1"># [batch, C, H, W], [object number, (batchidx, cls_id, box_attirb)]
</span>            <span class="n">input_img</span> <span class="o">=</span> <span class="n">input_img</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># non_blocking
</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">input_img</span><span class="p">)</span>
            <span class="c1"># print(input_img.shape, targets.shape)
</span>            <span class="c1"># print(output[0].shape)
</span>
            <span class="c1"># get loss between output and target(gt)
</span>            <span class="n">loss</span><span class="p">,</span> <span class="n">loss_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">yololoss</span><span class="p">.</span><span class="nf">compute_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">yolo_layers</span><span class="p">)</span>

            <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>       <span class="c1"># gradient가 weight에 반영해서 update
</span>            <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>  
            <span class="n">self</span><span class="p">.</span><span class="n">scheduler_multistep</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span> <span class="c1"># step마다 lr을 줄임
</span>            <span class="n">self</span><span class="p">.</span><span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># [total_loss.item(), lcls.item(), lobj.item(), lbox.item()]
</span>            <span class="n">loss_name</span> <span class="o">=</span> <span class="p">[</span><span class="s">'total_loss'</span><span class="p">,</span> <span class="s">'cls_loss'</span><span class="p">,</span> <span class="s">'obj_loss'</span><span class="p">,</span> <span class="s">'box_loss'</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"epoch {} / iter {} lr {} loss {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">,</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()))</span>
                <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="s">'lr'</span><span class="p">,</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="s">'total_loss'</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">loss_name</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">):</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span><span class="n">lv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>
</pre></table></code></div></div><p>최종적으로 계산한 loss를 역전파를 수행하고, 최적화를 사용하여 weight에 반영하여 업데이트되도록 만든다. 그리고 scheduler를 통해 learning rate를 조정한다. 이를 조정하는 이유는 학습이 진행될수록 learning rate가 작아져야 학습이 더 잘 되기 때문에 이를 조정하기 위해 사용한다.</p><p>graph를 그리기 위해 torchwriter.add_scalar를 사용하여 학습된 값들을 저장한다. 이때, learning rate를 저장하기 위해서는 optimizer에서 특정 코드를 통해 빼내야 한다. 이는 아래에 추가해놓았다. 단순하게 optimizer.param_groups에서 [‘lr’]을 추출하는 것이다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># get learning rate in optimizer 
</span><span class="k">def</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">param_group</span><span class="p">[</span><span class="s">'lr'</span><span class="p">]</span>
</pre></table></code></div></div><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># train
</span>            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_iter</span><span class="p">()</span>

            <span class="c1"># save model 
</span>            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s">"./output"</span><span class="p">,</span><span class="s">"model_epoch"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">+</span><span class="s">".pth"</span><span class="p">)</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">save</span><span class="p">({</span><span class="s">'epoch'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span>
                        <span class="s">'iteration'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">,</span>
                        <span class="s">'model_state_dict'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
                        <span class="s">'optimizer_state_dict'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
                        <span class="s">'loss'</span><span class="p">:</span><span class="n">loss</span><span class="p">},</span> 
                        <span class="n">checkpoint_path</span><span class="p">)</span>
            

            <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">max_batch</span><span class="p">:</span>
                <span class="k">break</span>
</pre></table></code></div></div><p>run_iter는 1epoch안에서 train_loader 크기만큼 학습하는 과정이고, 1 epoch이 다 돌아가면 checkpoint, model parameter들을 저장한다. torch.save에 <code class="language-plaintext highlighter-rouge">model</code>로만 작성하면 model 그대로 저장되지만, 이처럼 딕셔너리로 저장하고 싶은 부분만 저장할 수가 있다.</p><p><br /></p><p><br /></p><h1 id="최종-코드">최종 코드</h1><h2 id="yolov3py">yolov3.py <a href="#yolov3py" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="n">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="kn">import</span> <span class="n">argparse</span>

<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataloader.yolo_data</span> <span class="kn">import</span> <span class="n">Yolodata</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">dataloader.data_transforms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">model.yolov3</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="kn">from</span> <span class="n">train.train</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="kn">from</span> <span class="n">tensorboardX</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>

<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"YOLOV3_PYTORCH arguments"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"--gpus"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">'+'</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s">"List of GPU device id"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"--mode"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s">"train / eval / test"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"--cfg"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"model config path"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"--checkpoint"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"model checkpoint path"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"--download"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"download the dataset"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">parser</span><span class="p">.</span><span class="nf">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="c1"># only use valid data
</span>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">batch</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span> 
    <span class="c1"># skip invalid data
</span>    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span> <span class="c1"># mk 3dim -&gt; 4dim, 0index = batch
</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="c1"># insert 0 index of box of dataloader function, instead of zero 
</span>        <span class="n">boxes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1">#print(boxes.shape)
</span>    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span>




<span class="s">''' train '''</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">using_gpus</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"train"</span><span class="p">)</span>
    
    <span class="n">my_transform</span> <span class="o">=</span> <span class="nf">get_transformations</span><span class="p">(</span><span class="n">cfg_param</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># dataloader
</span>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="nc">Yolodata</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                             <span class="n">transform</span><span class="o">=</span><span class="n">my_transform</span><span class="p">,</span> 
                             <span class="n">cfg_param</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">)</span>
    
    <span class="n">train_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> 
                              <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'batch'</span><span class="p">],</span>
                              <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>          <span class="c1"># num_worker : cpu와 gpu의 데이터 교류를 담당함. 0이면 default로 single process와 같이 진행, 0이상이면 multi thred
</span>                              <span class="n">pin_memory</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>        <span class="c1"># pin_memory : img나 데이터 array를 gpu로 올릴 때 memory의 위치를 고정시킨건지 할당할건지말지에 대한 것
</span>                              <span class="n">drop_last</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="n">shuffle</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate_fn</span><span class="p">)</span>  <span class="c1"># collate_fn : batch size로 getitem할 때 각각의 이미지에 대해서만 가져온다. 그러나 학습을 할 떄는 batch 단위로 만들어줘야 하기 때문에 이를 collate fn으로 진행
</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg_param</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">initialize_weights</span><span class="p">()</span>

    <span class="c1">#device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")
</span>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="s">"cpu"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">torchwriter</span> <span class="o">=</span> <span class="nc">SummaryWriter</span><span class="p">(</span><span class="s">"./output/tensorboard"</span><span class="p">)</span>

    <span class="n">train</span> <span class="o">=</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hyparam</span><span class="o">=</span><span class="n">cfg_param</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span> <span class="n">torchwriter</span> <span class="o">=</span> <span class="n">torchwriter</span><span class="p">)</span>
    <span class="n">train</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>

    







<span class="s">''' eval '''</span>
<span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">using_gpus</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"eval"</span><span class="p">)</span>

<span class="s">''' test '''</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">using_gpus</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"test"</span><span class="p">)</span>


<span class="s">''' main '''</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nf">parse_args</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">download</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">"./install_dataset.sh"</span><span class="p">)</span>

    <span class="c1"># print config file
</span>    <span class="n">net_data</span><span class="p">,</span> <span class="n">conv_data</span> <span class="o">=</span> <span class="nf">parse_hyperparam_config</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">cfg</span><span class="p">)</span>
    
    <span class="n">cfg_param</span> <span class="o">=</span> <span class="nf">get_hyperparam</span><span class="p">(</span><span class="n">net_data</span><span class="p">)</span>


    <span class="n">usingf_gpus</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">gpus</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">"train"</span><span class="p">:</span>
        <span class="nf">train</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="n">cfg_param</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">"eval"</span><span class="p">:</span>
        <span class="nf">eval</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="n">cfg_param</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">"test"</span><span class="p">:</span>
        <span class="nf">test</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="n">cfg_param</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"unknown mode"</span><span class="p">)</span>

    
</pre></table></code></div></div><h2 id="modelsyolov3py">models/yolov3.py <a href="#modelsyolov3py" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">enum</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">make_conv_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_channels</span> <span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'filters'</span><span class="p">])</span> <span class="c1"># output channel size
</span>    <span class="n">size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">])</span> <span class="c1"># kernel size
</span>    <span class="n">stride</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'stride'</span><span class="p">])</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="c1"># layer_info['pad']
</span>    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_conv'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">pad</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'batch_normalize'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_bn'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'leaky'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_act'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">LeakyReLU</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'relu'</span><span class="p">:</span>
        <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_act'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">make_shortcut_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">"_shortcut"</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Identity</span><span class="p">())</span> <span class="c1"># modulelist에서 info 타입이 맞지 않으면 복잡해지므로 빈 공간으로 init
</span>
<span class="k">def</span> <span class="nf">make_route_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">"_route"</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Identity</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">make_upsample_layer</span><span class="p">(</span><span class="n">layer_idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modules</span> <span class="p">:</span> <span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'stride'</span><span class="p">])</span>
    <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_upsample'</span><span class="p">,</span>
                        <span class="n">nn</span><span class="p">.</span><span class="nc">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Yololayer</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">layer_info</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_width</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">in_height</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_train</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yololayer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'classes'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ignore_thresh</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">layer_info</span><span class="p">[</span><span class="s">'ignore_thresh'</span><span class="p">])</span>  <span class="c1"># loss 계산시 해당 박스가 특정 값 이상일 때만 연산에 포함되도록
</span>        <span class="n">self</span><span class="p">.</span><span class="n">box_attr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">+</span> <span class="mi">5</span>                     <span class="c1"># output channel = box[4] + objectness[1] + class_prob[n]
</span>        <span class="n">mask_idxes</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'mask'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span> <span class="c1"># cfg파일에서 mask의 역할은 anchor가 총 9개 선언되어 잇는데, 각각의 yololayer에서 어떤 anchor를 사용할지에 대한 index이다. 0,1,2이면 0,1,2index의 anchor를 사용한다는 뜻
</span>        <span class="n">anchor_all</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer_info</span><span class="p">[</span><span class="s">'anchors'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span> <span class="c1"># w1,h1 , w2,h2 , w3,h3 , ... 로 되어 있으므로 이것을 다시 w,h 를 묶어줘야 한다.
</span>        <span class="n">anchor_all</span> <span class="o">=</span> <span class="p">[(</span><span class="n">anchor_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">anchor_all</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">anchor_all</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="n">anchor_all</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mask_idxes</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="n">in_width</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="n">in_height</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># feature map의 1 grid가 차지하는 픽셀의 값 == n x n
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lw</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="c1"># bounding box를 뽑을 수 있게 sigmoid나 exponantional을 취해줌
</span>        <span class="c1"># x is input. [N C H W]
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># feature map's width, height
</span>        <span class="n">self</span><span class="p">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">anchor</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># 연산을 할 때 동일한 곳에 올라가 있어야함, cpu input이라면 cpu에, gpu input이라면 gpu에
</span>        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="n">torch</span><span class="p">.</span><span class="nf">div</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">in_width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">,</span> <span class="n">rounding_mode</span> <span class="o">=</span> <span class="s">'floor'</span><span class="p">),</span> 
                                    <span class="n">torch</span><span class="p">.</span><span class="nf">div</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">in_height</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span><span class="p">,</span> <span class="n">rounding_mode</span> <span class="o">=</span> <span class="s">'floor'</span><span class="p">)]).</span><span class="nf">to</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># stride = input size / feature map size
</span>        
        <span class="c1"># if kitti data, n_classes = 8, C = (8 + 5) * 3 = 39, yolo layer 이전의 filters 즉 output channels을 보면 다 39인 것을 확인할 수 있다.
</span>        <span class="c1"># [batch, box_attrib * anchor, lh, lw] ex) [1,39,19,19]
</span>        <span class="c1"># 4dim -&gt; 5dim [batch, anchor, lh, lw, box_attrib]
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">anchor</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">box_attr</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lh</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lw</span><span class="p">).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span> <span class="c1"># permute를 통해 dimension 순서를 변경, configuouse를 해야 바뀐채로 진행됨
</span>        <span class="k">return</span> <span class="n">x</span>


<span class="k">class</span> <span class="nc">Darknet53</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">training</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'batch'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_channels'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">'classes'</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span> <span class="o">=</span> <span class="nf">parse_model_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">module_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">yolo_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">module_list</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yololayer</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">training</span> <span class="o">=</span> <span class="n">training</span>

    <span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">layer_info</span><span class="p">):</span> <span class="c1"># init layer setting
</span>        <span class="n">module_list</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">()</span>
        <span class="n">in_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">in_channels</span><span class="p">]</span> <span class="c1"># first channels of input
</span>        <span class="k">for</span> <span class="n">layer_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">layer_info</span><span class="p">):</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="nf">make_conv_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">'filters'</span><span class="p">]))</span> <span class="c1"># store each module's input channels
</span>            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'shortcut'</span><span class="p">:</span>
                <span class="nf">make_shortcut_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>
                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'route'</span><span class="p">:</span>
                <span class="nf">make_route_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>
                <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s">'layers'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">in_channels</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'upsample'</span><span class="p">:</span>
                <span class="nf">make_upsample_layer</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># width, height만 커지므로 channel은 동일
</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'yolo'</span><span class="p">:</span>
                <span class="n">yololayer</span> <span class="o">=</span> <span class="nc">Yololayer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">in_width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">in_height</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">training</span><span class="p">)</span>
                <span class="n">modules</span><span class="p">.</span><span class="nf">add_module</span><span class="p">(</span><span class="s">'layer_'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span><span class="o">+</span><span class="s">'_yolo'</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">)</span>
                <span class="n">in_channels</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">in_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">module_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module_list</span>

    <span class="k">def</span> <span class="nf">initialize_weights</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># track all layers
</span>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="nf">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">kaiming_uniform_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span> <span class="c1"># weight initializing
</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># scale
</span>                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1"># shift
</span>            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">kaiming_uniform_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
    


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">yolo_result</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 최종 output, 마지막 layer가 yolo이므로
</span>        <span class="n">layer_result</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># shortcut, route에서 사용하기 위해 저장
</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">module_cfg</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">module_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'shortcut'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">layer_result</span><span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="s">'from'</span><span class="p">])]</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'yolo'</span><span class="p">:</span>
                <span class="n">yolo_x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">yolo_x</span><span class="p">)</span>
                <span class="n">yolo_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">yolo_x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'upsample'</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'route'</span><span class="p">:</span>
                <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="s">'layers'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">layer_result</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">layer_result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1">#print("idx : {}, result : {}".format(idx, layer_result[-1].shape))
</span>        <span class="k">return</span> <span class="n">yolo_result</span>
</pre></table></code></div></div><h2 id="traintrainpy">train/train.py <a href="#traintrainpy" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">loss.loss</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="p">,</span> <span class="n">hyparam</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">torchwriter</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">eval_loader</span> <span class="o">=</span> <span class="n">eval_loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_batch</span> <span class="o">=</span> <span class="n">hyparam</span><span class="p">[</span><span class="s">'max_batch'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">yololoss</span> <span class="o">=</span> <span class="nc">Yololoss</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="nc">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'lr'</span><span class="p">],</span> <span class="n">momentum</span><span class="o">=</span><span class="n">hyparam</span><span class="p">[</span><span class="s">'momentum'</span><span class="p">])</span>

        <span class="n">self</span><span class="p">.</span><span class="n">scheduler_multistep</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="nc">MultiStepLR</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">,</span> 
                                                             <span class="n">milestones</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">60</span><span class="p">],</span>
                                                             <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>            <span class="c1"># 학습을 진행할 때마다 lr이 떨어져야 더 정교하게 학습이 가능하다. 떨어지는 빈도를 multisteplr로 설정
</span>        <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span> <span class="o">=</span> <span class="n">torchwriter</span>

    <span class="k">def</span> <span class="nf">run_iter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="c1"># drop the batch when invalid values
</span>            <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">input_img</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anno_path</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="c1">#print("input {} {}".format(input_img.shape, targets.shape)) # [batch, C, H, W], [object number, (batchidx, cls_id, box_attirb)]
</span>            <span class="n">input_img</span> <span class="o">=</span> <span class="n">input_img</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># non_blocking
</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">input_img</span><span class="p">)</span>

            <span class="c1"># get loss between output and target(gt)
</span>            <span class="n">loss</span><span class="p">,</span> <span class="n">loss_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">yololoss</span><span class="p">.</span><span class="nf">compute_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">yolo_layers</span><span class="p">)</span>

            <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>       <span class="c1"># gradient가 weight에 반영해서 update
</span>            <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>  
            <span class="n">self</span><span class="p">.</span><span class="n">scheduler_multistep</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span> <span class="c1"># step마다 lr을 줄임
</span>            <span class="n">self</span><span class="p">.</span><span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># [total_loss.item(), lcls.item(), lobj.item(), lbox.item()]
</span>            <span class="n">loss_name</span> <span class="o">=</span> <span class="p">[</span><span class="s">'total_loss'</span><span class="p">,</span> <span class="s">'cls_loss'</span><span class="p">,</span> <span class="s">'obj_loss'</span><span class="p">,</span> <span class="s">'box_loss'</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"epoch {} / iter {} lr {} loss {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">,</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()))</span>
                <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="s">'lr'</span><span class="p">,</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="s">'total_loss'</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">loss_name</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">):</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">torchwriter</span><span class="p">.</span><span class="nf">add_scalar</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span><span class="n">lv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>


    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># train
</span>            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_iter</span><span class="p">()</span>

            <span class="c1"># save model 
</span>            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s">"./output"</span><span class="p">,</span><span class="s">"model_epoch"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">+</span><span class="s">".pth"</span><span class="p">)</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">save</span><span class="p">({</span><span class="s">'epoch'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span>
                        <span class="s">'iteration'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nb">iter</span><span class="p">,</span>
                        <span class="s">'model_state_dict'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
                        <span class="s">'optimizer_state_dict'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span>
                        <span class="s">'loss'</span><span class="p">:</span><span class="n">loss</span><span class="p">},</span> 
                        <span class="n">checkpoint_path</span><span class="p">)</span>
            
            <span class="c1"># evaluation
</span>
            <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">max_batch</span><span class="p">:</span>
                <span class="k">break</span>
</pre></table></code></div></div><h2 id="losslosspy">loss/loss.py <a href="#losslosspy" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">Yololoss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">n_class</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yololoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_class</span> <span class="o">=</span> <span class="n">n_class</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mseloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># mean squared entropy
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bceloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BCELoss</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># binary cross entropy
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bcelogloss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)).</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># take log for BCE
</span>        
    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="n">lcls</span><span class="p">,</span> <span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># loss_class, loss_box, loss_objectness
</span>        
        <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">tanchors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_targets</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pidx</span><span class="p">,</span> <span class="n">pout</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
            <span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">tindices</span><span class="p">[</span><span class="n">pidx</span><span class="p">]</span>
            <span class="c1"># objectness information
</span>            <span class="n">tobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">pout</span><span class="p">[...,</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">num_targets</span> <span class="o">=</span> <span class="n">batch_id</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of object in the batch size
</span>
            <span class="k">if</span> <span class="n">num_targets</span><span class="p">:</span>
                <span class="c1"># pout shape : [batch, anchor, grid_h, grid_w, box_attrib]
</span>                <span class="c1"># get the only box_attrib information in grid, so then we can know batch index, anchor index
</span>                <span class="n">ba</span> <span class="o">=</span> <span class="n">pout</span><span class="p">[</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span>

                <span class="n">pred_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> 
                <span class="n">pred_wh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">tanchors</span><span class="p">[</span><span class="n">pidx</span><span class="p">]</span>
                <span class="n">pred_box</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">pred_xy</span><span class="p">,</span> <span class="n">pred_wh</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># pred_x,pred_y,pred_w,pred_h
</span>                <span class="c1"># print(pred_box.shape, tbox[pidx].shape)
</span>
                <span class="c1"># iou
</span>                <span class="n">iou</span> <span class="o">=</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">pred_box</span><span class="p">,</span> <span class="n">tbox</span><span class="p">[</span><span class="n">pidx</span><span class="p">],</span> <span class="n">xyxy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># can get iou about each box 
</span>
                <span class="c1"># box loss              
</span>                <span class="n">lbox</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">iou</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span> <span class="c1"># iou의 평균값들, 3 layer가 다 더해지도록
</span>
                <span class="c1"># objectness loss
</span>                <span class="c1"># gt box and prediction box are coincide -&gt; positive = 1, negative = 0
</span>                <span class="c1"># instead of dividing into 0 or 1, insert as a value between 0 and 1 
</span>                <span class="n">tobj</span><span class="p">[</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">anchor_id</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">iou</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">type</span><span class="p">(</span><span class="n">tobj</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>


                <span class="c1"># class loss
</span>                <span class="k">if</span> <span class="n">ba</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># xywh, obj_info, cls_info 
</span>                    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">ba</span><span class="p">[...,</span><span class="mi">5</span><span class="p">:],</span> <span class="n">device</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="c1"># one hot encoding for the corresponding class
</span>                    <span class="c1"># if the information is for the 0th class, insert 1 into 0 index
</span>                    <span class="n">t</span><span class="p">[</span><span class="nf">range</span><span class="p">(</span><span class="n">num_targets</span><span class="p">),</span> <span class="n">tcls</span><span class="p">[</span><span class="n">pidx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> 
                    <span class="nf">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                    <span class="c1"># compute probability(ba[:,5:]) about class and list for 0 of non correct or 1 of correct (t) and sum
</span>                    <span class="n">lcls</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bcelogloss</span><span class="p">(</span><span class="n">ba</span><span class="p">[:,</span><span class="mi">5</span><span class="p">:],</span><span class="n">t</span><span class="p">)</span>

            <span class="c1"># we can get also objectness loss, even if num_target is 0
</span>            <span class="n">lobj</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bcelogloss</span><span class="p">(</span><span class="n">pout</span><span class="p">[...,</span><span class="mi">4</span><span class="p">],</span> <span class="n">tobj</span><span class="p">)</span>
                
        <span class="c1"># assign loss weight, to set balence for each loss
</span>        <span class="n">lcls</span> <span class="o">*=</span> <span class="mf">0.05</span>
        <span class="n">lobj</span> <span class="o">*=</span> <span class="mf">1.0</span>
        <span class="n">lbox</span> <span class="o">*=</span> <span class="mf">0.5</span>

        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">lcls</span> <span class="o">+</span> <span class="n">lbox</span> <span class="o">+</span> <span class="n">lobj</span>
        
        <span class="c1"># define the loss graph visualization
</span>        <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_loss</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lcls</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lobj</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">lbox</span><span class="p">.</span><span class="nf">item</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">loss_list</span>



    <span class="c1"># for comparing prediction and gt conveniently, we transpose shape
</span>    <span class="k">def</span> <span class="nf">get_targets</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">yololayer</span><span class="p">):</span>
        <span class="n">num_anch</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">num_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># batch size
</span>        <span class="n">tcls</span><span class="p">,</span> <span class="n">tboxes</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">anch</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span> <span class="c1"># output, target_class, target_box, index, anchor
</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># targets is to be 7 dim, [b_id, c_id, cx,cy,w,h,a_id]
</span>
        <span class="c1"># anchor index
</span>        <span class="c1"># ai.shape = (1x3) =&gt; 3x1, and repeat targets's num
</span>        <span class="n">ai</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="p">.</span><span class="n">device</span><span class="p">).</span><span class="nf">float</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">)</span>
        <span class="c1"># to make targets to be anchor's number, targets.shape multiple anchor's num(3)
</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">targets</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">num_anch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ai</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">yi</span><span class="p">,</span> <span class="n">yl</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">yololayer</span><span class="p">):</span>
            <span class="c1"># 각 yolo layer feature map에 맞게 설정
</span>            <span class="c1"># cfg 파일에서의 anchors는 608에 대한 값, 19x19, 38x38에 대한 값으로 만들어줘야 함
</span>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">yl</span><span class="p">.</span><span class="n">anchor</span> <span class="o">/</span> <span class="n">yl</span><span class="p">.</span><span class="n">stride</span> 
 
            <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">yi</span><span class="p">].</span><span class="n">shape</span><span class="p">)[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="c1"># [1,1,grid_w, grid_h, grid_w, grid_h,1]
</span>
            <span class="c1"># multiple [box_cx, box_cy,box_w,box_y] * grid size, to unpack normalize
</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">*</span> <span class="n">gain</span>
            <span class="c1"># print(t) # targets's[2:6] is to be some number dependent on grid size
</span>

            <span class="k">if</span> <span class="n">num_targets</span><span class="p">:</span>
                <span class="c1"># in figure2 of yolov3 paper, w, h of bounding box is anchor size * exp(prediction's w) or exp(prediction's h)
</span>                <span class="c1"># so, r = exp(prediction_w) = box_w / anchor_w
</span>                <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span>

                <span class="c1"># extract maximum exp(prediction_w)
</span>                <span class="c1"># select the ratios less than 4, remove the too large ratios
</span>                <span class="c1"># print(r)
</span>                <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">r</span><span class="p">).</span><span class="nf">max</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span>
                <span class="c1"># print("max : ", torch.max(r, 1. / r).max(dim = 2)[0])
</span>                <span class="c1"># print(j)
</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># extract value for true
</span>            <span class="k">else</span><span class="p">:</span> <span class="c1"># num_targets == 0
</span>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># batch_id, class_id with integer and transpose
</span>            <span class="n">batch</span><span class="p">,</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">].</span><span class="nf">long</span><span class="p">().</span><span class="n">T</span>
            <span class="c1"># print("batch, class", batch.shape, cls.shape, "\n", t[:, :2].shape, t.shape)
</span>
            <span class="n">gt_xy</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">gt_wh</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

            <span class="c1"># define the Cx, Cy in figure2. Cx Cy is index of grid
</span>            <span class="c1"># if in 19x19 gt_xy is 17.2,17.3, Cx Cy about object is 17,17
</span>            <span class="n">gt_ij</span> <span class="o">=</span> <span class="n">gt_xy</span><span class="p">.</span><span class="nf">long</span><span class="p">()</span> <span class="c1"># make integer from float type
</span>            <span class="n">gt_i</span><span class="p">,</span> <span class="n">gt_j</span> <span class="o">=</span> <span class="n">gt_ij</span><span class="p">.</span><span class="n">T</span> <span class="c1"># make 1 row, many col
</span>            <span class="c1"># print(gt_ij.shape, gt_i.shape, gt_j.shape)
</span>
            <span class="c1"># anchor index
</span>            <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">].</span><span class="nf">long</span><span class="p">()</span>

            <span class="c1"># add indices
</span>            <span class="c1"># clamp() : 19x19 이상의 값이 되지 않기 위해
</span>            <span class="c1"># always 0 &lt; gt_j &lt; grid_h -1 
</span>            <span class="n">tindices</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gt_j</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">gt_i</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="c1"># [batch id, anchor id, Cy, Cx]
</span>
            <span class="c1"># add target box
</span>            <span class="c1"># prediction_x, prediction_y normalized by sigmoid is box_x - Cx, or box_y - Cy in figure2   
</span>            <span class="c1"># shape : [p_x, p_y, gt_w, gt_h]
</span>            <span class="n">tboxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">gt_xy</span><span class="o">-</span><span class="n">gt_ij</span><span class="p">,</span> <span class="n">gt_wh</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># add anchor
</span>            <span class="c1"># a is index of anchor box to guess positive box, so insert anchor box for indices
</span>            <span class="n">anch</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

            <span class="c1"># add class
</span>            <span class="n">tcls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tcls</span><span class="p">,</span> <span class="n">tboxes</span><span class="p">,</span> <span class="n">tindices</span><span class="p">,</span> <span class="n">anch</span>
</pre></table></code></div></div><h2 id="dataloaderdata_transformspy">dataloader/data_transforms.py <a href="#dataloaderdata_transformspy" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>

<span class="kn">import</span> <span class="n">imgaug</span> <span class="k">as</span> <span class="n">ia</span>
<span class="kn">from</span> <span class="n">imgaug</span> <span class="kn">import</span> <span class="n">augmenters</span> <span class="k">as</span> <span class="n">iaa</span>
<span class="kn">from</span> <span class="n">imgaug.augmentables.bbs</span> <span class="kn">import</span> <span class="n">BoundingBox</span><span class="p">,</span> <span class="n">BoundingBoxesOnImage</span>

<span class="kn">from</span> <span class="n">util.tools</span> <span class="kn">import</span> <span class="n">xywh2xyxy_np</span>


<span class="k">def</span> <span class="nf">get_transformations</span><span class="p">(</span><span class="n">cfg_param</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">is_train</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
        <span class="n">data_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span><span class="nc">AbsoluteLabels</span><span class="p">(),</span>
                                             <span class="nc">DefaultAug</span><span class="p">(),</span>
                                             <span class="nc">RelativeLabels</span><span class="p">(),</span>
                                             <span class="nc">ResizeImage</span><span class="p">(</span><span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">],</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])),</span>
                                             <span class="nc">ToTensor</span><span class="p">(),</span>
                                            <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span><span class="nc">AbsoluteLabels</span><span class="p">(),</span>
                                             <span class="nc">DefaultAug</span><span class="p">(),</span>
                                             <span class="nc">RelativeLabels</span><span class="p">(),</span>
                                             <span class="nc">ResizeImage</span><span class="p">(</span><span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_width'</span><span class="p">],</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'in_height'</span><span class="p">])),</span>
                                             <span class="nc">ToTensor</span><span class="p">(),</span>
                                            <span class="p">])</span>

    <span class="k">return</span> <span class="n">data_transform</span>


<span class="c1"># absolute bbox, 현재는 이미지 크기에 따른 0~1값을 가지지만, 이것을 절대값으로 가지고 있어야 transform을 해도 정보를 잃지 않는다.
</span><span class="k">class</span> <span class="nc">AbsoluteLabels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> <span class="c1"># yolodata코드에서 transform이 들어갈 때 (img, bbox)가 data로 들어옴
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">w</span> <span class="c1"># cx, w *= w
</span>        <span class="n">label</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">h</span> <span class="c1"># cy, h *= h
</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># relative bbox
</span><span class="k">class</span> <span class="nc">RelativeLabels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">w</span>
        <span class="n">label</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>

<span class="k">class</span> <span class="nc">ResizeImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">):</span> <span class="c1"># interpolation은 보간으로 이미지를 변환할 때 빈공간을 어떻게 처리할지
</span>        <span class="n">self</span><span class="p">.</span><span class="n">new_size</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">new_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">new_size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>
        <span class="c1"># label은 normalize된 값이므로 resize하지 않아도 된다. 나중에 width, height를 곱하면 resize된 label로 만들어질 것이다.
</span>
<span class="k">class</span> <span class="nc">ToTensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># normalize, transpose HWC to CHW
</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nc">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>



<span class="c1"># augmentation template, 앞으로 다른 augmentation을 사용할 때 이 template을 상속받아서 구현할 것이다. 공통적으로 augmentation을 할 때마다 bbox가 augmentation방식에 따라 값이 변해야 하므로
</span><span class="k">class</span> <span class="nc">ImgAug</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">augmentations</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">augmentations</span> <span class="o">=</span> <span class="n">augmentations</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># unpack data
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c1"># convert xywh to minx,miny,maxx,maxy because convenient and the imgAug format
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="nf">xywh2xyxy_np</span><span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span> <span class="c1">#0번째는 cls 정보이므로  
</span>
        <span class="c1"># convert bbox to imgaug format
</span>        <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="nc">BoundingBoxesOnImage</span><span class="p">(</span>
                                <span class="p">[</span><span class="nc">BoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">],</span>
                                <span class="n">shape</span><span class="o">=</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1">#apply augmentation
</span>        <span class="n">img</span><span class="p">,</span> <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">augmentations</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
                                                 <span class="n">bounding_boxes</span><span class="o">=</span><span class="n">bounding_boxes</span><span class="p">)</span>

        <span class="c1"># 예외 처리, 이미지 밖으로 나가는 bounding box를 제거
</span>        <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">bounding_boxes</span><span class="p">.</span><span class="nf">clip_out_of_image</span><span class="p">()</span>

        <span class="c1"># convert bounding boxes to np.array()
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">bounding_boxes</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span> <span class="c1"># memory assignment
</span>        <span class="k">for</span> <span class="n">box_idx</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">bounding_boxes</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">y2</span> <span class="c1"># x1,y1,x2,y2 멤버 변수를 가지고 있음
</span>
            <span class="c1"># return [x, y, w, h], 원래의 포맷은 xywh이므로 다시 변환
</span>            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">label</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box_idx</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">boxes</span>


<span class="k">class</span> <span class="nc">DefaultAug</span><span class="p">(</span><span class="n">ImgAug</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">augmentations</span> <span class="o">=</span> <span class="n">iaa</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">([</span>
                                    <span class="n">iaa</span><span class="p">.</span><span class="nc">Sharpen</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                                    <span class="n">iaa</span><span class="p">.</span><span class="nc">Affine</span><span class="p">(</span><span class="n">rotate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">translate_percent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
                                    <span class="p">])</span>
</pre></table></code></div></div><h2 id="dataloaderyolo_datapy">dataloader/yolo_data.py <a href="#dataloaderyolo_datapy" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="n">torchvision</span>

<span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">Yolodata</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span> <span class="c1"># torch utils data의 dataset을 상속받는다.
</span>
    <span class="c1"># format path
</span>    <span class="n">file_dir</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">anno_dir</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">file_txt</span> <span class="o">=</span> <span class="s">''</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="s">'C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">dkssu</span><span class="se">\\</span><span class="s">dev</span><span class="se">\\</span><span class="s">datasets</span><span class="se">\\</span><span class="s">KITTI</span><span class="se">\\</span><span class="s">'</span>
    <span class="c1"># train dataset path
</span>    <span class="n">train_img</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">JPEGimages</span><span class="se">\\</span><span class="s">'</span>
    <span class="n">train_txt</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">Annotations</span><span class="se">\\</span><span class="s">'</span>
    <span class="c1"># valud dataset path
</span>    <span class="n">valid_img</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">JPEGimages</span><span class="se">\\</span><span class="s">'</span>
    <span class="n">valid_txt</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">Annotations</span><span class="se">\\</span><span class="s">'</span>

    <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Car'</span><span class="p">,</span> <span class="s">'Van'</span><span class="p">,</span> <span class="s">'Truck'</span><span class="p">,</span> <span class="s">'Pedestrian'</span><span class="p">,</span> <span class="s">'Persion_sitting'</span><span class="p">,</span> <span class="s">'Cyclist'</span><span class="p">,</span> <span class="s">'Tram'</span><span class="p">,</span> <span class="s">'Misc'</span><span class="p">]</span> <span class="c1"># doncare는 x
</span>    <span class="n">num_classes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cfg_param</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Yolodata</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_class</span> <span class="o">=</span> <span class="n">cfg_param</span><span class="p">[</span><span class="s">'classes'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_train</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_img</span>
            <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_txt</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">+</span> <span class="s">'train</span><span class="se">\\</span><span class="s">ImageSets</span><span class="se">\\</span><span class="s">train.txt'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">valid_img</span>
            <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">valid_txt</span>
            <span class="n">self</span><span class="p">.</span><span class="n">file_txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">+</span> <span class="s">'valid</span><span class="se">\\</span><span class="s">ImageSets</span><span class="se">\\</span><span class="s">valid.txt'</span>

        <span class="n">img_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'UTF-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">img_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">()]</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".JPG"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".JPG"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".png"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".png"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".PNG"</span><span class="p">):</span>
                <span class="n">img_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">".PNG"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"data length : {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">file_dir</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">Image</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">).</span><span class="nf">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">img_origin_h</span><span class="p">,</span> <span class="n">img_origin_w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># img shape : [H,W,C]
</span>
        <span class="c1"># annotation dir이 있는지 확인, txt파일 읽기
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span><span class="p">):</span>
            <span class="n">txt_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'.png'</span><span class="p">,</span> <span class="s">'.PNG'</span><span class="p">,</span> <span class="s">'.jpg'</span><span class="p">,</span> <span class="s">'.JPG'</span><span class="p">]:</span>
                <span class="n">txt_name</span> <span class="o">=</span> <span class="n">txt_name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">'.txt'</span><span class="p">)</span>
            <span class="n">anno_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">anno_dir</span> <span class="o">+</span> <span class="n">txt_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">anno_path</span><span class="p">):</span>
                <span class="k">return</span>
            
            <span class="n">bbox</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">anno_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># annotation about each image
</span>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
                    <span class="n">gt_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)]</span> <span class="c1"># [class, center_x, center_y, width, height]
</span>
                    <span class="c1"># skip when abnormal data
</span>                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">gt_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">cls</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">gt_data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                
                    <span class="n">bbox</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="n">cls</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

            <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

            <span class="c1"># skip empty target
</span>            <span class="n">empty_target</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1"># even if target does not exist, we have to put bbox data
</span>            <span class="k">if</span> <span class="n">bbox</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">empty_target</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1"># bbox의 형태가 객체가 2개일경우 [[a,b,c,d,e],[a,b,c,d,e]] 이므로 형태를 맞추기 위해 [[]]로 생성
</span>                <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
            
            <span class="c1"># data augmentation
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">bbox</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">))</span>

            <span class="c1"># 해당 배치가 몇번째 배치인지 확인하기 위한 index
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_target</span><span class="p">:</span>
                <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">bbox</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 객체 개수만큼 크기를 생성
</span>                <span class="n">target_data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">batch_idx</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bbox</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># x는 1, y는 객체 개수의 array로 만들어줘서 bbox와 concat
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">anno_path</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># test mode
</span>            <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_data</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="toolspy">tools.py <a href="#toolspy" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># parse model layer configuration
</span><span class="k">def</span> <span class="nf">parse_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">'#'</span><span class="p">)]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">().</span><span class="nf">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="n">module_defs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">type_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">"["</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">'net'</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">module_defs</span><span class="p">.</span><span class="nf">append</span><span class="p">({})</span>
            <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
            <span class="k">if</span> <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'batch_normalize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">"net"</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">module_defs</span>


<span class="c1"># watch parse the yolov3 configuaraion about network
</span><span class="k">def</span> <span class="nf">parse_hyperparam_config</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">'#'</span><span class="p">)]</span> <span class="c1"># #으로 시작하지 않는 줄만 저장
</span>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">().</span><span class="nf">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="c1"># network hyperparameter에 대한 definition
</span>    <span class="n">module_defs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># convolution에 대한 parameter
</span>    <span class="n">conv_defs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># layer devision
</span>        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="s">"["</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">"net"</span><span class="p">:</span> <span class="c1"># net은 network의 hyperparameter
</span>                <span class="n">module_defs</span><span class="p">.</span><span class="nf">append</span><span class="p">({})</span> <span class="c1"># dictionary
</span>                <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">conv_defs</span><span class="p">.</span><span class="nf">append</span><span class="p">({})</span>
                <span class="n">conv_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">'net'</span><span class="p">:</span>
                <span class="n">module_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s">'convolutional'</span><span class="p">:</span>
                <span class="n">conv_defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">module_defs</span><span class="p">,</span> <span class="n">conv_defs</span>

<span class="c1"># get the data to want to be ours.
</span><span class="k">def</span> <span class="nf">get_hyperparam</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'net'</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'batch'</span><span class="p">])</span>
            <span class="n">subdivision</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'subdivisions'</span><span class="p">])</span>
            <span class="n">momentum</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'momentum'</span><span class="p">])</span>
            <span class="n">decay</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'decay'</span><span class="p">])</span>
            <span class="n">saturation</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'saturation'</span><span class="p">])</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'learning_rate'</span><span class="p">])</span>
            <span class="n">burn_in</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'burn_in'</span><span class="p">])</span>
            <span class="n">max_batch</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'max_batches'</span><span class="p">])</span>
            <span class="n">lr_policy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">'policy'</span><span class="p">]</span>
            <span class="n">in_width</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'width'</span><span class="p">])</span>
            <span class="n">in_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'height'</span><span class="p">])</span>
            <span class="n">in_channels</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'channels'</span><span class="p">])</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'class'</span><span class="p">])</span>
            <span class="n">ignore_class</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">'ignore_cls'</span><span class="p">])</span>

            <span class="k">return</span><span class="p">{</span><span class="s">'batch'</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
                   <span class="s">'subdivision'</span><span class="p">:</span> <span class="n">subdivision</span><span class="p">,</span>
                   <span class="s">'momentum'</span><span class="p">:</span> <span class="n">momentum</span><span class="p">,</span>
                   <span class="s">'decay'</span><span class="p">:</span> <span class="n">decay</span><span class="p">,</span>
                   <span class="s">'saturation'</span><span class="p">:</span> <span class="n">saturation</span><span class="p">,</span>
                   <span class="s">'lr'</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
                   <span class="s">'burn_in'</span><span class="p">:</span> <span class="n">burn_in</span><span class="p">,</span>
                   <span class="s">'max_batch'</span><span class="p">:</span> <span class="n">max_batch</span><span class="p">,</span>
                   <span class="s">'lr_policy'</span><span class="p">:</span> <span class="n">lr_policy</span><span class="p">,</span>
                   <span class="s">'in_width'</span><span class="p">:</span> <span class="n">in_width</span><span class="p">,</span>
                   <span class="s">'in_height'</span><span class="p">:</span> <span class="n">in_height</span><span class="p">,</span>
                   <span class="s">'in_channels'</span><span class="p">:</span> <span class="n">in_channels</span><span class="p">,</span>
                   <span class="s">'classes'</span><span class="p">:</span> <span class="n">classes</span><span class="p">,</span>
                   <span class="s">'ignore_class'</span><span class="p">:</span> <span class="n">ignore_class</span><span class="p">}</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>


<span class="k">def</span> <span class="nf">xywh2xyxy_np</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># centerx - w/2 = minx
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># miny
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># maxx
</span>    <span class="n">y</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[...,</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># maxy
</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="c1"># box_a, box_b IOU
# xyxy is value for whether or not boxes are [minx,miny,maxx,maxy], eps use when we divided by zero 0 to prevent error
</span><span class="k">def</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">xyxy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">):</span>
    <span class="n">box1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">.</span><span class="n">T</span>
    <span class="n">box2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">xyxy</span><span class="p">:</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># intersection
</span>    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">b1_x2</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">b1_x1</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">)).</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">b1_y1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">)).</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># union
</span>    <span class="n">b1_w</span><span class="p">,</span> <span class="n">b1_h</span> <span class="o">=</span> <span class="n">b1_x2</span> <span class="o">-</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">-</span> <span class="n">b1_y1</span> <span class="o">*</span> <span class="n">eps</span>
    <span class="n">b2_w</span><span class="p">,</span> <span class="n">b2_h</span> <span class="o">=</span> <span class="n">b2_x2</span> <span class="o">-</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">-</span> <span class="n">b2_y1</span> <span class="o">*</span> <span class="n">eps</span>

    <span class="c1"># get two area and subtract intersection once.
</span>    <span class="n">union</span> <span class="o">=</span> <span class="n">b1_w</span> <span class="o">*</span> <span class="n">b1_h</span> <span class="o">+</span> <span class="n">b2_w</span> <span class="o">*</span> <span class="n">b2_h</span> <span class="o">-</span> <span class="n">inter</span> <span class="o">*</span> <span class="n">eps</span>

    <span class="c1"># IOU
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="n">union</span>

    <span class="k">return</span> <span class="n">iou</span>

<span class="c1"># get learning rate in optimizer 
</span><span class="k">def</span> <span class="nf">get_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">param_group</span><span class="p">[</span><span class="s">'lr'</span><span class="p">]</span>

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/yolo2/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/yolo2.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/classlog/'>Classlog</a>, <a href='/categories/devcourse/'>devcourse</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devcourse/" class="post-tag no-text-decoration" >devcourse</a> <a href="/tags/deeplearning/" class="post-tag no-text-decoration" >deeplearning</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[데브코스] 10주차 - DeepLearning Yolo v3 coding (2) - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/yolo2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[데브코스] 10주차 - DeepLearning Yolo v3 coding (2) - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/yolo2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/yolo2/&amp;text=[데브코스] 10주차 - DeepLearning Yolo v3 coding (2) - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/yolo2/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/numpy/"><div class="card-body"> <em class="timeago small" date="2022-04-11 14:40:00 +0900" >Apr 11, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning Numpy & Matplotlib</h3><div class="text-muted small"><p> Numpy Numpy 설치 및 불러오기 pip install numpy import numpy as np 파이썬의 리스트는 머신러닝에서 가장 많이 사용되는 구조 중 하나일 것이다. 그러나 이 리스트는 연산 속도가 느리다. 그래서 연산을 효과적으로 할 수 있도록 하기 위해 만든 것이 Numpy이다. Numpy 연산 속도 nump...</p></div></div></a></div><div class="card"> <a href="/posts/dplearn/"><div class="card-body"> <em class="timeago small" date="2022-04-12 15:40:00 +0900" >Apr 12, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning AI & machine learning</h3><div class="text-muted small"><p> 기계 학습 어떤 컴퓨터 프로그램이 T라는 작업을 수행할 때, 이 프로그램의 성능이 P라는 척도로 평가했을 때 경험 E를 통해 성능이 개선된다면 이 프로그램은 학습한다고 말할 수 있다. 따라서 최적의 알고리즘을 찾는 행위를 기계 학습이라 할 수 있다. 기계 학습의 중심은 경험, 과업, 성능에 있다. 예전에는 지식 기반의 학습을 했다. 즉, 인간이...</p></div></div></a></div><div class="card"> <a href="/posts/mlmath/"><div class="card-body"> <em class="timeago small" date="2022-04-13 15:40:00 +0900" >Apr 13, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 9주차 - DeepLearning Mathematics for Machine Learning</h3><div class="text-muted small"><p> 기계 학습에서 수학은 손실함수를 정의하고 손실함수의 최저점을 찾아주는 최적화 이론에 사용된다. 제어를 함에 있어서도 수학이 필요하다. 선형대수 데이터는 벡터나 행렬, 텐서 형태로 되어 있는데, 이에 대한 공간을 이해하고, 연산을 하기 위해서는 선형대수가 필요하다. 벡터와 행렬 벡터는 요소의 종료와 크기를 표현한다. [x \in R^n] ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/yolo/" class="btn btn-outline-primary" prompt="Older"><p>[데브코스] 10주차 - DeepLearning Yolo v3 coding (1)</p></a> <a href="/posts/models/" class="btn btn-outline-primary" prompt="Newer"><p>[데브코스] 11주차 - DeepLearning Many CNN models structure</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>