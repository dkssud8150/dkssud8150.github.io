<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[데브코스] 14주차 - ImageProcessing geometrical distance estimation" /><meta name="author" content="JaeHo YooN" /><meta property="og:locale" content="en" /><meta name="description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><meta property="og:description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><link rel="canonical" href="https://dkssud8150.github.io/posts/distestim/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/distestim/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-16T15:20:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[데브코스] 14주차 - ImageProcessing geometrical distance estimation" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo YooN"},"dateModified":"2022-05-16T15:20:00+09:00","datePublished":"2022-05-16T15:20:00+09:00","description":"Do focus on developing ‘your ability’ rather than waste time on making you famous.","headline":"[데브코스] 14주차 - ImageProcessing geometrical distance estimation","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/distestim/"},"url":"https://dkssud8150.github.io/posts/distestim/"}</script><title>[데브코스] 14주차 - ImageProcessing geometrical distance estimation | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[데브코스] 14주차 - ImageProcessing geometrical distance estimation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[데브코스] 14주차 - ImageProcessing geometrical distance estimation</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-05-16 15:20:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Mon, May 16, 2022, 3:20 PM +0900" >May 16, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1169 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p><br /></p><p>거리 추정을 위해 여러 가지 과정을 작성할 것이다. 먼저 거리를 추정하는 방법에는 크게 2가지가 있다.</p><ol><li>homography<li>geometric method using FOV</ol><p>homography의 경우 치명적인 단점이 있다. 지면이 평면이어야만 하는데, 실제 상황에서는 평면일 경우가 거의 드물다. 오르막길, 내리막길은 물론이고, 급출발, 급정거를 할 때도 pitch가 생겨서 평면이 아니게 된다. 그래서 homography를 사용한 방법은 간단하게 설명하고 2번으로 넘어가겠다.</p><h1 id="distance-estimation-using-homography-method">distance estimation using homography method</h1><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
</pre><td class="rouge-code"><pre><span class="s">"""
순서
1. 실측을 통한 obj point , img point 설정
2. intrinsic, distort coefficients 정보 불러오기
3. undistort
4. obj point -&gt; homogeneous 좌표계로 변환
5. solvePnP, drawFrameAxes로 좌표축 확인, 0,0,0 좌표로 그려져야 맞는것
6. findHomography 로 perspective matrix 추출
7. image point -&gt; homogeneous 좌표계로 변환
8. homography와 image point를 내적하면 x,y,z 가 추출됨.
"""</span>

<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">visualize</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">testing</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">estimation_distance</span><span class="p">():</span>
    <span class="c1">######## step 2. intrinsic, distort coefficients information
</span>    <span class="n">calibration_jsonfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s">"./calibration.json"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">calibration_jsonfile_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">calibration_file</span><span class="p">:</span>
        <span class="n">calibration_info</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">calibration_file</span><span class="p">)</span>
        <span class="n">intrinsic</span> <span class="o">=</span> <span class="n">calibration_info</span><span class="p">[</span><span class="s">'intrinsic'</span><span class="p">]</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">intrinsic</span><span class="p">[</span><span class="s">'fx'</span><span class="p">],</span> <span class="n">intrinsic</span><span class="p">[</span><span class="s">'fy'</span><span class="p">],</span> <span class="n">intrinsic</span><span class="p">[</span><span class="s">'cx'</span><span class="p">],</span> <span class="n">intrinsic</span><span class="p">[</span><span class="s">'cy'</span><span class="p">]</span>
        <span class="n">camera_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
                                <span class="p">[</span><span class="n">fx</span><span class="p">,</span>      <span class="mf">0.00000</span><span class="p">,</span>      <span class="n">cx</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.00000</span><span class="p">,</span>      <span class="n">fy</span><span class="p">,</span>      <span class="n">cy</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.00000</span><span class="p">,</span> <span class="mf">0.00000</span><span class="p">,</span> <span class="mf">1.00000</span><span class="p">],</span>
                                <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">dist_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">intrinsic</span><span class="p">[</span><span class="s">'distortion_coff'</span><span class="p">]],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">img_file_path</span> <span class="o">=</span> <span class="s">"./source/images/img_1.jpg"</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_file_path</span><span class="p">)</span>


    

    <span class="c1">######## step 3. undistort
</span>    <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">initUndistortRectifyMap</span><span class="p">(</span><span class="n">camera_matrix</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">undistort_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">remap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>

    <span class="s">"""
    높이 16.5cm, 가로 25cm, 세로 30cm
    """</span>

    <span class="n">img_points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
                        <span class="p">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">426</span><span class="p">],</span> <span class="c1"># bottom left
</span>                        <span class="p">[</span><span class="mi">459</span><span class="p">,</span> <span class="mi">426</span><span class="p">],</span> <span class="c1"># bottom right
</span>                        <span class="p">[</span><span class="mi">193</span><span class="p">,</span> <span class="mi">409</span><span class="p">],</span> <span class="c1"># second left
</span>                        <span class="p">[</span><span class="mi">433</span><span class="p">,</span> <span class="mi">409</span><span class="p">],</span> <span class="c1"># second right
</span>                        <span class="p">[</span><span class="mi">206</span><span class="p">,</span> <span class="mi">380</span><span class="p">],</span> <span class="c1"># third left
</span>                        <span class="p">[</span><span class="mi">416</span><span class="p">,</span> <span class="mi">380</span><span class="p">],</span> <span class="c1"># third right
</span>                        <span class="p">[</span><span class="mi">216</span><span class="p">,</span> <span class="mi">366</span><span class="p">],</span> <span class="c1"># top left
</span>                        <span class="p">[</span><span class="mi">403</span><span class="p">,</span> <span class="mi">366</span><span class="p">],</span> <span class="c1"># top right
</span>                        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>


    <span class="n">obj_points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">],</span> <span class="c1"># bottom left
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">],</span> <span class="c1"># bottom right
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="c1"># second left
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="c1"># second right
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],</span> <span class="c1"># third left
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],</span> <span class="c1"># third right
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">00.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],</span> <span class="c1"># top left
</span>                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],</span> <span class="c1"># top right
</span>                        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">data_size</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">img_points</span><span class="p">)</span>

    <span class="n">obj_points</span> <span class="o">=</span> <span class="n">obj_points</span> <span class="o">/</span> <span class="n">obj_points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">homo_obj_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">hconcat</span><span class="p">([</span><span class="n">obj_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">obj_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">obj_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">homo_obj_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">homo_obj_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="c1"># PLT SHOW for search pixel value
</span>        <span class="c1"># both_img = cv2.hconcat([undistort_img, img])
</span>        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">undistort_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">plt_img</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

        <span class="c1">######## get rotation , translation vector using obj points and img points
</span>        <span class="n">_</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">solvePnP</span><span class="p">(</span><span class="n">obj_points</span><span class="p">,</span> <span class="n">img_points</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">distCoeffs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">useExtrinsicGuess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">SOLVEPNP_EPNP</span><span class="p">)</span>
        <span class="n">undistort_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">drawFrameAxes</span><span class="p">(</span><span class="n">undistort_img</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">distCoeffs</span><span class="o">=</span><span class="n">dist_coeff</span><span class="p">,</span> <span class="n">rvec</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="o">=</span><span class="n">tvec</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1">######## image points, object points 의 pair 쌍이 맞는지 재투영을 통해 확인
</span>        <span class="n">proj_image_points</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">projectPoints</span><span class="p">(</span><span class="n">obj_points</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">proj_image_point</span><span class="p">,</span> <span class="n">img_point</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">proj_image_points</span><span class="p">,</span> <span class="n">img_points</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">img_point</span><span class="p">,</span> <span class="n">proj_image_point</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

        <span class="c1">######## 카메라 축 확인
</span>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">undistort_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

    <span class="n">homography</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findHomography</span><span class="p">(</span><span class="n">img_points</span><span class="p">,</span> <span class="n">homo_obj_points</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"data_size </span><span class="si">{</span><span class="n">data_size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">homography</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="c1"># get homography
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="s">"img_1.jpg"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_ANYCOLOR</span><span class="p">)</span>


    <span class="c1">### bbox example
</span>    <span class="n">top_left</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span> <span class="c1">#(416,248)
</span>    <span class="n">top_right</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">168</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span> <span class="c1">#(426,248)
</span>    <span class="n">bottom_left</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">247</span><span class="p">)</span> <span class="c1">#(417,258)
</span>    <span class="n">bottom_right</span> <span class="o">=</span> <span class="p">(</span><span class="mi">168</span><span class="p">,</span><span class="mi">247</span><span class="p">)</span> <span class="c1">#(427,258)
</span>
    <span class="n">center_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_right</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bottom_left</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bottom_left</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">homography</span> <span class="o">=</span> <span class="nf">estimation_distance</span><span class="p">()</span>
    <span class="n">img_point</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">center_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">center_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1">######## inference
</span>    <span class="n">estimation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">homography</span><span class="p">,</span> <span class="n">img_point</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">estimation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span><span class="n">estimation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">estimation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

    <span class="c1">######## visualize
</span>    <span class="n">cv2</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">top_left</span><span class="p">),</span> <span class="p">(</span><span class="n">bottom_right</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s">"distance : "</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s">"cm"</span><span class="p">,</span> <span class="n">top_left</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="s">"img"</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"homography matrix </span><span class="se">\n</span><span class="si">{</span><span class="n">homography</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"distance </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">cm"</span><span class="p">)</span>    

</pre></table></code></div></div><ul><li>순서<ol><li>좌표축 원점으로 정할 객체를 기준으로 실측을 통한 obj point , img point 설정<li>intrinsic, distortion coefficients 정보 불러오기<li>undistort<li>obj point -&gt; homogeneous 좌표계로 변환<li>solvePnP, drawFrameAxes로 좌표축 확인, 0,0,0 좌표로 그려져야 맞는것<li>findHomography 로 perspective matrix 추출<li>image point -&gt; homogeneous 좌표계로 변환<li>homography와 image point를 내적하면 x,y,z 가 추출됨.</ol></ul><p><br /></p><p>이렇게하면 실제 객체와의 거리를 구할 수 있다. 이 때 주의해야 할 점은 homography랑 내적을 하면 x,y,z에서 z가 1이어야 하지만, 1이 아니다. 따라서 z를 나눠주어야 한다.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>homography matrix 
[[-7.97942714e-02 -4.84927735e-02  3.48389453e+01]
 [ 3.63617110e-07 -2.79608421e-01  1.20439194e+02]
 [-5.94557243e-07 -4.39631252e-03  1.00000000e+00]]

distance 127.46cm
</pre></table></code></div></div><p><img data-src="/assets/img/dev/week14/homography.png" data-proofer-ignore></p><p><br /></p><p>homography matrix라는 것 자체가 2차원에서 3차원으로 투영하기 위한 행렬이다. 그래서 image points에서 object points로 가기 위한 3x3 행렬이고, object points를 잡을 때 후륜축을 잡을지 카메라 위치를 잡을지에 따라 중심 좌표와 객체와의 거리를 추정할 수 있다. homography를 하면 카메라의 높이를 고려하지 않아도 되지만 지면 자체가 평면이라고 생각하고 사용하는 알고리즘이므로 지면이 평면이 아니라면 사용할 수 없다고 한다.</p><p><br /></p></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/distestim/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/distestim.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/classlog/'>Classlog</a>, <a href='/categories/devcourse/'>devcourse</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devcourse/" class="post-tag no-text-decoration" >devcourse</a> <a href="/tags/imageprocessing/" class="post-tag no-text-decoration" >ImageProcessing</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[데브코스] 14주차 - ImageProcessing geometrical distance estimation - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/distestim/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[데브코스] 14주차 - ImageProcessing geometrical distance estimation - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/distestim/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/distestim/&amp;text=[데브코스] 14주차 - ImageProcessing geometrical distance estimation - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/distestim/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/start/"><div class="card-body"> <em class="timeago small" date="2022-02-14 13:00:00 +0900" >Feb 14, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 카테고리 설명 및 개요</h3><div class="text-muted small"><p> 데브코스라는 교육을 받으면서 배웠던 내용을 기재하고자 한다. 최대한 많은 내용을 담고 싶지만, 저작권으로 인해 적지 못하는 부분도 많을 것 같다. 원래는 노션에 기록하고 있었지만, 매번 블로그에 기재하던 것처럼 블로그에 업로드해야 계속 기록에 남기도 하고 다음 번에도 계속 볼 것 같다.</p></div></div></a></div><div class="card"> <a href="/posts/algorithm/"><div class="card-body"> <em class="timeago small" date="2022-02-15 13:00:00 +0900" >Feb 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 1주차 - 알고리즘 문제 풀기 (1)</h3><div class="text-muted small"><p> 코드에 대한 주석들은 추후에 달도록 하겠습니다. 현재는 블로그 정리만 하려고 올리는 것입니다. 자료구조와 알고리즘 자료구조 문자열 (str) “this is a string” 리스트 (list) [4,9,2,7] 사전 (dict) {‘a’:2, ‘bc’,:6} 순서쌍 (tuple), 집합 (set), … 해결할 문제에...</p></div></div></a></div><div class="card"> <a href="/posts/algorithm2/"><div class="card-body"> <em class="timeago small" date="2022-02-17 13:00:00 +0900" >Feb 17, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 1주차 - 알고리즘 문제 풀기 (2)</h3><div class="text-muted small"><p> 스택 (stack) 스택: 자료를 보관할 수 있는 선형 구조 x.isempty() : 스택이 비어있는지 판단한다. x.peek() : 스택에 가장 나중에 저장된 데이터 원소를 참조한다. x.size() x.push() x.pop() 단, 넣을 때는 한 쪽 끝에서 밀어 넣어야 하는 push 연산, 꺼낼 때는 같은 쪽에서 뽑아 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/distanceestim/" class="btn btn-outline-primary" prompt="Older"><p>[데브코스] 14주차 - DeepLearning Geometrical Distance Estimation</p></a> <a href="/posts/pingpong/" class="btn btn-outline-primary" prompt="Newer"><p>[detection] DeepLearning Ping-Pong Ball Detection</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>