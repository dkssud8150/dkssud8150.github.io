<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[lane detection] sliding window를 c++로 구현하기" /><meta name="author" content="JaeHo-YooN" /><meta property="og:locale" content="en" /><meta name="description" content="github : https://github.com/dkssud8150/LaneDetectpjt" /><meta property="og:description" content="github : https://github.com/dkssud8150/LaneDetectpjt" /><link rel="canonical" href="https://dkssud8150.github.io/posts/lanedetect/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/lanedetect/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-17T19:02:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[lane detection] sliding window를 c++로 구현하기" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo-YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo-YooN"},"dateModified":"2022-05-21T17:07:41+09:00","datePublished":"2022-04-17T19:02:00+09:00","description":"github : https://github.com/dkssud8150/LaneDetectpjt","headline":"[lane detection] sliding window를 c++로 구현하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/lanedetect/"},"url":"https://dkssud8150.github.io/posts/lanedetect/"}</script><title>[lane detection] sliding window를 c++로 구현하기 | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[lane detection] sliding window를 c++로 구현하기 </span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 500'%3E%3C/svg%3E" data-src="/assets/img/lanedetect/slidingwindow/slidingwindow.png" class="preview-img bg" alt="Preview Image" width="600" height="500" data-proofer-ignore><h1 data-toc-skip>[lane detection] sliding window를 c++로 구현하기</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo-YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-17 19:02:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 17, 2022, 7:02 PM +0900" >Apr 17, 2022</em> </span> <span> Updated <em class="timeago" date="2022-05-21 17:07:41 +0900 " data-toggle="tooltip" data-placement="bottom" title="Sat, May 21, 2022, 5:07 PM +0900" >May 21, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3999 words"> <em>22 min</em> read</span></div></div></div><div class="post-content"><p>github : <a href="https://github.com/dkssud8150/LaneDetectpjt">https://github.com/dkssud8150/LaneDetectpjt</a></p><p>개발 언어는 c++이고, lane detection 기법 중 sliding window를 구현해보았다.</p><p><br /></p><h1 id="영상-처리">영상 처리</h1><h2 id="이진화">이진화 <a href="#이진화" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li><li>grayscale - 원본인 컬러 이미지에서 Gray 영상으로 변환<li>Gaussian Blur - 노이즈를 처리<li><p>canny edge - 외곽선 추출 - lowwer threshold는 upper threshold의 2~3배가 적당</p><li><li>Gaussian -&gt; HSV image<li>inRange를 통한 이진화 (Threshold) - 이 때, 명도에 대한 V만 사용하여 차선의 색이나 주변 밝기를 지정해줘야 한다. - e.g. cv2.inRange(hsv, (0,0,50), (255,255,255)) or cv2.inRange(hsv, (0,0,150), (255,255,255))<li><p>canny edge</p><li><li>Gaussian -&gt; LAB image<li>inRange를 통한 이진화 (Threshold)<li>Canny edge</ol><p><br /></p><h1 id="이진화-후-처리">이진화 후 처리</h1><ol><li>ROI 영역 설정<ul><li>차선이 존재하는 위치에 지정해야 함, 또 필요없는 부분들을 잘 처리해야 한다.</ul><li>houghlineP로 라인 추출<ul><li>threshold, maxval 등의 파라미터를 잘 설정해야 함<li>기울기의 절대값이 너무 작은 건 다른 물체들에 해당할 확률이 크므로 처리 x</ul><li><p>오른쪽, 왼쪽 분리</p><li>라인들의 대표 직선 찾기<ul><li>선분의 기울기 평균값, 양끝점 좌표의 평균값을 사용하여 대표직선을 찾는다.<li>노이즈를 제거해야 멀리 떨어져 있는 이상한 값도 함께 처리하지 않게 된다.<li>모든 데이터를 반영하여 계산하는 것이 아닌 노이즈 데이터를 찾아 계산에서 제외시켜야 한다.</ul><li>offset을 설정하여 차선 인식하고, 차선의 중간값과 화면의 중앙과 비교하여 핸들링</ol><p>RANSAC 알고리즘을 통해 노이즈를 제거한다.</p><p><br /></p><h1 id="예외-상황-처리">예외 상황 처리</h1><ul><li>카메라 영상에서 차선이 잡히지 않는 경우 영상처리를 위한 작업공간인 스크린 사이즈를 확대시킨다.<ul><li>실제 카메라 영상 크기보다 옆으로 넓어진 가상 스크린을 사용하여 작업<li>e.g. 기존 크기 : 640 x 480, 좌우로 200픽셀씩 확장하여 1040x480</ul><li>한쪽 차선만 보이는 경우(차선이 끊기거나 추출되지 않을 경우)에는 추출한 한쪽 차선을 활용하여 대칭을 맞춰서 예측한다.<li>또는 차선은 연속적인 선이므로 지난번 위치를 재사용<li>새로 찾은 차선의 위치가 너무 많이 차이가 날 경우 갑자기 위치가 크게 바뀔 수 없기 때문에 한계값을 정해 이를 넘어갈 경우 무시하고 지난번 위치를 재사용</ul><p><br /></p><p><br /></p><h1 id="사용한-차선-인식-알고리즘---sliding-window">사용한 차선 인식 알고리즘 - sliding window</h1><p><img data-src="https://www.mdpi.com/sensors/sensors-19-03166/article_deploy/html/images/sensors-19-03166-g012.png" width="50%" data-proofer-ignore></p><p><br /></p><ul><li>알고리즘 순서<ol><li>ROI 설정<li>perspective transform<li>hsv -&gt; split and using only <code class="language-plaintext highlighter-rouge">V</code><li>inverse<li>brightness processing<li>gaussian<li>inRange<li>histogram -&gt; argmax abount left and right -&gt; sliding</ol></ul><p><br /></p><p><br /></p><h1 id="차선인식-알고리즘-종류">차선인식 알고리즘 종류</h1><h2 id="hough-transform--ransac">Hough transform + <strong>RANSAC</strong> <a href="#hough-transform--ransac" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://ars.els-cdn.com/content/image/1-s2.0-S0045790620305085-gr1.jpg" width="50%" data-proofer-ignore> <img data-src="https://user-images.githubusercontent.com/33013780/162755205-554cf4b9-cc64-40a8-b084-8854fbfb184b.png" width="40%" data-proofer-ignore></p><p><br /></p><p><br /></p><hr /><h2 id="deep-learnging--ransac"><a href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMCl79-Jxmus3idtZDypeyTOc4ss5H96VjsQ&amp;usqp=CAU">Deep learnging</a> + RANSAC <a href="#deep-learnging--ransac" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMCl79-Jxmus3idtZDypeyTOc4ss5H96VjsQ&amp;usqp=CAU" data-proofer-ignore></p><ul><li><a href="https://www.google.com/url?sa=i&amp;url=https%3A%2F%2Fpaperswithcode.com%2Fpaper%2Ftowards-end-to-end-lane-detection-an-instance&amp;psig=AOvVaw3dgcm4vjtKvEwXFY-1ojXB&amp;ust=1649769511140000&amp;source=images&amp;cd=vfe&amp;ved=0CAsQjhxqFwoTCJjaxPGRjPcCFQAAAAAdAAAAABAy">instance segmentation</a></ul><p><br /></p><p><br /></p><hr /><h2 id="v-roi"><a href="https://github.com/Yeowoolee/OpenCV-Lane-Detection">V-ROI</a> <a href="#v-roi" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://user-images.githubusercontent.com/33013780/162750624-38287654-3b98-4132-a8ed-d54cf0672087.png" width="300px" data-proofer-ignore> <img data-src="https://user-images.githubusercontent.com/33013780/162751237-760413eb-4d25-44b7-8c8e-f6c69a116dac.png" width="300px" data-proofer-ignore></p><ul><li>참고자료 : https://yeowool0217.tistory.com/558?category=803755</ul><p><br /></p><p><br /></p><h1 id="sliding-window-코드">sliding window 코드</h1><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">"opencv2/opencv.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;algorithm &gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">matrix_oper</span><span class="p">(</span><span class="n">Mat</span> <span class="n">frame</span><span class="p">,</span> <span class="n">Mat</span> <span class="n">per_mat_tosrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lx1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ly1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lx2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ly2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry2</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">warp_left_line</span><span class="p">,</span> <span class="n">warp_right_line</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">new_lx1</span><span class="p">,</span> <span class="n">new_ly1</span><span class="p">,</span> <span class="n">new_lx2</span><span class="p">,</span> <span class="n">new_ly2</span><span class="p">;</span>
	<span class="n">new_lx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_ly1</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_lx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_ly2</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">lx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ly2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="kt">int</span> <span class="n">new_rx1</span><span class="p">,</span> <span class="n">new_ry1</span><span class="p">,</span> <span class="n">new_rx2</span><span class="p">,</span> <span class="n">new_ry2</span><span class="p">;</span>
	<span class="n">new_rx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_ry1</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry1</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_rx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">new_ry2</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ry2</span> <span class="o">+</span> <span class="n">per_mat_tosrc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">warp_left_line</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">new_lx1</span><span class="p">,</span> <span class="n">new_ly1</span><span class="p">));</span> <span class="n">warp_left_line</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">new_lx2</span><span class="p">,</span> <span class="n">new_ly2</span><span class="p">));</span>
	<span class="n">warp_right_line</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">new_rx1</span><span class="p">,</span> <span class="n">new_ry1</span><span class="p">));</span> <span class="n">warp_right_line</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">new_rx2</span><span class="p">,</span> <span class="n">new_ry2</span><span class="p">));</span>


	<span class="n">line</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">new_lx1</span><span class="p">,</span> <span class="n">new_ly1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">new_lx2</span><span class="p">,</span> <span class="n">new_ly2</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">line</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">new_rx1</span><span class="p">,</span> <span class="n">new_ry1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">new_rx2</span><span class="p">,</span> <span class="n">new_ry2</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpos</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">warp_left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">warp_left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">warp_left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">warp_left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">y</span> <span class="o">-</span> <span class="n">warp_left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="n">warp_left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rpos</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">warp_right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">warp_right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">warp_right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">warp_right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">y</span> <span class="o">-</span> <span class="n">warp_right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="n">warp_right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">pos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">lpos</span><span class="p">,</span> <span class="n">rpos</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">warp_left_line</span><span class="p">,</span> <span class="n">warp_right_line</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">n_window_sliding</span><span class="p">(</span><span class="kt">int</span> <span class="n">left_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right_start</span><span class="p">,</span> <span class="n">Mat</span> <span class="n">roi</span><span class="p">,</span> <span class="n">Mat</span> <span class="n">v_thres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">,</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;&amp;</span> <span class="n">lpoints</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;&amp;</span> <span class="n">rpoints</span><span class="p">,</span> <span class="n">Mat</span> <span class="n">per_mat_tosrc</span><span class="p">,</span> <span class="n">Mat</span> <span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// define constant for sliding window</span>
	<span class="kt">int</span> <span class="n">nwindows</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">window_height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">h</span> <span class="o">/</span> <span class="n">nwindows</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">window_width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">w</span> <span class="o">/</span> <span class="n">nwindows</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">margin</span> <span class="o">=</span> <span class="n">window_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="c1">// 양쪽이 인식이 되었다면 초기화하고 다시 입력</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">mpoints</span><span class="p">(</span><span class="n">nwindows</span><span class="p">);</span>

	<span class="c1">// init value setting</span>
	<span class="kt">int</span> <span class="n">lane_mid</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">win_y_high</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">window_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_y_low</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">win_x_leftb_right</span> <span class="o">=</span> <span class="n">left_start</span> <span class="o">+</span> <span class="n">margin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_x_leftb_left</span> <span class="o">=</span> <span class="n">left_start</span> <span class="o">-</span> <span class="n">margin</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">win_x_rightb_right</span> <span class="o">=</span> <span class="n">right_start</span> <span class="o">+</span> <span class="n">margin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_x_rightb_left</span> <span class="o">=</span> <span class="n">right_start</span> <span class="o">-</span> <span class="n">margin</span><span class="p">;</span>

	<span class="n">lpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">left_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">rpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">right_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">mpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">left_start</span> <span class="o">+</span> <span class="n">right_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="c1">// init box draw</span>
	<span class="n">rectangle</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">win_x_leftb_left</span><span class="p">,</span> <span class="n">win_y_high</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rectangle</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">win_x_rightb_left</span><span class="p">,</span> <span class="n">win_y_high</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>



	<span class="c1">// window search start, i drew the init box at the bottom, so i start from 1 to nwindows</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">window</span> <span class="o">&lt;</span> <span class="n">nwindows</span><span class="p">;</span> <span class="n">window</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">win_y_high</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">window_height</span><span class="p">;</span>
		<span class="n">win_y_low</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">window</span> <span class="o">*</span> <span class="n">window_height</span><span class="p">;</span>

		<span class="n">win_x_leftb_right</span> <span class="o">=</span> <span class="n">left_start</span> <span class="o">+</span> <span class="n">margin</span><span class="p">;</span>
		<span class="n">win_x_leftb_left</span> <span class="o">=</span> <span class="n">left_start</span> <span class="o">-</span> <span class="n">margin</span><span class="p">;</span>

		<span class="n">win_x_rightb_right</span> <span class="o">=</span> <span class="n">right_start</span> <span class="o">+</span> <span class="n">margin</span><span class="p">;</span>
		<span class="n">win_x_rightb_left</span> <span class="o">=</span> <span class="n">right_start</span> <span class="o">-</span> <span class="n">margin</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

		<span class="kt">int</span> <span class="n">pixel_thres</span> <span class="o">=</span> <span class="n">window_width</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kt">int</span> <span class="n">rl</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">960</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// nonzero가 몇개인지 파악하기 위한 벡터에 사용될 인자</span>
		<span class="c1">// window의 위치를 고려해서 벡터에 집어넣으면 불필요한 부분이 많아질 수 있다. 어차피 0의 개수를 구하기 위한 벡터이므로 0부터 window_width+1 개수만큼 생성</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">lhigh_vector</span><span class="p">(</span><span class="n">window_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// nonzero가 몇개 인지 파악할 때 사용할 벡터</span>
		<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">win_x_leftb_left</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">win_x_leftb_right</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">li</span><span class="o">++</span><span class="p">;</span>
			<span class="n">lhigh_vector</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

			<span class="c1">// 차선의 중앙을 계산하기 위해 255 시작점과 255 끝점을 계산</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">ll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ll</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="n">lr</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">lr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lr</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="kt">int</span> <span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">rhigh_vector</span><span class="p">(</span><span class="n">window_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">win_x_rightb_left</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">win_x_rightb_right</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rhigh_vector</span><span class="p">[</span><span class="n">ri</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">rl</span> <span class="o">==</span> <span class="mi">960</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rl</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="n">rr</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">lr</span> <span class="o">!=</span> <span class="mi">960</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rr</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="c1">// window안에서 0이 아닌 픽셀의 개수를 구함</span>
		<span class="kt">int</span> <span class="n">lnonzero</span> <span class="o">=</span> <span class="n">countNonZero</span><span class="p">(</span><span class="n">lhigh_vector</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">rnonzero</span> <span class="o">=</span> <span class="n">countNonZero</span><span class="p">(</span><span class="n">rhigh_vector</span><span class="p">);</span>


		<span class="c1">// 방금 구했던 255 픽셀 시작 지점과 끝 지점의 중앙 값을 다음 window의 중앙으로 잡는다.</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lnonzero</span> <span class="o">&gt;=</span> <span class="n">pixel_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">left_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">+</span> <span class="n">lr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rnonzero</span> <span class="o">&gt;=</span> <span class="n">pixel_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">right_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">rl</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="c1">// 차선 중앙과 탐지한 차선과의 거리 측정</span>
		<span class="kt">int</span> <span class="n">lane_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_start</span> <span class="o">+</span> <span class="n">left_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">left_diff</span> <span class="o">=</span> <span class="n">lane_mid</span> <span class="o">-</span> <span class="n">left_start</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">right_diff</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">lane_mid</span> <span class="o">-</span> <span class="n">right_start</span><span class="p">);</span>

<span class="cp">#if 1
</span>		<span class="c1">// 한쪽 차선의 nonzero가 임계값을 넘지 못할 경우 중간을 기점으로 반대편 차선 위치를 기준으로 대칭</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lnonzero</span> <span class="o">&lt;</span> <span class="n">pixel_thres</span> <span class="o">&amp;&amp;</span> <span class="n">rnonzero</span> <span class="o">&gt;</span> <span class="n">pixel_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lane_mid</span> <span class="o">=</span> <span class="n">right_start</span> <span class="o">-</span> <span class="n">right_diff</span><span class="p">;</span>
			<span class="n">left_start</span> <span class="o">=</span> <span class="n">lane_mid</span> <span class="o">-</span> <span class="n">right_diff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lnonzero</span> <span class="o">&gt;</span> <span class="n">pixel_thres</span> <span class="o">&amp;&amp;</span> <span class="n">rnonzero</span> <span class="o">&lt;</span> <span class="n">pixel_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lane_mid</span> <span class="o">=</span> <span class="n">left_start</span> <span class="o">+</span> <span class="n">left_diff</span><span class="p">;</span>
			<span class="n">right_start</span> <span class="o">=</span> <span class="n">lane_mid</span> <span class="o">+</span> <span class="n">left_diff</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else
</span>		<span class="c1">// 지난 프레임에서의 픽셀값을 기억하고 nonzero가 임계값을 넘지 못할 경우 지난 프레임의 해당 윈도우 번호의 값을 불러옴</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lnonzero</span> <span class="o">&lt;</span> <span class="n">pixel_thres</span> <span class="o">&amp;&amp;</span> <span class="n">rnonzero</span> <span class="o">&gt;</span> <span class="n">pixel_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">left_start</span> <span class="o">=</span> <span class="n">lpoints</span><span class="p">[</span><span class="n">window</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
			<span class="n">lane_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_start</span> <span class="o">+</span> <span class="n">left_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lnonzero</span> <span class="o">&gt;</span> <span class="n">pixel_thres</span> <span class="o">&amp;&amp;</span> <span class="n">rnonzero</span> <span class="o">&lt;</span> <span class="n">pixel_thres</span> <span class="o">&amp;&amp;</span> <span class="n">rpoints</span><span class="p">[</span><span class="n">window</span><span class="p">].</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">right_start</span> <span class="o">=</span> <span class="n">rpoints</span><span class="p">[</span><span class="n">window</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
			<span class="n">lane_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_start</span> <span class="o">+</span> <span class="n">left_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#endif
</span>		<span class="c1">// draw window at v_thres</span>
		<span class="n">rectangle</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">win_x_leftb_left</span><span class="p">,</span> <span class="n">win_y_high</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rectangle</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">win_x_rightb_left</span><span class="p">,</span> <span class="n">win_y_high</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>


		<span class="n">mpoints</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">lane_mid</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">lpoints</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">left_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">rpoints</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">right_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">win_y_high</span> <span class="o">+</span> <span class="n">win_y_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">Vec4f</span> <span class="n">left_line</span><span class="p">,</span> <span class="n">right_line</span><span class="p">,</span> <span class="n">mid_line</span><span class="p">;</span>
	<span class="n">fitLine</span><span class="p">(</span><span class="n">lpoints</span><span class="p">,</span> <span class="n">left_line</span><span class="p">,</span> <span class="n">DIST_L2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span> <span class="c1">// 출력의 0,1 번째 인자는 단위벡터, 3,4번째 인자는 선 위의 한 점</span>
	<span class="n">fitLine</span><span class="p">(</span><span class="n">rpoints</span><span class="p">,</span> <span class="n">right_line</span><span class="p">,</span> <span class="n">DIST_L2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
	<span class="n">fitLine</span><span class="p">(</span><span class="n">mpoints</span><span class="p">,</span> <span class="n">mid_line</span><span class="p">,</span> <span class="n">DIST_L2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>

	<span class="c1">// 방향이 항상 아래를 향하도록 만들기 위해 단위 벡터의 방향을 바꿔준다.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mid_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mid_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">lx0</span> <span class="o">=</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ly0</span> <span class="o">=</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// 선 위의 한 점</span>
	<span class="kt">int</span> <span class="n">lx1</span> <span class="o">=</span> <span class="n">lx0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ly1</span> <span class="o">=</span> <span class="n">ly0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">left_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// 단위 벡터 -&gt; 그리고자 하는 길이를 빼주거나 더해줌</span>
	<span class="kt">int</span> <span class="n">lx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lx0</span> <span class="o">-</span> <span class="n">lx1</span><span class="p">,</span> <span class="n">ly2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ly0</span> <span class="o">-</span> <span class="n">ly1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rx0</span> <span class="o">=</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ry0</span> <span class="o">=</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx1</span> <span class="o">=</span> <span class="n">rx0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ry1</span> <span class="o">=</span> <span class="n">ry0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">right_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rx0</span> <span class="o">-</span> <span class="n">rx1</span><span class="p">,</span> <span class="n">ry2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ry0</span> <span class="o">-</span> <span class="n">ry1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">mx0</span> <span class="o">=</span> <span class="n">mid_line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">my0</span> <span class="o">=</span> <span class="n">mid_line</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">mx1</span> <span class="o">=</span> <span class="n">mx0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mid_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">my1</span> <span class="o">=</span> <span class="n">my0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mid_line</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">mx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mx0</span> <span class="o">-</span> <span class="n">mx1</span><span class="p">,</span> <span class="n">my2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">my0</span> <span class="o">-</span> <span class="n">my1</span><span class="p">;</span>

	<span class="n">line</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">lx1</span><span class="p">,</span> <span class="n">ly1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">lx2</span><span class="p">,</span> <span class="n">ly2</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">line</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">rx1</span><span class="p">,</span> <span class="n">ry1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">rx2</span><span class="p">,</span> <span class="n">ry2</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">line</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">mx1</span><span class="p">,</span> <span class="n">my1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">mx2</span><span class="p">,</span> <span class="n">my2</span><span class="p">),</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">warp_left_line</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">warp_right_line</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">warp_left_line</span><span class="p">,</span> <span class="n">warp_right_line</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">matrix_oper</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">per_mat_tosrc</span><span class="p">,</span> <span class="n">lx1</span><span class="p">,</span> <span class="n">ly1</span><span class="p">,</span> <span class="n">lx2</span><span class="p">,</span> <span class="n">ly2</span><span class="p">,</span> <span class="n">rx1</span><span class="p">,</span> <span class="n">ry1</span><span class="p">,</span> <span class="n">rx2</span><span class="p">,</span> <span class="n">ry2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">warp_left_line</span><span class="p">,</span> <span class="n">warp_right_line</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">VideoCapture</span> <span class="n">cap</span><span class="p">(</span><span class="s">"../data/subProject.avi"</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Camera open failed"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="c1">//csv 파일 생성</span>
	<span class="n">ofstream</span> <span class="nf">CSVFILE</span><span class="p">(</span><span class="s">"lane_pos.csv"</span><span class="p">);</span>
	<span class="n">CSVFILE</span> <span class="o">&lt;&lt;</span> <span class="s">"index"</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="s">"frame"</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="s">"lpos"</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="s">"rpos"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="c1">// src image size</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">cvRound</span><span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">cvRound</span><span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">));</span>

	<span class="c1">// warped image size</span>
	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">width</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">height</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>

	<span class="c1">// point about warp transform</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;</span> <span class="n">src_pts</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;</span> <span class="n">dst_pts</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="c1">// 파란색 선 없는 roi</span>
	<span class="n">src_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">395</span><span class="p">);</span> <span class="n">src_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">198</span><span class="p">,</span> <span class="mi">280</span><span class="p">);</span> <span class="n">src_pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="mi">280</span><span class="p">);</span> <span class="n">src_pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">580</span><span class="p">,</span> <span class="mi">395</span><span class="p">);</span>
	<span class="n">dst_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">dst_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">dst_pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">dst_pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point2f</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="c1">// point about polylines</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">pts</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">src_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">src_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">src_pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="n">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">src_pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>


	<span class="n">Mat</span> <span class="n">per_mat_todst</span> <span class="o">=</span> <span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">);</span>
	<span class="n">Mat</span> <span class="n">per_mat_tosrc</span> <span class="o">=</span> <span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">dst_pts</span><span class="p">,</span> <span class="n">src_pts</span><span class="p">);</span>

	<span class="n">Mat</span> <span class="n">frame</span><span class="p">,</span> <span class="n">roi</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">warp_left_line</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">warp_right_line</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">lpoints</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">rpoints</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="n">frame</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>

		<span class="c1">// perspective transform</span>
		<span class="n">Mat</span> <span class="n">roi</span><span class="p">;</span>
		<span class="n">warpPerspective</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">per_mat_todst</span><span class="p">,</span> <span class="n">Size</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">INTER_LINEAR</span><span class="p">);</span>

		<span class="c1">// roi box indicate</span>
		<span class="n">polylines</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

		<span class="c1">// 2-1 hsv -&gt; gaussian -&gt; inRange -&gt; canny</span>
		<span class="n">Mat</span> <span class="n">hsv</span><span class="p">;</span>
		<span class="n">Mat</span> <span class="n">v_thres</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">CV_8UC1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">lane_binary_thres</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span> <span class="c1">// contrast : 155</span>
		<span class="n">cvtColor</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">hsv</span><span class="p">,</span> <span class="n">COLOR_BGR2HSV</span><span class="p">);</span>

		<span class="c1">// split H/S/V</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="n">hsv_planes</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">hsv_planes</span><span class="p">);</span>
		<span class="n">Mat</span> <span class="n">v_plane</span> <span class="o">=</span> <span class="n">hsv_planes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="c1">// inverse</span>
		<span class="n">v_plane</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">v_plane</span><span class="p">;</span>

		<span class="c1">// brightness control</span>
		<span class="kt">int</span> <span class="n">means</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">v_plane</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">v_plane</span> <span class="o">=</span> <span class="n">v_plane</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">means</span><span class="p">);</span>

		<span class="n">GaussianBlur</span><span class="p">(</span><span class="n">v_plane</span><span class="p">,</span> <span class="n">v_plane</span><span class="p">,</span> <span class="n">Size</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">);</span>

		<span class="n">inRange</span><span class="p">(</span><span class="n">v_plane</span><span class="p">,</span> <span class="n">lane_binary_thres</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">v_thres</span><span class="p">);</span>

		<span class="n">imshow</span><span class="p">(</span><span class="s">"v_thres"</span><span class="p">,</span> <span class="n">v_thres</span><span class="p">);</span>

		<span class="c1">// 첫위치 지정</span>
		<span class="kt">int</span> <span class="n">left_l_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left_r_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">right_l_init</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span> <span class="n">right_r_init</span> <span class="o">=</span> <span class="mi">960</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">left_l_init</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">left_l_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
					<span class="n">left_r_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">left_r_init</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">left_r_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">right_l_init</span> <span class="o">==</span> <span class="mi">960</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">right_l_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
					<span class="n">right_r_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v_thres</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">right_r_init</span> <span class="o">!=</span> <span class="mi">960</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">right_r_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="kt">int</span> <span class="n">left_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_l_init</span> <span class="o">+</span> <span class="n">left_r_init</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">right_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_l_init</span> <span class="o">+</span> <span class="n">right_r_init</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>


		<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">warp_left_line</span><span class="p">,</span> <span class="n">warp_right_line</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">n_window_sliding</span><span class="p">(</span><span class="n">left_start</span><span class="p">,</span> <span class="n">right_start</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">v_thres</span><span class="p">,</span>
			<span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lpoints</span><span class="p">,</span> <span class="n">rpoints</span><span class="p">,</span> <span class="n">per_mat_tosrc</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>


		<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
		<span class="n">imshow</span><span class="p">(</span><span class="s">"roi"</span><span class="p">,</span> <span class="n">roi</span><span class="p">);</span>



		<span class="c1">//csv 파일 생성</span>
		<span class="kt">int</span> <span class="n">frame_number</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_number</span> <span class="o">%</span> <span class="mi">30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">lpos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">rpos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>

			<span class="n">CSVFILE</span> <span class="o">&lt;&lt;</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="n">frame_number</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="n">lpos</span> <span class="o">&lt;&lt;</span> <span class="s">","</span> <span class="o">&lt;&lt;</span> <span class="n">rpos</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">27</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
	<span class="n">destroyAllWindows</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p><br /></p><p>다양한 기능을 구현해보기 위해 github를 사용했고, 기능마다의 branch를 생성했다.</p><p><img data-src="/assets/img/lanedetect/slidingwindow/branch.png" data-proofer-ignore></p><p><br /></p><p><br /></p><h1 id="요약">요약</h1><ol><li>슬라이딩 윈도우를 통한 ROI 설정<li>warpPerspective<li>HSV를 통한 이진화<ul><li>V 평면만 사용<li>반전을 통해 더 잘 탐지<li>평균 밝기 유지</ul><li>슬라이딩 윈도우 사용<li>첫 시작점을 잡아줄 때, max_element를 사용하면 동일한 크기의 픽셀 중 가장 앞의 위치를 추출하기에 다른 방법을 사용<ul><li>초기값 설정을 위해 왼쪽은 0, 오른쪽은 ROI 가로 사이즈인 960으로 지정<li>255인 위치 중 위치 지정이 안되어 있다면 해당 인덱스를 지정<li>해당 인덱스가 지정된 후부터 255가 끝날 때까지 끝 점을 지정해줌<li>255로 되어있다가 0이 되면 if문이 종료된다.</ul><li>차선의 인덱스들을 통해 중앙값을 차선의 중앙으로 설정<li>slidiing window 진행<ul><li>window개수는 최대한 줄여서 변화에 잘 적응할 수 있도록 12개 정도로 지정<li>window 가로와 세로는 유동적인 설정을 위해 직접 지정이 아닌 window 개수에 따라 변하도록 설정<li>margin은 중앙값을 기준으로 가로 길이/2이다. 즉, 중앙값을 입력으로 받았기 때문에 좌우 +- margin하여 window 좌측, 우측 좌표를 지정함<li>기존의 sliding window는 윈도우를 만들고 나서 해당 윈도우에서 다음 윈도우의 시작 위치를 찾아주었다. 이렇게 하면 변화에 둔해지는 현상 발생<li>따라서 탐색할 높이인 offset을 먼저 지정해준 후 탐지 하고 나서 그림을 그려준다. 이렇게 하면 변화에 적응을 더 잘 할 뿐더러 코너를 나름 잘 따라감<li>이 때도, 차선을 찾기 위해 오른쪽 차선의 시작점, 끝점을 탐지하여 지정, 왼쪽 차선의 시작점, 끝점을 탐지하고, 해당 offset에서의 nonzero값을 구해서 임계값보다 높으면 탐지한 결과값으로 진행하고, 임계값보다 낮으면 지난 픽셀의 값을 사용하거나, 반대편 차선의 대칭으로 만들어줌<li>이렇게 탐지한 왼쪽, 오른쪽 차선과 그로인해 구해진 중앙 차선을 변수에 저장<li>fitline을 통해 직선을 구한다. 이 때 출력되는 값의 0,1번째 값은 단위 벡터, 2,3번째 값은 선들의 중간 픽셀을 출력해준다.<li>방향을 일정하게 맞추기 위해 무조건 방향벡터에서의 y를 -로 맞춰주었다.<li>이를 통해 선 위의 점을 추출하고, 단위 벡터는 중앙값을 기준으로 방향이 맞춰져 있기 때문에, h로곱하는 것이 아닌 중앙값에서 h/2*단위벡터를 구했다.<li>중앙 픽셀과 끝 픽셀의 차를 통해 맨 아래 점을 찾아서 ROI화면의 맨 위 아래로 직선을 그렸다.<li>출력값을 통해 ROI를 다시 frame 형태로변환하는 행렬을 통해 원본 frame에 점 좌표를 그리거나, 직선을 그리고자 햇지만, 아직 수행하지 못했다.<li>ROI를 파란색 선이 포함되도록 자르면 차가 조금만 움직여도 차선을 탐지하기 어려워지기 때문에 높이를 395에서 잘라서 ROI를 만들었다.<li>아까 그린 좌우 차선의 직선 색을 통해 차선 중앙의 x좌표를 구하고 csv파일로 입력한다.</ul></ol></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/lanedetect/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/lanedetect.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/projects/'>Projects</a>, <a href='/categories/detection/'>detection</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/detection/" class="post-tag no-text-decoration" >detection</a> <a href="/tags/lane-detection/" class="post-tag no-text-decoration" >lane-detection</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[lane detection] sliding window를 c++로 구현하기 - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/lanedetect/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[lane detection] sliding window를 c++로 구현하기 - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/lanedetect/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/lanedetect/&amp;text=[lane detection] sliding window를 c++로 구현하기 - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/lanedetect/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/tstl/"><div class="card-body"> <em class="timeago small" date="2022-05-15 06:02:00 +0900" >May 15, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[lane detection] traffic sign and traffic light detection utilizing yolov3 and hough transform</h3><div class="text-muted small"><p> term : 2022.05.10 ~ 2022.05.13 flow 객체 인식 data labeling labelImg yolov3 training augmentation use pretrained da...</p></div></div></a></div><div class="card"> <a href="/posts/facedetection/"><div class="card-body"> <em class="timeago small" date="2022-02-12 19:02:00 +0900" >Feb 12, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[detection] 얼굴 이미지를 통해 동물상 테스트</h3><div class="text-muted small"><p> 깃허브 주소 Abstract 업로드된 이미지에 대해 어떤 동물을 닮았는지 분류하는 테스트를 만들었다. before upload image prediction result about upload image python을 통해 딥러닝 모델을 구축하고, flask로 서버와 html을 연결했다. directory face └── da...</p></div></div></a></div><div class="card"> <a href="/posts/pingpong/"><div class="card-body"> <em class="timeago small" date="2022-05-16 21:20:00 +0900" >May 16, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[detection] DeepLearning Ping-Pong Ball Detection</h3><div class="text-muted small"><p> 프로젝트 개요 목표 RGB 카메라로부터 입력된 이미지에 존재하는 탁구공을 검출 데이터 수집, 학습 데이터 생성 학습 (+ augmentation) deep learning inference 탁구공의 실제 위치를 추정 camera calibration ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/docker/" class="btn btn-outline-primary" prompt="Older"><p>[데브코스] 9주차 - Docker (chroot, pseudo path)</p></a> <a href="/posts/perception/" class="btn btn-outline-primary" prompt="Newer"><p>[데브코스] 10주차 - DeepLearning Perception</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>