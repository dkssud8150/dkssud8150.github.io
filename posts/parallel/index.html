<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="[데브코스] 7주차 - OpenCV parallel computing" /><meta name="author" content="JaeHo YooN" /><meta property="og:locale" content="en" /><meta name="description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><meta property="og:description" content="Do focus on developing ‘your ability’ rather than waste time on making you famous." /><link rel="canonical" href="https://dkssud8150.github.io/posts/parallel/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/parallel/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-31T14:40:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[데브코스] 7주차 - OpenCV parallel computing" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo YooN"},"dateModified":"2022-05-23T21:25:00+09:00","datePublished":"2022-03-31T14:40:00+09:00","description":"Do focus on developing ‘your ability’ rather than waste time on making you famous.","headline":"[데브코스] 7주차 - OpenCV parallel computing","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/parallel/"},"url":"https://dkssud8150.github.io/posts/parallel/"}</script><title>[데브코스] 7주차 - OpenCV parallel computing | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[데브코스] 7주차 - OpenCV parallel computing </span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3C/svg%3E" data-src="/assets/img/dev/week7/day4/main.png" class="preview-img bg" alt="Preview Image" width="500" height="500" data-proofer-ignore><h1 data-toc-skip>[데브코스] 7주차 - OpenCV parallel computing</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-03-31 14:40:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Thu, Mar 31, 2022, 2:40 PM +0900" >Mar 31, 2022</em> </span> <span> Updated <em class="timeago" date="2022-05-23 21:25:00 +0900 " data-toggle="tooltip" data-placement="bottom" title="Mon, May 23, 2022, 9:25 PM +0900" >May 23, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3115 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p><br /></p><h1 id="parallel-computing">Parallel computing</h1><p>영상의 병렬 처리란 cpu하나로만 처리하는 것이 아니라 코어를 다 이용해서 처리한다는 것이다. 기본적인 코드를 사용하면 첫번째에 있는 코어만 사용하게 된다. 이 처리를 코어를 다 사용한다는 것은 대체로 행 단위로 나누어 각각 처리한 후 병합하여 결과를 도출한다.</p><p><strong>병렬 프로그래밍 기법</strong></p><ul><li><strong>intel TBB(threading building blocks)</strong> - intel<li>HPX(High Performance ParalleX)**<li>OpenMP(Open multi-processing)**<li><strong>APPLE GCD(Grand Central Dispatch)</strong> - apple<li>Windows RT concurrency<li><strong>Windows concurrency</strong> - windows(visual studio에 적용되어 있음)<li><strong>Pthreads</strong> - linux</ul><p><br /></p><p>cmd를 켜서 <code class="language-plaintext highlighter-rouge">opencv_version -v</code>를 쳐보면 리스트가 죽 나올 것이다. 거기서 아래 parallel framework를 보면 concurrency가 되어 있을 것이다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> opencv_version <span class="nt">-v</span>
...
Parallel framework:            Concurrency  
...
</pre></table></code></div></div><p><br /></p><p><br /></p><ul><li><strong>병렬처리용 for루프 코드</strong></ul><p><code class="language-plaintext highlighter-rouge">parallel_for_</code>만 알아도 어떤 프레임워크를 사용하든 알아서 병렬 처리를 해준다.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">parallel_for_</span><span class="p">(</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">,</span> <span class="k">const</span> <span class="n">ParallelLoopBody</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">,</span> <span class="kt">double</span> <span class="n">nstripes</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">parallel_for_</span><span class="p">(</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">functor</span><span class="p">,</span> <span class="kt">double</span> <span class="n">nstripes</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>range : 병렬 처리를 수행할 범위(start~end)<li>body : 함수 객체, ParallelLoopBody 클래스를 상속받은 클래스 또는 C++ 람다 표현식(opencv 3.3 이상부터 가능)</ul><p><br /></p><p>반드시 parallelloopbody를 상속받도록 작성해야 하고, 연산자를 재정의해줘야 한다.</p><ul><li>parallel - 1.1 : 클래스 정의</ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ParallelContrast</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ParallelLoopBody</span>
<span class="p">{</span>
<span class="nl">public:</span>
	<span class="n">ParallelContrast</span><span class="p">(</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">src</span><span class="p">,</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">alpha</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">m_src</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">m_dst</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">m_alpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="c1">// 상속 클래스 정의, 생성자 멤버 변수 초기화</span>
	<span class="p">{</span>
		<span class="c1">//m_dst = Mat::zeros(src.rows, src.cols, src.type());</span>
	<span class="p">}</span>

	<span class="k">virtual</span> <span class="kt">void</span> <span class="k">operator</span> <span class="p">()(</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">)</span> <span class="k">const</span> <span class="c1">// ()연산자 재정의, 이 부분이 실제 연산이 진행되는 부분이다</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">m_src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">m_dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">m_src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pDst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m_alpha</span><span class="p">)</span><span class="o">*</span><span class="n">pSrc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">m_alpha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ParallelContrast</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">ParallelContrast</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
	<span class="p">};</span>

<span class="k">private</span><span class="o">:</span>
	<span class="n">Mat</span><span class="o">&amp;</span> <span class="n">m_src</span><span class="p">;</span>
	<span class="n">Mat</span><span class="o">&amp;</span> <span class="n">m_dst</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">m_alpha</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">Mat</span> <span class="n">src</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">"hongkong.jpg"</span><span class="p">,</span> <span class="n">IMREAD_GRAYSCALE</span><span class="p">);</span>

	<span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">parallel_for_</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">),</span> <span class="n">ParallelContrast</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">alpha</span><span class="p">));</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>여기서 m_dst는 새로 초기화 안해도 된다.</p><p>()연산자의 경우 원래는 y=0,x=0부터로 작성했지만, 이 때는 인자로 넘어온 range에 대해 r=range.start, range.end를 사용해야 한다. 이 range에는 각각 처리해줄 범위가 다 들어있어야 한다. 즉 예를 들어 0~512 까지행을 처리할 것이라면 range(0,64), range(64,128)… 가 들어가는데, 이는 opencv에서 알아서 해준다. range를 사용한다는 것 이외에는 다 이전과 동일하다.</p><p>operator = 연산자 또한, 출력을 위해 반드시 작성해줘야 한다.</p><p>다 정의한 paralleConstrast는 아래에 parallel_for_을 통해 사용된다.</p><p><br /></p><p><br /></p><ul><li>parallel - 2 : 람다 표현식</ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">Mat</span> <span class="n">src</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">"hongkong.jpg"</span><span class="p">,</span> <span class="n">IMREAD_GRAYSCALE</span><span class="p">);</span>

	<span class="n">Mat</span> <span class="n">dst</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span><span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
    <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">f</span><span class="p">;</span>

	<span class="n">parallel_for_</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pDst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">pSrc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>
</pre></table></code></div></div><p>클래스를 정의한 것보다 훨씬 더 간단해졌다.</p><p><br /></p><p><br /></p><ul><li>여러 연산 비교하기</ul><ol><li>일반 연산자(+,-,*) 사용<li>연산자 직접 구현<li>연산자 직접 구현<li>parallelConstrast 클래스 구현<li>람다 표현식 사용</ol><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"opencv2/opencv.hpp"</span><span class="cp">
#include</span> <span class="cpf">"opencv2/core/ocl.hpp"</span><span class="c1"> // 이를 실행해야 ocl코드를 사용할 수 있음</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ParallelContrast</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ParallelLoopBody</span>
<span class="p">{</span>
<span class="nl">public:</span>
	<span class="n">ParallelContrast</span><span class="p">(</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">src</span><span class="p">,</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">alpha</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">m_src</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">m_dst</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">m_alpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">m_dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
	<span class="p">}</span>

	<span class="k">virtual</span> <span class="kt">void</span> <span class="k">operator</span> <span class="p">()(</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">)</span> <span class="k">const</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">m_src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">m_dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">m_src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pDst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m_alpha</span><span class="p">)</span><span class="o">*</span><span class="n">pSrc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">m_alpha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ParallelContrast</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">ParallelContrast</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
	<span class="p">};</span>

<span class="k">private</span><span class="o">:</span>
	<span class="n">Mat</span><span class="o">&amp;</span> <span class="n">m_src</span><span class="p">;</span>
	<span class="n">Mat</span><span class="o">&amp;</span> <span class="n">m_dst</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">m_alpha</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">ocl</span><span class="o">::</span><span class="n">setUseOpenCL</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="c1">// opcnCL을 사용하라는 코드, 밑에서 시간 측정 시 opencv버전마다 다르지만 코드를 실행할 때 openCL을 사용할지에 대한 체크를 하려는 오류가 있기도 해서 미리 정리해줌</span>

	<span class="n">Mat</span> <span class="n">src</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">"hongkong.jpg"</span><span class="p">,</span> <span class="n">IMREAD_GRAYSCALE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Image load failed!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"getNumberOfCPUs(): "</span> <span class="o">&lt;&lt;</span> <span class="n">getNumberOfCPUs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"getNumThreads(): "</span> <span class="o">&lt;&lt;</span> <span class="n">getNumThreads</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Image size: "</span> <span class="o">&lt;&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">namedWindow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">WINDOW_NORMAL</span><span class="p">);</span>
	<span class="n">namedWindow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">WINDOW_NORMAL</span><span class="p">);</span>
	<span class="n">resizeWindow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>
	<span class="n">resizeWindow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>

	<span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">TickMeter</span> <span class="n">tm</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">f</span><span class="p">;</span>

	<span class="c1">// 1. Operator overloading</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">src</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">;</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"1. Operator overloading: "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 2. Pixel access by at() (No parallel)</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">src</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">);</span> <span class="c1">// 2 * src -&gt; 기울기 2로 만듬</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"2. Pixel access by at(): "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 3. Pixel access by ptr() (No parallel)</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
	
	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> 
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
		<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pDst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">pSrc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"3. Pixel access by ptr(): "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 4. cv::parallel_for_ with ParallelLoopBody subclass</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">parallel_for_</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">),</span> <span class="n">ParallelContrast</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">alpha</span><span class="p">));</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"4. With parallel_for_ (ParallelLoopBody):  "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 5. cv::parallel_for_ with lambda expression</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">parallel_for_</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">Range</span><span class="o">&amp;</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pDst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">pSrc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"5. With parallel_for_ (lambda expression): "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-src="/assets\img\dev\week7\day4\parellalresult.png" data-proofer-ignore></p><p>병렬처리를 통해 훨씬 빠른 연산 속도를 확인할 수 있다.</p><p><br /></p><p><br /></p><h1 id="유용한-opencv-활용-기법">유용한 OpenCV 활용 기법</h1><h2 id="메모리-버퍼로부터-mat-객체-생성">메모리 버퍼로부터 Mat 객체 생성 <a href="#메모리-버퍼로부터-mat-객체-생성" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>사용자가 할당한 메모리 버퍼로부터 Mat 객체 생성하기</p><ul><li>외부 함수 또는 외부 라이브러리로부터 생성된 영상 데이터 메모리 버퍼가 있을 경우, 해당 메모리 버퍼를 참조하는 Mat 객체를 생성하여 사용 가능하다.<li>이는 Mat객체 생성후 OpenCV 라이브러리를 사용할 수 있다.</ul><p>VideoCapture은 범용성을 중시하기에 최고의 성능을 내기는 어렵다. 영상 데이터에 대한 Mat객체를 복사하는 것은 최소화해야 속도가 빠르다. 그 대신 포인터 함수로 메모리를 가리키도록만 해주면 복사는 없어지게 된다.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Mat</span> <span class="n">mst</span><span class="p">;</span> <span class="c1">// 복사 -&gt; 비효율적</span>

<span class="n">uchar</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// 메모리의 시작점을 가리키는 포인터</span>
</pre></table></code></div></div><p><br /></p><ul><li>사용자가 할당한 메모리 버퍼를 이용하여 Mat객체 생성</ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Mat</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">step</span><span class="o">=</span><span class="n">AUTO</span><span class="o">-</span><span class="n">STEP</span><span class="p">);</span>
</pre></table></code></div></div><ul><li>rows : 행의 개수<li>cols : 열의 개수<li>type : 행렬 원소의 타입<li>data : 사용자가 할당한 메모리 버퍼 주소<li>step : 한 행이 차지하는 바이트 수 (패딩할 경우 주의해야 함)</ul><p><br /></p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"opencv2/opencv.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Raw 파일 열기, 512x512</span>
	<span class="kt">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"elaine.raw"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"File load error!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// 연속된 메모리 동적 할당 &amp; 파일 읽기</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">area</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">uchar</span><span class="o">*</span> <span class="n">pixels</span> <span class="o">=</span> <span class="k">new</span> <span class="n">uchar</span><span class="p">[</span><span class="n">area</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fread</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uchar</span><span class="p">),</span> <span class="n">area</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="c1">// 이미 존재하는 메모리 버퍼를 참조하는 Mat 객체 생성</span>
	<span class="n">Mat</span> <span class="nf">src</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">CV_8UC1</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

	<span class="c1">// OpenCV Operations</span>
	<span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">bilateralFilter</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="n">waitKey</span><span class="p">();</span>

	<span class="k">delete</span> <span class="p">[]</span> <span class="n">pixels</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이렇게 src를 생성하면 area공간의 메모리를 가리키는 포인터를 받아서 그 area만을 가리키게 된다.</p><p>new연산자를 통한 동적 메모리 할당을 진행하면 반드시 해제해줘야 한다. 내가 직접 생성한 변수를 통해 src를 생성했기 때문에, 직접 생성한 변수만 메모리 할당을 해제해주면 되고, src에 대해서는 자동으로 해제가 된다.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">delete</span> <span class="p">[]</span> <span class="n">pixels</span><span class="p">;</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><p>이 메모리 버퍼 방식은 예전에 했던 data를 참조하는 방식과 동일하다.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="p">};</span>
<span class="n">Mat</span> <span class="nf">mat1</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">CV_32FC1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span> <span class="c1">// 메모리 버퍼를 참조하는 객체 생성</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><h2 id="룩업-테이블lutlookup-table">룩업 테이블(LUT:Lookup Table) <a href="#룩업-테이블lutlookup-table" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>특정 연산에 대해 미리 결과 값을 계산하여 배열 등으로 저장해놓은 것을 말한다. 픽셀 값을 변경하는 경우 256x1 크기의 unsigned char 행렬에 픽셀 값 변환 수식 결과 값을 미리 저장한 후, 실제 모든 픽셀에 대해 실제 연산을 수행하는 대신 행렬(룩업 테이블) 값을 참조하여 결과 영상 픽셀 값을 설정한다.</p><p>파이썬의 dictionary에 저장해놓고 불러오는 것과 비슷한 것으로 특정 값(픽셀 가로 idx)에 대한 결과값을 저장한다.</p><p><br /></p><ul><li><strong>룩업 테이블 연산 함수</strong></ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">LUT</span><span class="p">(</span><span class="n">InputArray</span> <span class="n">src</span><span class="p">,</span> <span class="n">InputArray</span> <span class="n">lut</span><span class="p">,</span> <span class="n">OutputArray</span> <span class="n">dst</span><span class="p">);</span>
</pre></table></code></div></div><ul><li>src : 입력 영상, 8비트<li>lut : n개 원소를 갖는 룩업 테이블, 보통은 1x256(1행 256열)<li>dst : 출력 영상, src와 같은 크기, 같은 채널수, lut와 같은 깊이</ul><p>lut 룩업 테이블로부터 값을 받아와 dst 픽셀 값을 설정하는데, 이때 인덱스 정보는 입력 행렬의 픽셀 값을 사용한다.</p><p><br /></p><ul><li><strong>룩업 테이블을 이용한 명암비 향상 코드</strong></ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="n">vold</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Mat</span> <span class="n">src</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">"hongkong.jpg"</span><span class="p">,</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">);</span>

    <span class="n">Mat</span> <span class="n">lut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">CV_8U</span><span class="p">);</span>
	<span class="n">uchar</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">lut</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">LUT</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p><br /></p><ul><li>결과 비교</ul><ol><li>일반 연산자 사용<li>ptr을 통한 직접 구현<li>LUT 사용</ol><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"opencv2/opencv.hpp"</span><span class="cp">
#include</span> <span class="cpf">"opencv2/core/ocl.hpp"</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ocl</span><span class="o">::</span><span class="n">setUseOpenCL</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span> <span class="c1">// 진행 코드에서 OpenCL확인 코드로 인해 혹시 모를 불필요를 막기 위함</span>

	<span class="n">Mat</span> <span class="n">src</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">"hongkong.jpg"</span><span class="p">,</span> <span class="n">IMREAD_GRAYSCALE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Image load failed!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"getNumberOfCPUs(): "</span> <span class="o">&lt;&lt;</span> <span class="n">getNumberOfCPUs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"getNumThreads(): "</span> <span class="o">&lt;&lt;</span> <span class="n">getNumThreads</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Image size: "</span> <span class="o">&lt;&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">namedWindow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">WINDOW_NORMAL</span><span class="p">);</span>
	<span class="n">namedWindow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">WINDOW_NORMAL</span><span class="p">);</span>
	<span class="n">resizeWindow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>
	<span class="n">resizeWindow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>

	<span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">TickMeter</span> <span class="n">tm</span><span class="p">;</span>

	<span class="c1">// 1. Operator overloading</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">src</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"1. Operator overloading: "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 2. Pixel access by ptr()</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uchar</span><span class="o">*</span> <span class="n">pSrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="n">uchar</span><span class="o">*</span> <span class="n">pDst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pDst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pSrc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">128</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"2. Pixel access by ptr(): "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>

	<span class="c1">// 3. LUT() function</span>
	<span class="n">Mat</span> <span class="nf">lut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">CV_8U</span><span class="p">);</span>
	<span class="n">uchar</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">lut</span><span class="p">.</span><span class="n">ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturate_cast</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tm</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
	<span class="n">tm</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

	<span class="n">LUT</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	
	<span class="n">tm</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"3. LUT() function: "</span> <span class="o">&lt;&lt;</span> <span class="n">tm</span><span class="p">.</span><span class="n">getTimeMilli</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" ms."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

	<span class="n">imshow</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">imshow</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">waitKey</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-src="/assets\img\dev\week7\day4/lutresult.png" data-proofer-ignore></p><p><br /></p><p>룩업 테이블을 사용하는 예로는 영상 데이터를 회전할 때 sin,cos연산이 되게 느리게 동작한다. 그래서 이를 0.1도씩 룩업 테이블을 만들어놓고 쓰면 훨씬 빨라질 수 있다.</p></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/parallel/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/parallel.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/classlog/'>Classlog</a>, <a href='/categories/devcourse/'>devcourse</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devcourse/" class="post-tag no-text-decoration" >devcourse</a> <a href="/tags/opencv/" class="post-tag no-text-decoration" >OpenCV</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[데브코스] 7주차 - OpenCV parallel computing - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/parallel/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[데브코스] 7주차 - OpenCV parallel computing - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/parallel/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/parallel/&amp;text=[데브코스] 7주차 - OpenCV parallel computing - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/parallel/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/opencv2/"><div class="card-body"> <em class="timeago small" date="2022-03-21 14:01:00 +0900" >Mar 21, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 6주차 - OpenCV Gaussian blurring</h3><div class="text-muted small"><p> 블러링 평균 값 필터 (mean filter) 영상의 특정 좌표 값을 주변 픽셀 값들의 산술 평균으로 설정하는 것이다. 픽셀 들 간의 그레이스케일 값 변화가 줄어들어 날카로운 엣지가 무뎌지고, 영상에 있는 잡음의 영향이 사라지는 효과가 있다. #include &amp;lt;iostream&amp;gt; #include &quot;opencv2/opencv.hpp&quot; ...</p></div></div></a></div><div class="card"> <a href="/posts/opencv3/"><div class="card-body"> <em class="timeago small" date="2022-03-22 14:01:00 +0900" >Mar 22, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 6주차 - OpenCV Image Geometric Transformation</h3><div class="text-muted small"><p> 컬러 영상 처리의 기초 컬러 영상의 픽셀 값 참조 OpenCV에서 컬러 영상 표현 방법 빨강,초록, 파랑 색 성분을 256단계로 표현 opencv에서는 RGB순서가 아니라 BGR순서임 OpenCV에서 컬러 영상 다루기 Mat img1 = imread(&quot;lenna.bmp&quot;,IMREAD_CO...</p></div></div></a></div><div class="card"> <a href="/posts/opencv4/"><div class="card-body"> <em class="timeago small" date="2022-03-23 14:01:00 +0900" >Mar 23, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[데브코스] 6주차 - OpenCV Color Space</h3><div class="text-muted small"><p> 컬러 영상을 그레이 스케일로 변환 Y = 0.299R + 0.587G + 0.114B int main() { Mat src = imread(&quot;lenna.bmp&quot;); #if 0 Mat dst = Scalar(255, 255, 255) - src; #else Mat dst(src.rows, src.cols, CV_8UC1); for (...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/pid/" class="btn btn-outline-primary" prompt="Older"><p>[데브코스] 7주차 - ROS steering angle control using PID</p></a> <a href="/posts/corner/" class="btn btn-outline-primary" prompt="Newer"><p>[데브코스] 7주차 - OpenCV corner detection and feature point detection</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>