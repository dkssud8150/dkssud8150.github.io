<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Custom Dataset, Dataloader, Transform" /><meta name="author" content="JaeHo-YooN" /><meta property="og:locale" content="en" /><meta name="description" content="1. landmark가 있는 Custom Dataset" /><meta property="og:description" content="1. landmark가 있는 Custom Dataset" /><link rel="canonical" href="https://dkssud8150.github.io/posts/Dataset/" /><meta property="og:url" content="https://dkssud8150.github.io/posts/Dataset/" /><meta property="og:site_name" content="JaeHo Yoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-21T13:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Custom Dataset, Dataloader, Transform" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@JaeHo-YooN" /><meta name="google-site-verification" content="znvuGsQGYxMZPBslC4XG6doCYao6Y-fWibfGlcaMHH8" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"JaeHo-YooN"},"dateModified":"2021-10-21T13:00:00+09:00","datePublished":"2021-10-21T13:00:00+09:00","description":"1. landmark가 있는 Custom Dataset","headline":"Custom Dataset, Dataloader, Transform","mainEntityOfPage":{"@type":"WebPage","@id":"https://dkssud8150.github.io/posts/Dataset/"},"url":"https://dkssud8150.github.io/posts/Dataset/"}</script><title>Custom Dataset, Dataloader, Transform | JaeHo Yoon</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JaeHo Yoon"><meta name="application-name" content="JaeHo Yoon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/shin_chan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JaeHo Yoon</a></div><div class="site-subtitle font-italic">Mamba Mentality</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fab fa-angellist ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/dkssud8150" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoya58150','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.notion.so/18490713817d403696812c57d0abe730" aria-label="notion" target="_blank" rel="noopener"> <i class="fab fa-battle-net"></i> </a> <a href="https://www.linkedin.com/in/jaeho-yoon-90b62b230" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/jai_ho8150/" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Custom Dataset, Dataloader, Transform</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Custom Dataset, Dataloader, Transform</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dkssud8150">JaeHo-YooN</a> </em></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-10-21 13:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 21, 2021, 1:00 PM +0900" >Oct 21, 2021</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4249 words"> <em>23 min</em> read</span></div></div></div><div class="post-content"><h1 id="1-landmark가-있는-custom-dataset">1. landmark가 있는 Custom Dataset</h1><p>일반적이지 않은 데이터셋으로부터 데이터를 읽어오고 전처리하는 튜토리얼</p><p>dataset download url : https://download.pytorch.org/tutorial/faces.zip</p><p>이 데이터셋은 <code class="language-plaintext highlighter-rouge">landmark</code>가 있는 데이터셋이다.</p><h2 id="dataset-클래스">Dataset 클래스 <a href="#dataset-클래스" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>len(dataset) 에서 호츨되는 <strong>len</strong> 은 데이터셋의 크기를 리턴해야 한다.</p><p>dataset[i] 에서 호출되는 <strong>getitem</strong> 은 i번쨰 샘플을 찾는데 사용된다.</p><p><br /></p><p>__init__을 사용하여 CSV 파일 안에 있는 데이터를 읽지만, __getitem__을 이용해서 이미지를 판독해야 한다. 이 방법은 모든 이미지를 메모리에 저장하지 않고 필요할때마다 읽기 때문에 메모리에 효율적이다.</p><p>데이터 샘플은 {‘image’: image, ‘landmarks’: landmarks}의 사전 형태를 갖는다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">skimage</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="n">skimage.transform</span> <span class="kn">import</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">resize</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="n">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="n">cv2</span>

<span class="kn">import</span> <span class="n">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="nf">filterwarnings</span><span class="p">(</span><span class="s">"ignore"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">ion</span><span class="p">()</span> <span class="c1"># 반응형 모드
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">FaceLandmarksDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
  <span class="s">""" Face Landmarks dataset """</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="s">""" Args:
              csv_file (string): csv 파일 경로
              root_dir (string): 모든 이미지가 존재하는 디렉토리 경로
              transform (callable): 샘플에 적용할 optional transform
    """</span>
    <span class="n">self</span><span class="p">.</span><span class="n">landmarks_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>  <span class="c1"># csv_file을 불러온다.
</span>    <span class="n">self</span><span class="p">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>                      <span class="c1"># 모든 이미지가 존재하는 디렉토리 
</span>    <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

  <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">landmarks_frame</span><span class="p">)</span>              <span class="c1"># 데이터의 개수, 즉 image 개수라고 할 수 있다.
</span>
  <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="nf">is_tensor</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>                          <span class="c1"># idx가 tensor이면 list로 바꾼다.
</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">landmarks_frame</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># root_dir 안의 csv_file에서 모든 이미지를 불러와 할당
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_name</span><span class="p">)</span>                   <span class="c1"># 이미지 읽기
</span>
    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">landmarks_frame</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>      <span class="c1"># csv_file에서 각 idx 마다의 데이터들을 다 불러온다.
</span>    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">landmarks</span><span class="p">])</span>                   <span class="c1"># reshape를 위해 list가 아닌 numpy
</span>    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">landmarks</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="s">'float'</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># (k,2) 배열로 변환
</span>    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="s">'image'</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="s">'landmarks'</span><span class="p">:</span> <span class="n">landmarks</span><span class="p">}</span>   <span class="c1"># 각 image와 landmarks(keypoint)를 연결
</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span><span class="p">:</span>
      <span class="n">sample</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">sample</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="s">''' landmark를 보기 위한 함수 '''</span>
<span class="k">def</span> <span class="nf">show_landmarks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">):</span>
    <span class="s">"""Show image with landmarks"""</span>
    <span class="s">""" 랜드마크(landmark)와 이미지를 보여줍니다. """</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'.'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">pause</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 갱신이 되도록 잠시 멈춥니다.
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">face_dataset</span> <span class="o">=</span> <span class="nc">FaceLandmarksDataset</span><span class="p">(</span><span class="n">csv_file</span> <span class="o">=</span> <span class="s">'/content/drive/MyDrive/data/faces/face_landmarks.csv'</span><span class="p">,</span>
                                   <span class="n">root_dir</span> <span class="o">=</span> <span class="s">'/content/drive/MyDrive/data/faces/'</span><span class="p">)</span> <span class="c1"># __init__ 에 대한 args들을 받으면 len, getitem을 계산해놓고, 추후에 len이나 dataset[i]를 실행하면 리턴해줌
</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">face_dataset</span><span class="p">)):</span>
  <span class="n">sample</span> <span class="o">=</span> <span class="n">face_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># i만큼 idx를 지정
</span>
  <span class="nf">print</span><span class="p">(</span><span class="s">"number: {} </span><span class="se">\t</span><span class="s"> image shape: {} </span><span class="se">\t</span><span class="s"> label shape: {} </span><span class="se">\n</span><span class="s"> len image: {} </span><span class="se">\t</span><span class="s"> len label: {}"</span>
        <span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">]),</span><span class="nf">len</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">])))</span>
  <span class="s">''' 
      image - 1개의 이미지에 대해 324 row(높이) x 215 col(넓이) x 3 dim(RGB)
      label - 총 68개의 landmarks(keypoint) 68 row x 2 col
  '''</span>

  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
  <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="s">'Sample #{}'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="n">ax</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
  <span class="nf">show_landmarks</span><span class="p">(</span><span class="o">**</span><span class="n">sample</span><span class="p">)</span> <span class="c1"># **sample = io.imread(os.path.join('/content/drive/MyDrive/data/faces', img_name)),landmarks
</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="k">break</span>
</pre></table></code></div></div><p>Q. 왜 landmarks shape이 (68,2)가 되어야 하지?</p><blockquote><p>데이터가 columns를 보면 x,y가 존재한다. 따라서 1개의 landmark(keypoint)를 표현하기 위해 x,y값을 묶어야 한다. =&gt; 묶어서 보았을 때 이미지 상에 총 68개 keypoint가 존재한다.</p></blockquote><p>Q. image와 label의 size를 맞춰야 하는 것 아닌가?</p><blockquote><p>지금 출력하고 있는 것은 각각의 이미지의 <em>height x weight x depth</em> 이다. 따라서 총 이미지 크기가 아니기 때문에 맞지 않았던 것이다. 총 images 들의 len과 labels 들의 len은 맞는다.</p></blockquote><p><br /></p><p><br /></p><h2 id="transform-클래스">Transform 클래스 <a href="#transform-클래스" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>샘플들을 data augmentation 시킨다.</p><ul><li>rescale: 이미지의 크기를 조절<li>randomCrop: 무작위 자르기, data augmentation<li>ToTensor: numpy이미지를 torch이미지로 변경( 축 변환 )</ul><p>클래스를 작성할 때는 <strong>call</strong> 함수를 구현해야 한다. 필요하다면 <strong>init</strong> 함수도 구현해야 한다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Rescale</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="s">'''
  주어진 사이즈로 샘플 크기 조정

  Args: output size(tuple or int): 원하는 사이즈 값
                                   tuple인 경우 해당 tuple이 결과물의 크기가 되고, 
                                   int라면 비율을 유지하면서 길이가 작은 쪽이 output size가 된다.
  '''</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>    <span class="c1"># assert = 뒤의 조건이 True 가 아니면 에러를 발생시킨다. output size가 int나 tuple 타입이면 true
</span>    <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">landmarks</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">],</span> <span class="n">sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">]</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>                <span class="c1"># 각 image.shape는 [h,w,c] 로 구성되어 있다. 따라서 2번째까지만 추출
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">output_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># args - output_size가 int라면
</span>      <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>                           <span class="c1"># h/w 비율을 곱하여 new_h가 더 큰 값이 되도록
</span>        <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> 
      <span class="k">else</span><span class="p">:</span>
        <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span>
    
    <span class="k">else</span><span class="p">:</span>                                 <span class="c1"># tuple이라면 그대로 출력
</span>      <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span>
    

    <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">new_h</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">new_w</span><span class="p">)</span>           <span class="c1"># 크기는 int로 출력해야 되기에
</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">))</span>   <span class="c1"># image를 내가 원하는 사이즈의 값으로 크기 조정
</span>    <span class="c1"># 강의에서는 transform.resize 로 되어있는데 실행되지 않아 cv2로 바꾸어 실행해보았다.
</span>
    <span class="c1"># print("landmarks data: {} \nlandmarks shape: {} \nnew_w data: {} \nnew_h data: {}".format(landmarks, landmarks.shape, new_w, new_h) )
</span>
    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">landmarks</span> <span class="o">*</span> <span class="p">[</span> <span class="n">new_w</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">new_h</span> <span class="o">/</span> <span class="n">h</span> <span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">'image'</span><span class="p">:</span> <span class="n">img</span><span class="p">,</span> <span class="s">'landmarks'</span><span class="p">:</span> <span class="n">landmarks</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">RandomCrop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="s">'''
  샘플데이터를 무작위로 자름

  Args: output_size (tuple or int): 줄이고자 하는 크기로 int면 정사각형, tuple이라면 지정된 크기로
  '''</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>                <span class="c1"># int
</span>      <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>  <span class="c1"># 그대로
</span>    <span class="k">else</span><span class="p">:</span>                                           <span class="c1"># tuple
</span>      <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>                  <span class="c1"># size가 2일때만
</span>      <span class="n">self</span><span class="p">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">landmarks</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">],</span> <span class="n">sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">]</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>                        <span class="c1"># 256 이라고 하면
</span>    <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">output_size</span>               <span class="c1"># new = 224,224
</span>    
    <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="n">new_h</span><span class="p">)</span>         <span class="c1"># (0 ~ (256 - 224)) 값 사이의 random추출
</span>    <span class="n">left</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="n">new_w</span><span class="p">)</span>        <span class="c1"># 원본을 넘게 자르도록 설정되지 않도록 하기 위함
</span>    
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">top</span><span class="p">:</span> <span class="n">top</span> <span class="o">+</span> <span class="n">new_h</span><span class="p">,</span>               <span class="c1"># image의 높이를 새로 설정한 크기와 random하게 추출한 값을 더함
</span>                  <span class="n">left</span><span class="p">:</span> <span class="n">left</span> <span class="o">+</span> <span class="n">new_w</span><span class="p">]</span>             <span class="c1"># 원본보다는 무조건 작거나 같다.
</span>    
    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">landmarks</span> <span class="o">-</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span><span class="n">top</span><span class="p">]</span>            <span class="c1"># keypoint의 위치도 left,top을 뺌
</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">'image'</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="s">'landmarks'</span><span class="p">:</span> <span class="n">landmarks</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">ToTensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="s">'''
  numpy array를 tensor(torch)로 변환
  '''</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">landmarks</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">],</span> <span class="n">sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">]</span>

    <span class="c1"># swap color axis ( numpy image: HxWxC =&gt; torch image: CxHxW )
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s">'image'</span><span class="p">:</span><span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">),</span>
            <span class="s">'landmarks'</span><span class="p">:</span><span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">landmarks</span><span class="p">)}</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span><span class="nc">Rescale</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                                <span class="nc">RandomCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">)])</span>   <span class="c1"># output_size = 256,256  # output_size = 224,224
</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">face_dataset</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">image_transforms</span> <span class="o">=</span> <span class="nf">transform</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
  <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="nf">type</span><span class="p">(</span><span class="n">transform</span><span class="p">).</span><span class="n">__name__</span><span class="p">)</span>
  <span class="nf">show_landmarks</span><span class="p">(</span><span class="o">**</span><span class="n">image_transforms</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="n">transformed_dataset</span> <span class="o">=</span> <span class="nc">FaceLandmarksDataset</span><span class="p">(</span><span class="n">csv_file</span> <span class="o">=</span> <span class="s">'/content/drive/MyDrive/data/faces/face_landmarks.csv'</span><span class="p">,</span>
                                          <span class="n">root_dir</span> <span class="o">=</span> <span class="s">'/content/drive/MyDrive/data/faces/'</span><span class="p">,</span>
                                          <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span>
                                               <span class="nc">Rescale</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                                               <span class="nc">RandomCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                                               <span class="nc">ToTensor</span><span class="p">()</span>
                                           <span class="p">]))</span>
</pre></table></code></div></div><p>Q. landmark에다 new_w/w,new_h를 왜 곱하는걸까</p><blockquote><p>landmarks data가 각 keypoint의 좌표를 찍어놓은 것이기 때문에 landmark 데이터에도 비율만큼 곱해줘야 맞는 위치를 찍을 수 있다.</p></blockquote><p>Q. crop 할 때 왜 224가 output_size가 되야 할텐데 top+new_w를 하면 224가 무조건 나오는 건 아니지 않나. 이름만 output_size인가</p><blockquote><p>일단 음,, 실행이 되지 않음</p></blockquote><p><br /></p><p><br /></p><h2 id="dataloader-클래스">Dataloader 클래스 <a href="#dataloader-클래스" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>torch.utils.data.DataLoader를 사용하면 반복자(iterator)로서 많은 기능을 해준다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="n">dataloader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 배치하는 과정을 보여주는 함수입니다.
</span><span class="k">def</span> <span class="nf">show_landmarks_batch</span><span class="p">(</span><span class="n">sample_batched</span><span class="p">):</span>
    <span class="s">"""Show image with landmarks for a batch of samples."""</span>
    <span class="n">images_batch</span><span class="p">,</span> <span class="n">landmarks_batch</span> <span class="o">=</span> \
            <span class="n">sample_batched</span><span class="p">[</span><span class="s">'image'</span><span class="p">],</span> <span class="n">sample_batched</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">]</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">images_batch</span><span class="p">)</span>
    <span class="n">im_size</span> <span class="o">=</span> <span class="n">images_batch</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">grid_border_size</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">make_grid</span><span class="p">(</span><span class="n">images_batch</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">grid</span><span class="p">.</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">landmarks_batch</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">im_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_border_size</span><span class="p">,</span>
                    <span class="n">landmarks_batch</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="n">grid_border_size</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'.'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="s">'Batch from dataloader'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batched_sample</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">batched_sample</span><span class="p">[</span><span class="s">'image'</span><span class="p">].</span><span class="nf">size</span><span class="p">(),</span> <span class="n">batched_sample</span><span class="p">[</span><span class="s">'landmarks'</span><span class="p">].</span><span class="nf">size</span><span class="p">())</span> 

  <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
    <span class="nf">show_landmarks_batch</span><span class="p">(</span><span class="n">batched_sample</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">ioff</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="k">break</span>
</pre></table></code></div></div><p><br /></p><p><a href="https://github.com/dkssud8150/Computer-Vision/tree/main/pytorch%20tutorial">colab 실행 코드</a></p><p><br /></p><p><br /></p><h1 id="2-fashion-mnist를-활용한-custom-dataset">2. Fashion-MNIST를 활용한 Custom Dataset</h1><p>dataset은 샘플(image)과 정답(label)을 저장하고, dataloader은 dataset을 샘플에 쉽게 접근할 수 있도록 순회 가능한 객체(iterable)로 감싼다.</p><p><br /></p><p>fashionMNIST를 통해 benchmark 하고자한다.</p><p><br /></p><p><br /></p><h2 id="custom-dataset">Custom Dataset <a href="#custom-dataset" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>사용자 정의 dataset 클래스는 반드시 3개 함수(<strong>init</strong>, <strong>len</strong>, <strong>getitem</strong>)를 구현해야 하므로, img_dir을 통해 이미지가 있는 디렉토리를, annotations_file을 통해 label이 있는 csv을 불러온다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="n">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="n">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">from</span> <span class="n">torchvision.io</span> <span class="kn">import</span> <span class="n">read_image</span>

<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="s">'''
대부분의 데이터 label.csv는 

image1.jpg , 0
image2.jpg , 1
...
image9.jpg , 8
'''</span>

<span class="k">class</span> <span class="nc">CustomImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">annotations_file</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">target_transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">'''
    __init__함수는 dataset객체가 생성될 때 한번만 실행된다. 
    여기에서 이미지와 label 파일이 포함된 디렉토리와 transform을 초기화한다.
    transform - image, target-transform - label
    '''</span>
    <span class="n">self</span><span class="p">.</span><span class="n">img_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">)</span> <span class="c1"># init에서는 read_csv만 한다.
</span>    <span class="n">self</span><span class="p">.</span><span class="n">img_dir</span> <span class="o">=</span> <span class="n">img_dir</span>
    <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
    <span class="n">self</span><span class="p">.</span><span class="n">target_transform</span> <span class="o">=</span> <span class="n">trarget_transform</span>
  
  <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="s">'''
    __len__함수는 데이터셋의 샘플 개수를 반환
    '''</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_labels</span><span class="p">)</span>                     <span class="c1"># label의 행 길이(갯수) row
</span>
  <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">idx</span><span class="p">):</span>
    <span class="s">'''
    __getitem__함수는 주어진 인덱스 idx에 해당하는 샘플을 데이터셋에서 불러오고 반환한다.
    인덱스를 기반으로, 디스크에서 이미지의 위치를 식별하고, read_image를 사용하여 이미지를 텐서로 변환, 
    self.img_labels의 csv 데이터로부터 해당하는 label(정답)을 가져오고 변형함수를 호출하고, image와 label을 리턴
    '''</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">img_labels</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># image 경로들
</span>    <span class="n">image</span> <span class="o">=</span> <span class="nf">read_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img</span><span class="p">.</span><span class="n">labels</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                                <span class="c1"># image에 맞는 label 지정
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span><span class="p">:</span>
      <span class="n">image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">target_transform</span><span class="p">:</span>
      <span class="n">label</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">target_transform</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></table></code></div></div><p><br /></p><h2 id="dataloader">dataloader <a href="#dataloader" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">training_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s">"data"</span><span class="p">,</span> 
    <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="nc">ToTensor</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">validation_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s">"data"</span><span class="p">,</span> 
    <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="nc">ToTensor</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">train_dataloader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">val_dataloader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">validation_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></table></code></div></div><p><br /></p><h2 id="data-시각화">Data 시각화 <a href="#data-시각화" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="nf">iter</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Feature batch shape: </span><span class="si">{</span><span class="n">train_features</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Labels batch shape: </span><span class="si">{</span><span class="n">train_labels</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">train_features</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">squeeze</span><span class="p">()</span> <span class="c1"># [64,1,28,28] 을 [28,28]로 펼쳐야 plt 할 수 있다.
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"img shape: </span><span class="si">{</span><span class="n">img</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"gray"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span>
</pre></table></code></div></div><p><br /></p><h2 id="transform">Transform <a href="#transform" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>fashionMNIST 특징(image)들은 PIL image 형식이며 정답(label)은 int이다. 학습을 위해 정규화를 통한 이미지와 원핫으로 부호화된 텐서 형태의 label이 필요하다.</p><p>ToTensor는 PIL image나 Numpy ndarray를 floatTensor로 변환하고, 이미지의 픽셀의 크기 값을 [0.,1.]범위로 비례하여 조정한다.</p><p>Lambda 를 통해 정수를 원-핫으로 부호화된 텐서로 바꾸는 함수를 정의한다. 이 함수는 먼저(데이터셋 정답의 개수인)크기 10짜리 zero tensor를 만들고, scatter_를 호출하여 주어진 정답 y에 해당하는 인덱스에 value=1을 할당한다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="n">transform</span> <span class="o">=</span> <span class="nc">ToTensor</span><span class="p">()</span>
<span class="n">target_transform</span> <span class="o">=</span> <span class="nc">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> 
                          <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dytype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">).</span><span class="nf">scatter_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></table></code></div></div><p><br /></p><p><br /></p><h1 id="instance-segmentation-dataset에서의-custom-dataset">Instance segmentation dataset에서의 Custom Dataset</h1><p>객체 검출, 인스턴스 분할 및 키포인트 검출을 학습하기 위한 새로운 사용자 정의 데이터셋을 추가해보고자 한다.</p><p><code class="language-plaintext highlighter-rouge">__getitem__</code> 메소드가 다음을 반환해야 한다.</p><ul><li>image: PIL이미지의 크기(H,W)<li>target: 다음의 필드를 포함하는 사전 타입<ul><li>boxes (FloatTensor[N,4]): N개의 bounding box 좌표가 [x0,y0,x1,y1] 형태를 가진다. x와 관련된 값의 범위는 0부터 w이고, y와 관련된 값의 범위는 0부터 H까지다.<li>labels (int64Tensor[N]): 바운딩 박스마다의 라벨 정보, 0 은 배경<li>image_id (int64Tensor[1]): 이미지 구분자이다. 데이터셋의 모든 이미지 간에 고유한 값이어야 하며 평가 중에도 사용된다.<li>area (Tensor[N]): 바운딩 박스의 면적, 면적은 평가 시 작음, 중간, 큰 박스 간의 점수를 내기 위한 기준이고, COCO 평가를 기준으로 한다.<li>iscrowd (Uint8Tensor[N]): 이 값이 팜일 경우 평가에서 제외한다.<li>(선택)masks (Uint8Tensor(N, H, W]): N개의 객체 마다의 분할 마스크 정보<li>(선택)keypoints (FloatTensor[N, K, 3]): N개의 객체마다의 키포인트 정보. 키포인트는 [x,y,visibility] 형태의 값이다. visibility 값이 0인 경우 키포인트는 보이지 않음을 의미한다. data augmentation의 경우 키포인트 좌우 반전의 개념은 데이터 표현에 따라 달라지며, 새로운 키포인트 표현에 대해 코드 부분을 수정해야 할 수도 있다.</ul></ul><p>모델을 위의 방법대로 리턴하면 학습과 평가 둘 다에 대해 동작한다.</p><p><br /></p><p>배경은 무조건 0이어야 하기 때문에, 클래스 분류가 개, 고양이를 분류하고자 할때는 0이 아닌 1과 2로 정의해야 한다.</p><p><br /></p><p>추가로 학습 중 가로 세로 비율 그룹화를 사용하려는 경우, 이미지의 넓이, 높이를 리턴할 수 있도록 get_height_and_width 메소드를 구현하기를 추천한다. 이를 구현하지 않은 경우 모든 데이터셋은 __getitem__를 통해 메모리에 이미지가 로드되어 사용자 정의 메소드를 제공하는 것보다 느릴 수 있다.</p><p><br /></p><p>폴더 구조는 다음과 같다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>- PennFudanPed/
  - PedMasks/
    - FudanPend00001_mask.png
    - FudanPend00002_mask.png
    - ...
  - PNGImages/
    - FudanPed00001.png
    - FudanPed00002.png
    - ...
</pre></table></code></div></div><p><br /></p><p>image - masks 예시</p><p>&lt;img src = https://tutorials.pytorch.kr/_static/img/tv_tutorial/tv_image01.png width=”40%”&gt; &lt;img src = https://tutorials.pytorch.kr/_static/img/tv_tutorial/tv_image02.png width=”40%”&gt;</p><p>각 이미지에 해당하는 분할 마스크가 존재한다.</p><p><br /></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="k">class</span> <span class="nc">PennFudanDataset</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>

        <span class="c1"># 모든 이미지와 분할 마스크 정렬
</span>        <span class="n">self</span><span class="p">.</span><span class="n">imgs</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"PNGImages"</span><span class="p">))))</span> <span class="c1"># image셋을 불러옴
</span>        <span class="n">self</span><span class="p">.</span><span class="n">masks</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"PedMasks"</span><span class="p">))))</span> <span class="c1"># mask셋을 불러옴
</span>
        <span class="c1"># detection과 segmentation이므로 label에 대한 값은 가져오지 않는다. 정답에 대한 셋이 mask이다.
</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> 
        <span class="c1"># 이미지와 마스크를 읽어옵니다
</span>        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"PNGImages"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="c1"># 이미지 각각의 데이터를 가져옴
</span>        <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"PedMasks"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">masks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">).</span><span class="nf">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">)</span>
        
        <span class="c1"># 분할 마스크는 RGB로 변환하지 않음을 유의하세요
</span>        <span class="c1"># 왜냐하면 각 색상은 다른 인스턴스에 해당하며, 0은 배경에 해당합니다
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
        
        <span class="c1"># PIL 이미지를 numpy 배열로 변환합니다
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        
        <span class="c1"># 인스턴스들은 각기 다른 색들로 인코딩 되어야 한다.
</span>        <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        
        <span class="c1"># 첫번째 id 는 배경이라 제거합니다
</span>        <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">obj_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># 컬러 인코딩된 마스크를 바이너리 마스크 세트로 나눕니다. ???
</span>        <span class="n">masks</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="n">obj_ids</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>

        <span class="c1"># 각 마스크의 바운딩 박스 좌표를 얻습니다
</span>        <span class="n">num_objs</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_objs</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 각 masks에 대한 값들
</span>            <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>     <span class="c1"># 중 각각의 x,y 좌표를 지정
</span>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>

        <span class="c1"># 모든 것을 torch.Tensor 타입으로 변환합니다
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">as_tensor</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># 32와 64는 메모리 사용량을 나타내는 것
</span>
        <span class="c1"># 예제에서는 사람만을 분류하므로 객체는 1종류이다.
</span>        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="n">num_objs</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">as_tensor</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>   <span class="c1"># as_tensor = tensor의 데이터타입이나 device를 바꾸는 방법, 
</span>                                                            <span class="c1"># .to()와 똑같은 기능, x.to(device, dtype=torch.float64)
</span>                                                            <span class="c1"># device는 .cuda()로, 타입은 .half(), .float() 등으로 바꿀 수도 있음
</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="n">idx</span><span class="p">])</span>                      <span class="c1"># 이미지 구분자
</span>        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># 바운딩 박스의 면적, 평가 시 점수내는 기준
</span>        
        <span class="c1"># 모든 인스턴스는 군중(crowd) 상태가 아님을 가정합니다
</span>        <span class="n">iscrowd</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">num_objs</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># 이 값이 참일 경우 평가에서 제외
</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"boxes"</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"labels"</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"masks"</span><span class="p">]</span> <span class="o">=</span> <span class="n">masks</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"image_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_id</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"area"</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
        <span class="n">target</span><span class="p">[</span><span class="s">"iscrowd"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iscrowd</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transforms</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">)</span>
</pre></table></code></div></div><p><br /></p><p>이 장에서는 custom dataset을 위주로 공부할 것이기에 모델 학습과 평가는 하지 않을 것이다. 더 궁금하다면 <a href="https://tutorials.pytorch.kr/intermediate/torchvision_tutorial.html">참고 사이트</a>를 참고하길 바란다.</p><p><br /></p><p><br /></p><h1 id="reference">Reference</h1><ul><li>landmark dataset: <a href="https://tutorials.pytorch.kr/beginner/data_loading_tutorial.html">https://tutorials.pytorch.kr/beginner/data_loading_tutorial.html</a><li>Fashion-MNIST datset: <a href="https://tutorials.pytorch.kr/beginner/basics/data_tutorial.html#id7">https://tutorials.pytorch.kr/beginner/basics/data_tutorial.html#id7</a><li>Instance segmentation: <a href="https://tutorials.pytorch.kr/intermediate/torchvision_tutorial.html">https://tutorials.pytorch.kr/intermediate/torchvision_tutorial.html</a></ul></div><div class="post-tail-wrapper text-muted"><div style="text-align: left;"> <a href="http://hits.dwyl.com/dkssud8150.github.io/posts/Dataset/" target="_blank"> <img data-src="http://hits.dwyl.com/dkssud8150.github.io/posts/Dataset.svg" data-proofer-ignore> </a></div><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/classlog/'>Classlog</a>, <a href='/categories/pytorch-tutorial/'>Pytorch Tutorial</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pytorch-tutorial/" class="post-tag no-text-decoration" >pytorch tutorial</a> <a href="/tags/customdataset/" class="post-tag no-text-decoration" >CustomDataset</a> <a href="/tags/customdataloader/" class="post-tag no-text-decoration" >CustomDataloader</a> <a href="/tags/customtransforms/" class="post-tag no-text-decoration" >CustomTransforms</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Custom Dataset, Dataloader, Transform - JaeHo Yoon&amp;url=https://dkssud8150.github.io/posts/Dataset/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Custom Dataset, Dataloader, Transform - JaeHo Yoon&amp;u=https://dkssud8150.github.io/posts/Dataset/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dkssud8150.github.io/posts/Dataset/&amp;text=Custom Dataset, Dataloader, Transform - JaeHo Yoon" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://dkssud8150.github.io/posts/Dataset/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6611243953442169" crossorigin="anonymous"></script></div><script src="https://utteranc.es/client.js" repo="dkssud8150/dkssud8150.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gitpage/">[깃허브 프로필 꾸미기] github 프로필 만들기</a><li><a href="/posts/product/">[깃허브 프로필 꾸미기] productive box 만들기</a><li><a href="/posts/regex/">[데브코스] 2주차 - linux 기초(REGEX)</a><li><a href="/posts/Kfold/">KFold Cross Validation 과 StratifiedKFold</a><li><a href="/posts/cmake/">[데브코스] 17주차 - CMake OpenCV, Eigen, Pangolin install </a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/TensorBoard/"><div class="card-body"> <em class="timeago small" date="2021-10-21 13:00:00 +0900" >Oct 21, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TensorBoard 사용해보기</h3><div class="text-muted small"><p> 기본 모델 구조 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 # i...</p></div></div></a></div><div class="card"> <a href="/posts/torchsaveload/"><div class="card-body"> <em class="timeago small" date="2021-10-24 13:00:00 +0900" >Oct 24, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Torch Save and Load, data를 plot해보기</h3><div class="text-muted small"><p> 기본 구조 기본 구조는 다음과 같다. 자세한 내용은 참고 사이트를 참고하길 바란다. Save 기본적으로 모델을 저장하는 일반적인 방법은 내부 상태 사전(internal state dictionary)를 직렬화(serialize)하는 것이다. 1 2 torch.save(model.state_dic(), &quot;model.pth&quot;) print(&quot;save...</p></div></div></a></div><div class="card"> <a href="/posts/Kfold/"><div class="card-body"> <em class="timeago small" date="2021-10-28 13:00:00 +0900" >Oct 28, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>KFold Cross Validation 과 StratifiedKFold</h3><div class="text-muted small"><p> KFold Cross Validation 교차검증이란 훈련 시 과적합을 막기 위해 사용하는 것이다. 교차검증은 훈련 데이터 셋을 학습 데이터와 검증 데이터 셋으로 분할하고, 훈련 데이터와 검증 데이터 셋을 교차하면서 검증한다. 학습셋과 검증셋을 나눠 반복해서 검증한다. k만큼의 폴드 셋으로 나누어 k번 반복한다. 그렇게 되면 최종 평가는 k만큼의 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/handdetection/" class="btn btn-outline-primary" prompt="Older"><p>2021 Ego-Vision 손동작 인식 경진대회</p></a> <a href="/posts/TensorBoard/" class="btn btn-outline-primary" prompt="Newer"><p>TensorBoard 사용해보기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">JaeHo YooN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devcourse/">devcourse</a> <a class="post-tag" href="/tags/deeplearning/">deeplearning</a> <a class="post-tag" href="/tags/cs231n/">CS231N</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/coding-test/">coding test</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kooc/">kooc</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/pytorch-tutorial/">pytorch tutorial</a> <a class="post-tag" href="/tags/autonomous-driving/">Autonomous Driving</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NC7MWHVXJE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NC7MWHVXJE'); }); </script>