---
title:    "[ë°ë¸Œì½”ìŠ¤] 4ì£¼ì°¨ - ROS nodes and topics for lidar sensors "
author:
  name: JaeHo YooN
  link: https://github.com/dkssud8150
date: 2022-03-10 15:14:00 +0800
categories: [Classlog, devcourse]
tags: [ros, urdf,rviz, devcourse]
toc: True
comments: True
image:
  src: /assets/img/dev/week4/day3/lidar.jpeg
  width: 800
  height: 500
---

<br>

# ë¼ì´ë‹¤ ì„¼ì„œ ROS íŒ¨í‚¤ì§€

ë¼ì´ë‹¤ ì„¼ì„œ ROS íŒ¨í‚¤ì§€ë¥¼ xycar_lidarë¡œ ë§Œë“ ë‹¤. í† í”½ì˜ ì´ë¦„ì€ `/scan`ìœ¼ë¡œ í•  ê²ƒì´ë‹¤. 

`/scan` í† í”½ì•ˆì—ëŠ”
- íƒ€ì… : sensor_msgs\/LaserScan
- êµ¬ì„±
    - std_msgs/Header header    # ì‹œí€€ìŠ¤ ë²ˆí˜¸, ì‹œê°„, ì•„ì´ë””ë¥¼ ë‹´ëŠ”ë‹¤.
        uid32 seq
        time stamp
        string frame_id         # rvizì— ì‚¬ìš©ë˜ëŠ” ê°’
    float32 angle_min
    float32 angle_max
    ...
    float32[] ranges            # ì¥ì• ë¬¼ê¹Œì§€ì˜ ê±°ë¦¬ ì •ë³´ë“¤ì„ ë‹´ëŠ” array
    float32[] intensities       # ë¬¼ì²´ì˜ ê²½ë„

<br>

## ë¼ì´ë‹¤ ê±°ë¦¬ ì •ë³´ í™”ë©´ì— ì¶œë ¥

### íŒ¨í‚¤ì§€ ë§Œë“¤ê¸°

```markdown
xycar_ws
  âŠ¢ build
  âŠ¢ devel
  âˆŸ src
      âˆŸ my_lidar
          âŠ¢ launch
              âˆŸ lidar_scan.launch
          âˆŸ src
              âˆŸ lidar_scan.py
```


```bash
xycar_ws/src$ catkin_create_pkg my_lidar std_msgs rospy
```

### ì„œë¸Œ í´ë” ë§Œë“¤ê¸°

- launch íŒŒì¼ ìƒì„±

```bash
$ mkdir launch
$ gedit lidar_scan.launch
```

### ì†ŒìŠ¤íŒŒì¼ ë§Œë“¤ê¸°

ë¼ì´ë‹¤ë¡œë¶€í„° ì£¼ë³€ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ê°’ì„ ë°›ì•„ ì¶œë ¥í•œë‹¤.

```python
#!/usr/bin/env python

# lidar_scan.py

import rospy
import time
from sensor_msgs.msg import LaserScan # LaserScan ë©”ì‹œì§€ ì‚¬ìš© ì¤€ë¹„

lidar_points = None

# ë¼ì´ë‹¤ í† í”½ì´ ë“¤ì–´ì˜¤ë©´ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
def lidar_callback(data):
    global lidar_points 
    lidar_points = data.ranges

rospy.init_node('my_lidar', anonymous=True) # lidar ì´ë¦„ì˜ ë…¸ë“œ ìƒì„±
rospy.Subscriber('/scan', LaserScan, lidar_callback, queue_size=1) # laserscan í† í”½ì´ ì˜¤ë©´ ì½œë°±í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë„ë¡ ì…‹íŒ…

while not rospy.is_shutdown():
    if lidar_points == None:
        continue    # í† í”½ì´ ì•ˆì™”ìœ¼ë©´ ê¸°ë‹¤ë ¤ë¼

    rtn = ''

    for i in range(12): # 30ë„ì”© ê±´ë„ˆë›°ë©´ì„œ 12ê°œ ê±°ë¦¬ê°’ë§Œ ì¶œë ¥
        rtn += str(format(lidar_points[i*30],'.2f')) + ", "

    print(rtn[:2])
    time.sleep(1.0) # ì²œì²œíˆ ì¶œë ¥
```

- launch íŒŒì¼ ìƒì„±

```xml
<!-- lidar_scan.launch -->
<launch>
    <include file="$(find xycar_lidar)/launch/lidar_noviewer.launch" /> <!-- ë¼ì´ë‹¤ ì¥ì¹˜ë¥¼ êµ¬ë™ì‹œì¼œ í† í”½ì„ ë°œí–‰í•˜ëŠ” íŒŒì¼ -->
    <node name="my lidar" pkg="my_liad" type="lidar_scan.py" output='screen' />
</launch>
```

### ì‹¤í–‰

```bash
$ roslaunch my_lidar lidar_scan.launch
```

ì¶œë ¥ì—ì„œ infëŠ” ë¬´í•œëŒ€ë¡œ ë„ˆë¬´ ë©€ê±°ë‚˜ ë„ˆë¬´ ê°€ê¹ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. ì¶œë ¥ëœ ì •ë³´ëŠ” ê±°ë¦¬ë¡œ më‹¨ìœ„ì´ë‹¤. ì½”ë“œë¥¼ ì§¤ ë•Œ infì™€ ê°™ì´ ì˜¤ë¥˜ê°€ ë‚˜ëŠ” ê²ƒì— ëŒ€í•´ì„œ ì˜ ì²˜ë¦¬í•´ì•¼ ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•Šê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

<br>

## ì¶œë ¥ ì‹œê°í™”í•˜ê¸°

### íŒ¨í‚¤ì§€ ìƒì„±

```
xycar_ws
  âŠ¢ build
  âŠ¢ devel
  âˆŸ src
      âˆŸ rviz_lidar
          âŠ¢ launch
              âˆŸ lidar_3d.launch
          âŠ¢ src
          âˆŸ rviz
              âˆŸ lidar_3d.rviz
```


rviz_lidarë¼ëŠ” ì´ë¦„ì˜ ROS íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•œë‹¤.

```bash
$ catkin_create_pkg rivz_lidar rospy tf geometry_msgs urdf rviz xacro
```

### ì„œë¸Œ í´ë” ìƒì„±

- launch í´ë” ë§Œë“¤ê¸°
    - lidar_3d.launch ìƒì„±
    
    ```xml
    <launch>
        <!-- rviz display -->
        <node name="rviz_visualizer" pkg="rviz" type="rviz" required="true"
        args="-d $(find rviz_lidar)/rviz/lidar_3d.rviz"/>

        <!-- c++ íŒŒì¼ì„ ì‹¤í–‰ -->
        <node name="xycar_lidar" pkg="xycar_lidar" type="xycar_lidar" output="screen" >
            <!-- í¬íŠ¸ -->
            <param name="serial_port"   xype="string"   value="/dev/ttyRPL"/>
            <!-- usbì´ì§€ë§Œ serialíŒŒì¼ë¡œ ëŒì•„ê°„ë‹¤. -->
            <param name="serial_baudrate"   xype="int"   value="115200"/>
            <param name="frame_id"   xype="string"   value="laser"/>
            <param name="inverterd"   xype="bool"   value="false"/>
            <param name="angle_compensate"   xype="bool"   value="true"/>
        </node>
    </launch>
    ```

### + ë¼ì´ë‹¤ ì¥ì¹˜ê°€ ì—†ì„ ê²½ìš°
ê·¸ëŸ¬ë‚˜ ë¼ì´ë‹¤ ì¥ì¹˜ê°€ ì—†ì„ ê²½ìš°ì—ëŠ” ì´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤. í•˜ì§€ë§Œ ì‹¤ì œ ë¼ì´ë‹¤ ì¥ì¹˜ë¥¼ ëŒ€ì‹ í•˜ì—¬ /scan í† í”½ì„ ë°œí–‰í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

ROSì—ì„œ ì œê³µí•˜ëŠ” **rosbag**ë¥¼ ì´ìš©í•˜ë©´ ëœë‹¤. ì´ëŠ” ë¼ì´ë‹¤ì—ì„œ ë°œí–‰í•˜ëŠ” scan í† í”½ì„ ì €ì¥í•´ë†“ì€ íŒŒì¼ë¡œ, ê·¸ ë‹¹ì‹œì˜ ì‹œê°„ ê°„ê²©ì— ë§ì¶”ì–´ scan í† í”½ì„ ë°œí–‰í•  ìˆ˜ ìˆë‹¤.

<br>

ì´ rosbagì„ ì‚¬ìš©í•  ê²½ìš° launchíŒŒì¼ì„ ì‚´ì§ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

```xml
<!-- lidar_3d_rosbag.launch -->
<launch>
    <!-- rviz display -->
    <node name="rviz_visualizer" pkg="rviz" type="rviz" required="true"
    args="-d $(find rviz_lidar)/rviz/lidar_3d.rviz"/>

    <!-- c++ íŒŒì¼ì„ ì‹¤í–‰ -->
    <node name="rosbag_play" pkg="rosbag" type="play" output="screen" 
        required="true" args="$(find rviz_lidar)/src/lidar_topic.bag" />
</launch>
```

ë” ìì„¸í•œ ê±´ ì•„ë˜ì—ì„œ ë‹¤ë£¨ê² ë‹¤.

<br>

### ì‹¤í–‰
ë¨¼ì € ë¼ì´ë‹¤ê°€ ìˆëŠ” ê²½ìš°ë¥¼ ì‚´í´ë³´ì.

```bash
roslaunch rviz_lidar lidar_3d.launch
```

ì‹¤í–‰ì„ í•´ë„ ì•„ì§ ì•„ë¬´ê²ƒë„ ì•ˆë‚˜ì˜¨ë‹¤. í”ŒëŸ¬ê·¸ì¸ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.

1. í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
    - ìš°ì¸¡ displays íƒ­ í•˜ë‹¨ì— addí´ë¦­
    - laserscan ì„ íƒ í›„ okí´ë¦­
2. topic ì„¤ì •
    - laserscan ì—ì„œ topicì„ `/scan`ìœ¼ë¡œ ì‘ì„±í•˜ê±°ë‚˜ í™”ì‚´í‘œë¥¼ ëˆŒëŸ¬ ì„ íƒ
3. fixed frame
    - displays íƒ­ì—ì„œ fixed frameì„ laserë¡œ ìˆ˜ì •
    - ì´ëŠ” header - frame_id ì— í•´ë‹¹í•˜ëŠ” ê°’ì„
4. size ì„¤ì •
    - laserscanì—ì„œ sizeë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤. 0.1 ì •ë„ë¡œ í•˜ë©´ í™”ë©´ì— ì˜ ë³´ì¼ ê²ƒì´ë‹¤.
    - ë„ˆë¬´ ì‘ìœ¼ë©´ ì‚¬ì´ì¦ˆë¥¼ í‚¤ìš°ë©´ ëœë‹¤.

<br>

<br>

## ROSBAG

[ros ê³µì‹ ë¬¸ì„œ - rosbag](http://wiki.ros.org/rosbag)

ROSBAG : ROS ëª…ë ¹ì–´ë¡œ í† í”½ì„ êµ¬ë…í•˜ì—¬ íŒŒì¼ë¡œ ì €ì¥í•˜ê±°ë‚˜íŒŒì¼ì—ì„œ í† í”½ì„ êº¼ë‚´ ë°œí–‰í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

í† í”½ì˜ ë‚´ìš©ë§Œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì‹œê°„ë„ í•¨ê»˜ ë‹´ì•„ì„œ êº¼ë‚¼ ë•ŒëŠ” ì‹œê°„ë„ í•¨ê»˜ ë°›ì„ ìˆ˜ ìˆë‹¤.

### ì‚¬ìš©ë²•

- í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰

```bash
ì €ì¥
$ rosbag record -O lidar_topic scan

ë¶ˆëŸ¬ì˜¤ê¸°
$ rosbag play lidar_topic.bag 
```

lidar_topicì€ ì €ì¥í•  íŒŒì¼ì˜ ì´ë¦„ì´ê³ , scanì€ êµ¬ë…í•´ì„œ ì €ì¥í•  í† í”½ì˜ ì´ë¦„ì´ë‹¤. í† í”½ì€ ì—¬ëŸ¬ê°œë¡œ ì‘ì„± ê°€ëŠ¥í•˜ë‹¤.

<br>

- ëŸ°ì¹˜íŒŒì¼ì—ì„œ ì‹¤í–‰

nodeë¥¼ ì„ ì–¸í•  ê²ƒì´ë‹¤.

```xml
<launch>
    <node name="rosbag_play" pkg="rosbag" type="play" output="screen"
        required="true" args="$(find rviz_lidar)/src/liar_topic.bag" />
</launch>
```

<br>

<br>

## range ë°ì´í„°ë¥¼ ë°œí–‰í•´ì„œ ë·°ì–´ì— í‘œì‹œí•´ë³´ê¸°

rangeë°ì´í„°ë¥¼ ë‹´ì€ í† í”½ì„ ë°œí–‰í•˜ëŠ” `lidar_range.py`ë¥¼ ë§Œë“¤ì–´ì„œ `/scan1` ì´ë¦„ì˜ í† í”½ì„ ë°œí–‰í•œë‹¤.

rangeíƒ€ì…ì˜ ë°ì´í„°ë¥¼ ë‹´ì€ /scan1 /scan2 /scan3 /scan4 ì´ 4ê°œ í† í”½ì„ ë°œí–‰í•œë‹¤.
RVIZì—ì„œëŠ” ì›ë¿” ê·¸ë¦¼ì˜ Range ê±°ë¦¬ì •ë³´ë¥¼ ì‹œê°í™”í•˜ì—¬ í‘œì‹œí•œë‹¤.

```
xycar_ws
  âŠ¢ build
  âŠ¢ devel
  âˆŸ src
      âˆŸ rviz_lidar
          âŠ¢ launch
              âˆŸ lidar_range.launch
          âŠ¢ src
              âˆŸ lidar_range.py
          âˆŸ rviz
              âˆŸ lidar_range.rviz
```

ê¸°ì¡´ì˜ rviz_lidaríŒŒì¼ì—ì„œ ì§„í–‰í•  ê²ƒì´ê³ , ì—°ê²° ê´€ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

<img src="/assets/img/dev/week4/day4/rosbag_con.png">

- ë…¸ë“œ ì´ë¦„: lindar_range
- í† í”½ ì´ë¦„: /scan1~4
- ë©”ì‹œì§€ íƒ€ì…: range (from sensor_msgs.msg import Range)

publish ë…¸ë“œ
```
pub1 = rospy.Publisher('scan1',Range,queue_size=1)
pub2 = rospy.Publisher('scan2',Range,queue_size=1)
pub3 = rospy.Publisher('scan3',Range,queue_size=1)
pub4 = rospy.Publisher('scan4',Range,queue_size=1)
```

í•˜ë©´ ìˆœì„œëŒ€ë¡œ ë‚ ì•„ê°ˆ ê²ƒì´ë‹¤.

range íƒ€ì…ì„ í™•ì¸í•˜ê¸° ìœ„í•´

```bash
$ rosmsg show sensor_msgs/Range
```

<img src="/assets/img/dev/week4/day4/rangeshow.png">

ë” ìì„¸íˆ ë³´ë ¤ë©´ http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Range.html ë¡œ ê°€ë³´ë©´ ìì„¸íˆ ë‚˜ì˜¨ë‹¤.

ë‹¨ìˆœí•˜ê²Œ ì–¼ë§Œí¼ ë–¨ì–´ì ¸ ìˆëŠ”ê°€ì— ëŒ€í•œ ê²ƒìœ¼ë¡œ ë¶€ì±„ê¼´ ëª¨ì–‘ìœ¼ë¡œ ì¸¡ì •í•¨ì„ ë³´ì—¬ì¤€ë‹¤. ëŒ€ì²´ë¡œ ì „íŒŒë‚˜ ìŒíŒŒ ë“±ì€ ë¶€ì±„ê¼´ ëª¨ì–‘ìœ¼ë¡œ ë‚ ì•„ê°€ì„œ ë‹¤ì‹œ ëŒì•„ì˜¬ ê²ƒì´ë‹¤.

- header.timestamp: ì†¡ì‹ ë¶€í„° ìˆ˜ì‹ ê¹Œì§€ì˜ ì‹œê°„ì„ ë‚˜íƒ€ë‚¸ ê²ƒì´ë‹¤.
- radiation_type: soundì¸ì§€ ì ì™¸ì„ ì¸ì§€ ë“±ë“±ì˜ íƒ€ì…ì„ ë‚˜íƒ€ë‚¸ë‹¤.
- field.of_view: ì¤‘ê°„ì„ 0ìœ¼ë¡œ ê¸°ì¤€ì¡ì•„ ë°˜ ë¶€ì±„ê¼´ì˜ ê°ë„ (ëŒ€ì²´ë¡œ ì´ˆìŒíŒŒ ì„¼ì„œëŠ” ì™¼/ì˜¤ ê°ê° 15ë„, ì´ 30ë„)
- min_range/max_range: ì´ ì¥ì¹˜ê°€ ê°ì§€í•  ê±°ë¦¬ì˜ ê²½ê³„ê°’
- range: ê°ì§€í•œ ê±°ë¦¬ì˜ ê°’ (-inf(ê±°ë¦¬ê°€ ë„ˆë¬´ ê°€ê¹Œìš¸ ë–„), +inf(ê±°ë¦¬ê°€ ë„ˆë¬´ ë©€ ë•Œ))


- lidar_range.py

```python
#!/usr/bin/env pythonm

# range, header import
import serial, time, rospy
from sensor_msgs.msg import Range
from std_msgs import Header

# mk node
rospy.init_node('lidar_range')

# mk 4 publisher
pub1 = rospy.Publisher('scan1',Range,queue_size=1)
pub2 = rospy.Publisher('scan2',Range,queue_size=1)
pub3 = rospy.Publisher('scan3',Range,queue_size=1)
pub4 = rospy.Publisher('scan4',Range,queue_size=1)

msg = Range()
# fill the range field - header information, required information about range expression of cone shape
header = Header()
header.frame_id = "sensorXY"
msg.header = header
msg.radiation_type = Range().ULTRASOUND
msg.min_range = 0.02                    # 2cm
msg.max_range = 2.0                     # 2m
msg.field_of_view = (30.0/180.0)*3.14   # radian expression 1/6 pi

while not rospy.is_shutdown():
    msg.header.stamp = rospy.Time.now()

    # pushing the distance to the object at msg.range in meters and publishing topic
    msg.range = 0.4
    pub1.publish(msg)

    msg.range = 0.8
    pub2.publish(msg)

    msg.range = 1.2
    pub3.publish(msg)

    msg.range = 1.6
    pub4.publish(msg)    

    time.sleep(0.2) # slow publish
```

- lidar_range.launch

```xml
<launch>
    <!-- rviz display -->
    <node name="rviz_visualizer" pkg="rviz" type="rviz" required="true"
        args="-d $(find rviz_lidar)/rviz/lidar_range.rviz"/>

    <!-- implement the python file we just made -->    
    <node name="lidar_range" pkg="rviz_lidar" type="lidar_range.py"/>
</launch>
```

### ì‹¤í–‰

```bash
$ roslaunch rviz_lidar lidar_range.launch
```

### í† í”½ ë‚´ìš© í™•ì¸

ê·¸ë¦¼ì´ ê·¸ë ¤ì§€ê¸° ì „ì— í† í”½ì´ ì˜ ë‚ ì•„ê°€ê³  ìˆëŠ”ì§€ ë´ì•¼ í•œë‹¤.

```bash
$ rostopic list
...
/scan1
/scan2
/scan3
/scan4

$ rostopic echo scan1
header:
    seq: 24
    stamp:
        secs: 
        nsecs:
    frame_id: "sensorXY"
radiation_type: 0
field_of_type: 0.52333
min_range: 0.019999
max_range: 2.0
range: 0.4000
```

ë‹¤ ì˜ ë‚˜ì˜¤ë©´ ëœ ê²ƒì´ë‹¤.

### RVIZ ì„¤ì •

1. fixed frame ì§€ì •
    - ì›ë˜ëŠ” mapìœ¼ë¡œ ë˜ì–´ ìˆê¸°ì— sensorXYë¡œ ë°”ê¿”ì•¼ í•œë‹¤.
2. plugin ì¶”ê°€
    - display í•˜ë‹¨ì— add ëˆ„ë¥´ê³  by topic íƒ­ì—ì„œ /scan - rangeê°€ ìˆë‹¤. ì´ë¥¼ ëˆ„ë¥´ê³  ok
3. í† í”½ ì´ë¦„ í™•ì¸
    - ìˆ˜ì‹ í•  í† í”½ì´ ì˜ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
4. ìƒìƒ í™•ì¸
    - color ì§€ì •ì—ì„œ ìì‹ ì´ ì›í•˜ëŠ” ìƒ‰ìƒ í´ë¦­

4ê°œ ëª¨ë‘ ì„ íƒë  ê²½ìš° ê²¹ì³ì„œ í‘œì‹œë  ìˆ˜ ìˆì–´ í™•ì¸ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆë‹¤. 

<br>

## ë¼ì´ë‹¤ì™€ ìœµí•©í•˜ì—¬ ì‹œê°í™”

rosbagíŒŒì¼ì—ì„œ í† í”½(/scan)ì„ ë°œí–‰í•˜ì—¬ lidar_urdf.pyë¡œ ë°›ì•„ì§€ê³ , ì´ë¥¼ ì •ì œí•˜ì—¬ 4ê°œì˜ í† í”½ì„ ë°œí–‰í•¨ìœ¼ë¡œì¨ rvizë¡œ ì „ë‹¬ë˜ê²Œ í•œë‹¤.

1.íŒŒì´ì¬ íŒŒì¼(lidar_urdf.py)

LaserScan íƒ€ì…ì˜ ë°ì´í„°ë¥¼ Range íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤. /scan í† í”½ì„ ë°›ì•„ scan1, scan2, scan3, scan4, 4ê°œì˜ í† í”½ìœ¼ë¡œ ë°œí–‰

<img src="/assets/img/dev/week4/day4/laserrange.png">

<br>

```python
#!/usr/bin/env python

import serial
...

def lidar_callback(data):
    global lidar_points
    lidar_points = data.ranges

rospy.init_node("lidar")
...

while not rospy.is_shutdown():
    ...
    h.frame_id = "front"
    msg.range = lidar_points[90] # ë¶ì„ ì „ë°©ì„ ë‘ì—ˆì„ ë•Œ ì´ìª½ì´ 0ë„ ì´ë¯€ë¡œ, frontëŠ” 3ì‹œë°©í–¥ì´ë¥´ëª¨ 90
    ...

    h.frame_id = "back"
    msg.range = lidar_points[270] # 9ì‹œë°©í–¥ì´ë¯€ë¡œ 270
```

> ğŸˆ ì¤‘ìš”í•œ ê²ƒì€ frame_idì˜ ì´ë¦„ê³¼ urdfì˜ ë¸”ë¡ì˜ ì´ë¦„ì„ ì¼ì¹˜ì‹œì¼œì•¼ í•œë‹¤.

<br>

2.URDF ëª¨ë¸ë§ íŒŒì¼(lidar_urdf.urdf)

ì¤‘ì•™ì— ë¹¨ê°„ìƒ‰ ë°•ìŠ¤ë¥¼ ë§Œë“¤ê³ , 4ë°©í–¥ì—ì„œ ì„¼ì„œ í”„ë ˆì„ì„ ì—°ê²°í•œë‹¤.
- base_linkì— ê°€ë¡œì„¸ë¡œ 20cm, redë°•ìŠ¤ baseplateë¥¼ ë§Œë“¤ì–´ ì—°ê²°
- ì„¼ì„œëŠ” x,y, ì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì‹¬ì—ì„œ 10cmì”© ì´ë™ì‹œì¼œì„œ ë°•ìŠ¤ì˜ ëë¶€ë¶„ì— ë°°ì¹˜

<br>

ì¤‘ì•™ ë°•ìŠ¤ì˜ í¬ê¸°ëŠ” ê°€ë¡œxì„¸ë¡œxë†’ì´ = 0.2m x 0.2m x 0.07m

```xml
<joint name="baseplate_to_front" type="fixed">
    <parent link="baseplate"/>
    <child link="front"/>
    <origin rpy="0 0 0" xyz="0.1 0 0"/> <!-- xyzì—ì„œ ì—°ê²°ìœ„ì¹˜ëŠ” ì¤‘ì‹¬ì—ì„œ xì¶•ìœ¼ë¡œ 10cmì´ë™ -->
<joint name="baseplate_to_back" type="fixed">
    <parent link="baseplate"/>
    <child link="back"/>
    <origin rpy="0 0 3.14" xyz="-0.1 0 0"/> <!-- xyzì—ì„œ ì—°ê²°ìœ„ì¹˜ëŠ” ì¤‘ì‹¬ì—ì„œ xì¶•ìœ¼ë¡œ -10cmì´ë™, ë°©í–¥ì€ zì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ pië§Œí¼ ëŒì•„ì•¼ í•œë‹¤. -->
```

```markdown
link - base_link -\> joint - base_link_to_baseplate -\> link - baseplate  -\> joint - baseplate_to_front -\> link - front 
                                                                          -\> joint - baseplate_to_back -\> link - back
```

<br>

3.RVIZ ì„¤ì • íŒŒì¼(lidar_urdf.rviz)

rviz í”„ë¡œê·¸ë¨ì— ë“¤ì–´ê°€ì„œ add -\> 4ê°œì˜ rangeíƒ€ì…ì„ ì¶”ê°€

<br>

4.ëŸ°ì¹˜ íŒŒì¼(lidar_urdf.launch)

- ë°•ìŠ¤ í˜•ìƒì„ ìœ„í•œ ëª¨ë¸ë§ íŒŒì¼(lidar_urdf.urdf)
- RVIZ ì„¤ì • íŒŒì¼(lidar_urdf.rviz)
- ë¼ì´ë‹¤ í† í”½ ë°œí–‰(lidar_topic.bag)
- rosbagíŒŒì¼ ì‹¤í–‰(`<node pkg="rosbag" type="play" output="screen" ... args="$(find rviz_lidar)/src/lidar_topic.bag"/>`)
- í† í”½ ë³€í™˜(lidar_urdf.py)

```xml
<!-- lidar_urdf.launch -->
<launch>

</launch>
```


<br>

```bash
$ roslaunch rviz_lidar lidar_urdf.launch
```

ì´ë¥¼ ì‹¤í–‰í•˜ë©´ ì›ë¿”ë“¤ì´ ë¬¼ì²´ì™€ì˜ ê±°ë¦¬ì— ë”°ë¼ ì§§ì•„ì¡Œë‹¤ ê¸¸ì–´ì¡Œë‹¤ í•œë‹¤.

<br>

<br>

# ì´ˆìŒíŒŒ ì„¼ì„œ ROS íŒ¨í‚¤ì§€

ì´ˆìŒíŒŒ ì„¼ì„œ : ì¥ì• ë¬¼ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ì´ˆìŒíŒŒë¥¼ ì†¡ìˆ˜ì‹ í•´ì„œ ì•Œë ¤ì£¼ëŠ” ì„¼ì„œë‹¤.

<img src="/assets/img/dev/week4/day4/ultrasonic.jpg">

<br>

ì´ˆìŒíŒŒì„¼ì„œëŠ” ì•„ë‘ì´ë…¸ë¥¼ ê±°ì³ì„œ í”„ë¡œì„¸ìŠ¤ì™€ ì—°ê²°ëœë‹¤. ë…¸ë“œë¡œ ì´ ë‘˜ ì‚¬ì´ë¥¼ í†µì‹ í•œë‹¤.

my_ultraì´ë¦„ì˜ íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•  ê²ƒì´ê³ , í† í”½ì˜ ì´ë¦„ì€ /ultraìœ¼ë¡œ ìƒì„±í•  ê²ƒì´ë‹¤.

í† í”½ì˜ ë‚´ìš©
- íƒ€ì…: sensor_msgs/Int32MultiArray
- êµ¬ì„±
    - std_msgs/MultiArrayLayout layout
        - std_msgs/MultiArrayDimension[] dim
        - string label
        - uint32 size
        - uint32 stride
        - unit32 data_offset
    - int32[] data

```
xycar_ws
  âŠ¢ build
  âŠ¢ devel
  âˆŸ src
      âˆŸ my_ultra
          âŠ¢ launch
              âˆŸ ultra_scan.launch
          âˆŸ src
              âˆŸ ultra_scan.py
```

### íŒ¨í‚¤ì§€ ìƒì„±

- my_ultra ì´ë¦„ì˜ íŒ¨í‚¤ì§€ ìƒì„± / ì„œë¸Œ í´ë” ìƒì„±

```bash
xycar_ws/src$ caktin_create_pkg my_ultra std_msgs rospy
xycar_ws/src$ mkdir launch
xycar_ws/src$ cd launch
xycar_ws/src/launch$ gedit ultra_scan.launch
xycar_ws/src$ cd ../src
```

- ultra_scan.py

ì´ˆìŒíŒŒì„¼ì„œë¡œë¶€í„° ì£¼ë³€ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ê°’ì„ ë°›ì•„ ì¶œë ¥í•˜ëŠ” ì½”ë“œë‹¤.

```python
#!/usr/bin/env python

import rospy
import time

# prepare using Int32MultiArray msg
from std_msgs.msg import Int32MultiArray

# storage space
ultra_msg = None

# define the callback function to implement, if the topic of ultrasound come in
def ultra_callback(data):
    global ultra_msg
    ultra_msg = data.data

# mk node
rospy.init_node("ultra_node")
# define subcriber to receive msg type of Int32MultiArray
rospy.Subcriber("xycar_ultrasonic", Int32MultiArray, ultra_callback)

while not rospy.is_shutdown():
    if ultra_msg == None:
        continue
    
    # print ultrasound data    
    print(ultra_msg)

    # sleep 0.5s
    time.sleep(0.5)
```

- ultra_scan.launch

```xml
<launch>
    <!-- make ultrasonic device run -->
    <node pkg="xycar_ultrasonic" type="xycar_ultrasonic.py"
        name="xycar_ultrasonic" output="screen" />
    
    <!-- implement file we just made -->
    <node pkg="my_ultra" type="ultra_scan.py" name="my_ultra" output="screen" />
</launch>
```

### ì‹¤í–‰

```bash
$ roslaunch my_ultra ultra_scan.launch
```

ì´ 8ê°œì˜ ì •ë³´ê°€ ë“¤ì–´ì˜¬ ê²ƒì´ë‹¤. ì´ëŠ” ìš´ì „ì„ì„ 0ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê³„ë°©í–¥ìœ¼ë¡œ ë²ˆí˜¸ë¥¼ ë§¤ê¸´ë‹¤.

<br>

## ì´ˆìŒíŒŒ ì„¼ì„œì™€ ì•„ë‘ì´ë…¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ROS íŒ¨í‚¤ì§€ ì œì‘

### ì´ˆìŒíŒŒì„¼ì„œ ROS íŒ¨í‚¤ì§€

ì´ˆìŒíŒŒì„¼ì„œë¥¼ ì œì–´í•˜ì—¬ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ì•Œì•„ë‚´ê³  ê·¸ ì •ë³´ë¥¼ ros í† í”½ìœ¼ë¡œ ë§Œë“¤ì–´ ë…¸ë“œë“¤ì—ê²Œ ë³´ë‚¸ë‹¤.

1. ì´ˆìŒíŒŒ ì„¼ì„œ
- ë¬¼ì²´ë¡œ ì´ˆìŒíŒŒë¥¼ ì˜ê³ , ë°˜ì‚¬ëœ ì´ˆìŒíŒŒ ì‹ í˜¸ë¥¼ ê°ì§€
- ì²˜ìŒ ì´ˆìŒíŒŒë¥¼ ìœ ì‹œì ê³¼ ë°˜ì‚¬íŒŒë¥¼ ìˆ˜ì‹ í•œ ì‹œì ì„ í‘œì‹œí•œ ì „ê¸° ì‹ í˜¸ì¸ í„ìŠ¤(pulse) ì‹ í˜¸ë¥¼ ì•„ë‘ì´ë…¸ë¡œ ë³´ëƒ„

2. ì•„ë‘ì´ë…¸
- ì´ˆìŒíŒŒì„¼ì„œê°€ ë³´ë‚´ì¤€ í„ìŠ¤ì‹ í˜¸ë¥¼ ë°›ì•„ ë¶„ì„
- ì´ˆìŒíŒŒë¥¼ ìœ ì‹œì ê³¼ ë°˜ì‚¬íŒŒë¥¼ ë°›ì€ ì‹œì  ì‚¬ì´ì˜ ì‹œê°„ì°¨ë¥¼ ì´ìš©í•´ì„œ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ê³  ì´ë¥¼ rosì— ì•Œë ¤ì¤€ë‹¤.
- serial í†µì‹ ìœ¼ë¡œ rosì— ë³´ë‚¸ë‹¤. ê°„ë‹¨í•˜ê³  ë‹¤ë¥¸ ì†Œí”„íŠ¸ì›¨ì–´ í•„ìš”ì—†ì´ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.

> ì´ì²˜ëŸ¼ ì‘ì€ ë³´ë“œì—ì„œ ëŒì•„ê°€ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ íŒì›¨ì–´ë¼ í•œë‹¤. ëŒ€ì²´ë¡œ cì–¸ì–´ë¡œ ê°œë°œë˜ì–´ ìˆë‹¤.

3. ros
- ì•„ë‘ì´ë…¸ê°€ ë³´ë‚´ì¤€ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê¸° ì¢‹ì€ í˜•íƒœë¡œ ì ì ˆíˆ ê°€ê³µ
- ê·¸ê²ƒì„ ROS í† í”½ì— ë‹´ì•„ ê·¸ê²Œ í•„ìš”í•œ ë…¸ë“œë“¤ì—ê²Œ Publish
- headerë‚˜ 1:n, n:n ë“±ì˜ ë°©ë²•ì„ êµ¬í˜„í•˜ë©´ ëœë‹¤.

<br>

### ì œì‘ì„ ìœ„í•œ 1ë‹¨ê³„ - í•˜ë“œì›¨ì–´ë¥¼ ì´í•´í•˜ì

ì´ˆìŒíŒŒ (ultrasonic wave)
- ì¸ê°„ì˜ ê·€ê°€ ë“¤ì„ ìˆ˜ ìˆëŠ” ê°€ì²­ ì£¼íŒŒìˆ˜ ëŒ€ì—­ë³´ë‹¤ ë†’ì€ ì§„ë™ìˆ˜ë¡œ ë°œìƒí•˜ëŠ” íŒŒë™
- ê°€ì²­ ì§„ë™ìˆ˜ëŠ” ì‚¬ëŒë§ˆë‹¤ ë‹¤ë¥´ì§€ë§Œ ì•½ 20Hz~20kHz

<img src="assets/img/dev/week4/day3/wave.jpg">

- ì´ˆìŒíŒŒ ì„¼ì„œëŠ” ì´ˆìŒíŒŒë¥¼ ì´ìš©í•˜ì—¬ ì„¼ì„œë¡œë¶€í„° ì‚¬ë¬¼ê¹Œì§€ì˜ ì§ì„ ê±°ë¦¬ë¥¼ ì¸¡ì •í•œë‹¤.

ì´ˆìŒíŒŒì„¼ì„œ
- ë¬¼ì²´ë¡œ ì´ˆìŒíŒŒë¥¼ ì˜ê³  ë°˜ì‚¬ëœ ì´ˆìŒíŒŒ ì‹ í˜¸ë¥¼ ê°ì§€
- ì²˜ìŒ ì´ˆìŒíŒŒë¥¼ ìœ ì‹œì ë¶€í„° ë°˜ì‚¬íŒŒë¥¼ ìˆ˜ì‹ í•œ ì‹œì ì„ í‘œì‹œí•œ pulse ì‹ í˜¸ë¥¼ ì•„ë‘ì´ë…¸ì—ê²Œ ë³´ëƒ„

<br>

### ì œì‘ì„ ìœ„í•œ 2ë‹¨ê³„ - ì•„ë‘ì´ë…¸ë¥¼ ì´í•´í•˜ì

ì•„ë‘ì´ë…¸
- ì»´í“¨í„°ê°€ ë‹¤ ì•Œì•„ì„œ í• ë§Œí¼ ì¢‹ì€ ì„±ëŠ¥ì´ë¼ë©´ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
- ì´ˆìŒíŒŒì„¼ì„œê°€ pulse ì‹ í˜¸ë¥¼ ë°›ì•„ ë¶„ì„
- ì´ˆìŒíŒŒë¥¼ ìœ ì‹œì ê³¼ ë°˜ì‚¬íŒŒë¥¼ ë°›ì€ ì‹œì ì˜ ì‹œê°„ì°¨ì´ë¥¼ ì´ìš©í•´ì„œ ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ê³  ì´ë¥¼ ROSì— ì•Œë¦°ë‹¤.

<img src="assets/img/dev/week4/day4/aduino.png">

ê° ì„¼ì„œì˜ Vcc,Trig,Echo,Gnd ë¥¼ ê° í•€ì— ì—°ê²°í•œë‹¤. 
- Vcc : 5V
- Trig : D2
    - ì•„ë‘ì´ë…¸ ì…ì¥ì—ì„œ D2ëŠ” ë°›ëŠ” ê²ƒ
- Echo : D3
    - ì•„ë‘ì´ë…¸ ì…ì¥ì—ì„œ D3ëŠ” ë‚´ë³´ë‚´ëŠ” ê²ƒ
- Gnd : GND

<img src="assets/img/dev/week4/day4/aduino_sonic.png">

ì•„ë‘ì´ë…¸ì˜ íŒì›¨ì–´ë¥¼ ê°œë°œí•˜ëŠ” IDEê°€ ì¡´ì¬í•œë‹¤. ì•„ë‘ì´ë…¸ ì½”ë“œ ì‘ì„±í•  ë•Œë‚˜ ì œì‘ëœ íŒì›¨ì–´ë¥¼ ì•„ë‘ì´ë…¸ì— ì ì„ ë•Œ ì‚¬ìš©í•œë‹¤. 

[ë‹¤ìš´ë¡œë“œ ë§í¬](https://www.arduino.cc/en/software)

ë‹¤ìš´ë¡œë“œë¥¼ í•œ í›„ ì••ì¶•ì„ í’€ì–´ ì•ˆì— ìˆëŠ” install.shë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ëœë‹¤.

```bash
$ sudo ~/Downloads/Arduino-1.8.19-linux64/arduino-1.8.19/install.sh
Adding desktop shortcut, menu item and file associations for Arduino IDE ...
```

ê·¸ ë‹¤ìŒ ì‹¤í–‰

```bash
$ sudo arduino
```

ì‹¤í–‰ì´ ë˜ë©´ `ultrasonic_1_fw.ino` íŒŒì¼ì„ ì‘ì„±í•œë‹¤.

ì´ íŒŒì¼ì˜ ë‚´ìš©ì€ êµ¬ê¸€ë§í•˜ë©´ ë‚˜ì˜¨ë‹¤.

ì†ŒìŠ¤ ì½”ë“œ (ì´ˆìŒíŒŒì„¼ì„œê°€ ë³´ë‚´ëŠ” ì‹ í˜¸ë¡œë¶€í„° ê±°ë¦¬ì •ë³´ ì¶”ì¶œ)

```arduino
/*
HL-340 ì´ˆìŒíŒŒ ì„¼ì„œ ì•„ë‘ì´ë…¸ íŒì›¨ì–´
*/

#define trig 2 // íŠ¸ë¦¬ê±° í•€ ì„ ì–¸
#define echo 3 // ì—ì½” í•€ ì„ ì–¸

void setup()
{
    Serial.begin(9600);     // í†µì‹ ì†ë„ 9600bpsë¡œ ì‹œë¦¬ì–¼ í†µì‹  ì‹œì‘
    pinMode(trig, OUTPUT);  // íŠ¸ë¦¬ê±° í•€ì„ ì¶œë ¥ìœ¼ë¡œ ì„ ì–¸
    pinMode(echo, INPUT);   // ì—ì½”í•€ì„ ì…ë ¥ìœ¼ë¡œ ì„ ì„ 
}

void loop() {
    long duration, dustance;    // ê±°ë¦¬ ì¸¡ì •ì„ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
    // íŠ¸ë¦¬ê±° í•€ìœ¼ë¡œ 10us ë™ì•ˆ í„ìŠ¤ ì¶œë ¥
    digitalWrite(trig, LOW);    // Trig í•€ Low
    delayMicroseconds(2);       // 2us ë”œë ˆì´
    digitalWrite(trig, HIGH);   // Trig í•€ High
    delayMicroseconds(10);      // 2us ë”œë ˆì´
    digitalWrite(trig, LOW);    // Trig í•€ Low

    // pulseln() í•¨ìˆ˜ëŠ” í•€ì—ì„œ í„ìŠ¤ ì‹ í˜¸ë¥¼ ì½ì–´ì„œ ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„ë¡œ ë°˜í™˜
    duration = pulseIn(echo, HIGH);
    distance = duration * 170 / 1000;   // ì™•ë³µì‹œê°„ì´ë¯€ë¡œ 340/2=170 ê³±í•˜ëŠ”ê±¸ë¡œ ê³„ì‚°, ë§ˆì´í¬ë¡œì´ˆë¥¼ mmë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ 1000ë‚˜ëˆ”
    Serial.print("Distance(mm): ");
    Serial.printIn(distance);           // ê±°ë¦¬ì •ë³´ë¥¼ ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°ì— ì¶œë ¥
    delay(100);
}
```

<br>

ì•„ë‘ì´ë…¸ê°€ pcì— ì—°ê²°ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•´ë´ì•¼ í•œë‹¤. ì´ë¥¼ ìœ„í•´ 

```bash
$ lsusb
Bus 004 Device 002: ID 0bc2:231a Seagate RSS LLC 
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 006: ID 2b7e:0134  
Bus 003 Device 005: ID 04e8:730b Samsung Electronics Co., Ltd 
Bus 003 Device 011: ID 04d9:1836 Holtek Semiconductor, Inc. 
Bus 003 Device 016: ID 1a86:7523 QinHeng Electronics HL-340 USB-Serial adapter
```

ë¦¬ìŠ¤íŠ¸ ì¤‘ì— ìì‹ ì˜ ì¥ì¹˜ ë²ˆí˜¸ë¥¼ ì°¾ëŠ”ë‹¤. ë‚˜ì˜ ê²½ìš° HL-340 ì´ë‹¤.

> ì•„ë‘ì´ë…¸ì™€ pcê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ USBì¼€ì´ë¸”ë¡œ ì—°ê²°ë˜ì–´ ìˆìœ¼ë‚˜ ë‚´ë¶€ì ìœ¼ë¡œëŠ” serialí†µì‹ ì´ ì´ë£¨ì–´ì§€ê³  ìˆë‹¤. ë”°ë¼ì„œ ì´ì— ë§ê²Œ serialí†µì‹ ìœ¼ë¡œ ë§ì¶°ì„œ ì§œì•¼ í•œë‹¤. ì´ë¥¼ **Serial over USB**ë¼ í•œë‹¤.

<br>

ì¶œë ¥ì´ ë˜ì—ˆë‹¤ë©´ í•˜ë“œì›¨ì–´ì ìœ¼ë¡œëŠ” í†µì‹ ì´ ë˜ê³  ìˆë‹¤ëŠ” ê²ƒì´ë‹¤. ê·¸ë ‡ë‹¤ë©´ ì•„ë‘ì´ë…¸ì—ì„œ ì—°ê²°ì´ ë˜ê³  ìˆëŠ”ì§€ë„ í™•ì¸í•´ë´ì•¼ í•œë‹¤.

tool ë©”ë‰´ì—ì„œ board/ processor / port í™•ì¸
1. board : arduion Nano
2. processor : ATmega328P
3. Port : /dev/ttyUSB0 ë˜ëŠ” /dev/ttyACM0

ì´ê²ƒì„ ì˜ ì„ íƒí•˜ë©´ ìƒë‹¨ì— v(ì²´í¬)ë¥¼ ëˆŒëŸ¬ ë””ë²„ê¹…ì´ ê°€ëŠ¥í•´ì§„ë‹¤. ê·¸ í›„ ì˜ ë™ì‘ë˜ë©´ ì˜†ì— í™”ì‚´í‘œë¥¼ í´ë¦­í•˜ë©´ ì½”ë“œë¥¼ íŒì›¨ì–´ì— ì—…ë¡œë“œ í•  ìˆ˜ ìˆë‹¤.

ê·¸ í›„ ê°’ì´ ì–´ë–¤ì§€ ë³´ë ¤ë©´ `tools -> serial monitor`ì— ë“¤ì•„ê°€ë©´ ì¶œë ¥ì´ ë  ê²ƒì´ë‹¤.

<img src="/assets/img/dev/week4/day4/aduino_print.png">

<br>

### ì œì‘ì„ ìœ„í•œ 3ë‹¨ê³„ - ë¦¬ëˆ…ìŠ¤ í”„ë¡œê·¸ë˜ë°ì´ í•„ìš”í•˜ë‹¤.

ë¦¬ëˆ…ìŠ¤ ROS
- ì•„ë‘ì´ë…¸ê°€ ë³´ë‚´ì£¼ëŠ” ë¬¼ì²´ê¹Œì§€ì˜ ê±°ë¦¬ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê¸° ì¢‹ì€ í˜•íƒœë¡œ ì ì ˆíˆ ê°€ê³µ
- ROSí† í”½ì— ë‹´ì•„ í•„ìš”í•œ ë…¸ë“œë“¤ì—ê²Œ Publish

<br>

- íŒ¨í‚¤ì§€ ìƒì„±

```
xycar_ws
  âŠ¢ build
  âŠ¢ devel
  âˆŸ src
      âˆŸ ultrasonic
          âŠ¢ launch
              âˆŸ ultra.launch
          âˆŸ src
              âŠ¢ ultrasonic_sub.py
              âˆŸ ultrasonic_pub.py
```

<br>

```bash
íŒ¨í‚¤ì§€ ìƒì„±
$ catkin_create_pkg ultrasonic std_msgs rospy

launch íŒŒì¼ ìƒì„±
ultrasonic$ mkdir launch

ìƒˆë¡œë§Œë“  íŒ¨í‚¤ì§€ ë¹Œë“œ
$ cm
```

<br>

- ì†ŒìŠ¤ì½”ë“œ ìƒì„± (ultrasonic_pub.py)

ì´ˆìŒíŒŒì„¼ì„œê°€ ë³´ë‚¸ ê±°ë¦¬ì •ë³´ë¥¼ í† í”½ì— ë‹´ì•„ publishing

```python
#!/usr/bin/env python

import serial, time, rospy
from std_msgs.msg import Int32

ser_front = serial.Serial( 
    port='/dev/ttyUSB0', # ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ëœ í¬íŠ¸
    baudrate=9600,       # ì•„ë‘ì´ë…¸ì—ì„œ ì„ ì–¸í•œ í†µì‹  ì†ë„
)

def read_sensor():
    serial_data = ser_front.readline() # ì‹œë¦¬ì–¼ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¨ ë°ì´í„°ë¥¼ ë°›ì•„ì˜´
    ser_front.flushInput()  # ì¤‘ê°„ì— ë²„í¼ë“¤ì´ ìˆì–´ì„œ ê·¸ë¥¼ ì‚­ì œí•´ì£¼ëŠ” flush
    ser_front.flushOutput()
    ultrasonic_data = int(filter(str.isdigit, serial_data)) # stringì„ ìˆ«ìë¡œ ë³€í™˜
    msg.data = ultrasonic_data

if __name__ == '__main__':
    rospy.init_node('ultrasonic_pub', anonymous=False)
    pub = rospy.Publisher('ultrasonic', Int32, queue_size= 1)

    msg = Int32()
    
    while not rospy.is_shutdown():
        read_sensor() # ì‹œë¦¬ì–¼í¬íŠ¸ì—ì„œ ì„¼ì„œê°€ ë³´ë‚´ì¤€ ë¬¸ìì—´ ì½ì—‡ê±° ê±°ë¦¬ ì •ë³´ ì¶”ì¶œ
        pub.publish(msg)    
        time.sleep(0.2) # í† í”½ì— ë‹´ì•„ì„œ publish

    ser_front.close() # ëë‚˜ë©´ ì‹œë¦¬ì–¼í¬íŠ¸ ë‹«ê¸°
```

- ì¶”ê°€ë¡œ ê²€ì¦ìš©ìœ¼ë¡œ ì‚¬ìš©í•  subscriber ë…¸ë“œë„ ìƒì„± (ultrasonic_sub.py)

publishì˜ ë©”ì‹œì§€ë¥¼ ë°›ì•„ ì¶œë ¥í•œë‹¤.

```python
#!/usr/bin/env python

import rospy
from std_msgs.msg import Int32

def callback(msg):
    print(msg.data)

rospy.init_node('ultrasonic_sub')
sub = rospy.Subscriber('ultrasonic', Int32, callback)

rospy.spin()
```


- ì‹¤í–‰ì„ ìœ„í•œ launch íŒŒì¼ ë§Œë“¤ê¸°

```xml
<!-- ultra.launch -->
<launch>
    <node pkg="ultrasonic" type="ultrasonic_pub.py" name="ultrasonic_pub"/>
    <node pkg="ultrasonic" type="ultrasonic_sub.py" name="ultrasonic_sub" output="screen"/>
</launch>
```

<br>

- ì‹¤í–‰

```bash
$ roslaunch ultrasonic ultra.launch
```

ì‹¤í–‰í•˜ë©´ ì´ˆìŒíŒŒì„¼ì„œì˜ ë°ì´í„°ê°€ ìˆ«ìë§Œ ì¶œë ¥í•˜ê²Œ ë  ê²ƒì´ë‹¤.

<br>

### ì´ˆìŒíŒŒ ì„¼ì„œ 4ê°œë¥¼ ì§€ì›í•˜ëŠ” ROS íŒ¨í‚¤ì§€ ì œì‘í•˜ê¸°

ì´ˆìŒíŒŒì„¼ì„œ 4ê°œë¥¼ í”„ë¡œì„¸ì„œë³´ë“œë¡œ ì—°ê²°í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë ¤ë©´ íŒì›¨ì–´(ì•„ë‘ì´ë…¸)ë¥¼ ì¡°ì •í•˜ê³ , ROSê´€ì ì—ì„œëŠ” 4ê°œì˜ ë°©í–¥ì´ ìˆìœ¼ë¯€ë¡œ 4ê°œë¥¼ ë°œí–‰í•´ì¤˜ì•¼ í•œë‹¤.

ë…¸ë“œëŠ” `/ultra4_pub`ë¡œ í•˜ê³ , í† í”½ì€ `/ultra4`, ë©”ì‹œì§€ íƒ€ì…ì€ `Int32MultiArray`ë¡œ í•œë‹¤.

<br>

ultrasoinc_fw.inoë¥¼ ìˆ˜ì •í•˜ì—¬ `ultrasonic_4_fw.ino` íŒŒì¼ ì‘ì„±í•œë‹¤. ê° ì„¼ì„œì˜ Vcc,Trig,Echo,Gndë¥¼ ê° í•€ì— ì—°ê²°í•œë‹¤. ê° ì„¼ì„œë¥¼ ì—°ê²°í•˜ì—¬ 5V, Gndë¥¼ ì•„ë‘ì´ë…¸ ë³´ë“œì— ì—°ê²°í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ê°ê° ì•„ë‘ì´ë…¸ ë³´ë“œì— ì—°ê²°í•œë‹¤.

ê±°ë¦¬ì •ë³´ëŠ” `300mm 121mm 186mm 67mm` ì˜ í˜•íƒœë¡œ 4ê°œë¥¼ ì „ì†¡í•œë‹¤.

<br>

ê¸°ì¡´ì— ì‚¬ìš©í–ˆë˜ ultrasonic íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ `ultra4.launch`, `ultra4_pub.py`, `ultra4_sub.py` , 3ê°œì˜ íŒŒì¼ì„ ìƒì„±í•œë‹¤. 

- ultra4_pub.py

ì´ˆìŒíŒŒ ì„¼ì„œê°€ ë³´ë‚¸ ê±°ë¦¬ì •ë³´ë¥¼ í† í”½ì— ë‹´ì•„ publishingí•œë‹¤

1. ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ëœ í¬íŠ¸ ì§€ì • (usb í¬íŠ¸ëŠ” ë¦¬ëˆ…ìŠ¤ê°€ ê´€ë¦¬í•˜ê¸°ì— ë¦¬ëˆ…ìŠ¤ì—ê²Œ ìš”ì²­)
2. def read_sensor() ìƒì„±(ì‹œë¦¬ì–¼ ë°ì´í„° í•œë²ˆì— ë¬¸ìì—´ë¡œ ë°›ì•„ì˜¤ê³  ë¬¸ìì—´ì—ì„œ ìˆ«ì 4ê°œë¥¼ ì¶”ì¶œí•˜ì—¬ ë¦¬ìŠ¤íŠ¸ì— ë‹´ëŠ”ë‹¤.)
3. mainí•¨ìˆ˜ (ultra4_pub ë…¸ë“œ ìƒì„±, ultra4 í† í”½ ë°œí–‰, whileë¬¸(ì•„ë‘ì´ë…¸ì—ê²Œ ì •ë³´ë¥¼ ë°›ì•„ì™€ì„œ í† í”½ì•ˆì— ì˜ ì±„ì›Œë„£ì–´ í† í”½ì„ ë°œí–‰), ì‹œë¦¬ì–¼ì„ ë‹«ê³  ì •ë¦¬)

```python
import Serial
...

FRONT = [0,0,0,0]

ser_front = serial.Serial(  # ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ëœ í¬íŠ¸ ì§€ì •
    port='/dev/ttyUSB0',
    baudrate=9600,
)

def read_sensor():
    sersor_data = ser_front.readline()
    ser_front.flushInput()
    ser_front.flushOutput()
    FRONT = read_Sdata(sensor_data)
    msg.data = FRONT

def read_Ssdata(s):
    s = s.replace(" ", "")
    s_data = s.split("mm")
    s_data.remove('\r\n')
    s_data = list(map(int,s_data))
    return s_data
if __name__ == '__main__':
    ...
    ser_front.close()
```

<br>

- ultra4_sub.py

publisherì˜ ë©”ì‹œì§€ë¥¼ ë°›ì•„ ì¶œë ¥í•œë‹¤.

1. í† í”½ì—ì„œ ë°ì´í„°ë¥¼ êº¼ë‚´ì„œ ì¶œë ¥
2. ultra4_sub ë…¸ë“œ ìƒì„±
3. ultra4 í† í”½ êµ¬ë… ì¤€ë¹„
4. ultra4 í† í”½ì„ ë°›ìœ¼ë©´ callback í˜¸ì¶œ
5. ë¬´í•œ ë£¨í”„

```python
#!/usr/bin/env python

import rospy
from std_msgs.msg import Int32

def callback(msg):
    print(msg.data)

rospy.init_node('ultrasonic_sub')
sub = rospy.Subscriber('ultrasonic', Int32, callback)

rospy.spin()
```

<br>

- ultra4.launch

1. í† í”½ì˜ ë°œí–‰ì ì‹¤í–‰
2. í† í”½ì˜ êµ¬ë…ì ì‹¤í–‰

```xml
<launch>
    <node pkg="ultrasonic" type="ultrasonic_pub.py" name="ultrasonic_pub"/>
    <node pkg="ultrasonic" type="ultrasonic_sub.py" name="ultrasonic_sub" output="screen"/>
</launch> 
```

<br>

ì‹¤í–‰

1. ì—°ê²° í™•ì¸

```bash
$ lsusb
~~~~~~ HL-340 USB~~~
```

2. íŒì›¨ì–´ í”„ë¡œê·¸ë˜ë°

```bash
$ sudo arduino
```

3. ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ëœ ë¦¬ëˆ…ìŠ¤ í¬íŠ¸ í™•ì¸

toolsë©”ë‰´ì—ì„œ Board/Processor Portë¥¼ ì²´í¬í•´ì•¼ í•œë‹¤.

- board : Arduino Nano
- Processor : Atmega328P
- Port : /dev/ttyUSB0 or /dev/ttyACM0

4. ì•„ë‘ì´ë…¸ íŒì›¨ì–´ ì†ŒìŠ¤ì½”ë“œ

ì´ˆìŒíŒŒì„¼ì„œê°€ ë³´ë‚´ëŠ” ì‹ í˜¸ë¡œë¶€í„° ê±°ë¦¬ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ì†ŒìŠ¤ì½”ë“œë‹¤.

```arduino
int trig[4] = {2,4,6,8}; // ì„¼ì„œë¥¼ ê¼½ì•˜ë˜ í¬íŠ¸ ë²ˆí˜¸
int echo[4] = {3,5,7,9}; //
int i=0;

void setup() {
    Serial.begin(9600);
    for(i=0;i<4;i++) {
        pinMode(trig[i],OUTPUT);    // TRIG í•€ì„ ì¶œë ¥ëª¨ë“œë¡œ ì„¸íŒ…
        pinMode(echo[i], INPUT);    // ECHO í•€ì„ ì…ë ¥ëª¨ë“œë¡œ ì„¸íŒ…
    }
}

void loop() {
    long dur[4]={0.0,};
    long dist[4]={0.0,};

    for(i=0; i<4; i++) {
        digitalWrite(trig[i],LOW);
        delayMicroseconds(2);
        digitalWrite(trig[i],HIGH);         // trig ì‹ í˜¸ë¥¼ high ìƒíƒœë¡œ ë³€ê²½
        delayMicroseconds(10);              // 10ë§ˆì´í¬ë¡œì´ˆ ëŒ€ê¸°
        digitalWrite(trig[i],LOW);          // Trig ì‹ í˜¸ë¥¼ low ìƒíƒœë¡œ ë³€ê²½

        dur[i] = pulseIn(echo[i],HIGH);     // Echo í„ìŠ¤ì—ì„œ ì™•ë³µì‹œê°„ì„ ê³„ì‚°í•´ì„œ ì €ì¥
        dist[i] = dur[i]*170/1000;          // ì‹œê°„ì„ ì´ë™ê±°ë¦¬ë¡œ í™˜ì‚°í•´ì„œ ì €ì¥
        if(dist[i]>=2000 || dist[i]<0) {    // ê±°ë¦¬ê°€ 200cmì´ìƒì´ê±°ë‚˜ 0ë³´ë‹¤ ì‘ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
            dist[i]=0;
        }
    }

    Serial.print(dist[0]); //dist[0] ì¶œë ¥
    Serial.print("mm ");
    Serial.print(dist[1]);
    Serial.print("mm ");
    Serial.print(dist[2]);
    Serial.print("mm ");
    Serial.print(dist[3]);
    Serial.print("mm ");

    delay(50);
}
```

5. ì»´íŒŒì¼ & ì—…ë¡œë“œ

ì»´íŒŒì¼ ë° ì—…ë¡œë“œë¥¼ ì§„í–‰í•œë‹¤.

6. ê²°ê³¼ í™•ì¸

ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°ë¥¼ ì´ìš©í•´ì„œ ì•„ë‘ì´ë…¸ì˜ ì¶œë ¥ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. tools -\> serial Monitor

7. ì‹¤í–‰

```bash
$ roslaunch ultrasonic ultra4.launch
```

