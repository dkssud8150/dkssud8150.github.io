---
title:    " [ROS2 í”„ë¡œê·¸ë˜ë°] ROS íŒ¨í‚¤ì§€ ì„¤ê³„ (C++) "
author:
  name: JaeHo YooN
  link: https://github.com/dkssud8150
date: 2022-07-27 00:23:00 +0800
categories: [Classlog, ROS2]
tags: [ROS2]
toc: True
comments: True
--- 

&nbsp;

# ROS íŒ¨í‚¤ì§€ ì œì‘

- [034 ROS2 íŒ¨í‚¤ì§€ ì„¤ê³„ (C++)](https://cafe.naver.com/openrt/24798)
- [035 í† í”½ í”„ë¡œê·¸ë˜ë° (C++)](https://cafe.naver.com/openrt/24802)

## ROS íŒ¨í‚¤ì§€ ì„¤ê³„

<img src="/assets/img/ros2/package/package_configure.png">

ëª©ì ë³„ë¡œ ë‚˜ëˆ„ì–´ ë…¸ë“œ ë‹¨ìœ„ì˜ í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ê³ , ë…¸ë“œì™€ ë…¸ë“œê°„ì˜ ë°ì´í„° í†µì‹ ì„ ì„¤ê³„í•´ì•¼ í•œë‹¤. ì´ë²ˆ ì˜ˆì œ íŒ¨í‚¤ì§€ëŠ” í† í”½, ì„œë¹„ìŠ¤, ì•¡ì…˜ìœ¼ë¡œ êµ¬ì„±í•˜ê³ ì í•œë‹¤. 

ì´ 4ê°œì˜ ë…¸ë“œë¡œ êµ¬ì„±ë˜ë©°, ê° ë…¸ë“œì—ì„œëŠ” 1ê°œ ì´ìƒì˜ í† í”½ í¼ë¸”ë¦¬ì…”, í† í”½ ì„œë¸ŒìŠ¤í¬ë¼ì´ë¸Œ, ì„œë¹„ìŠ¤ ì„œë²„, ì„œë¹„ìŠ¤ í´ë¼ì´ì–¸íŠ¸, ì•¡ì…˜ ì„œë²„, ì•¡ì…˜ í´ë¼ì´ì–¸íŠ¸ê°€ ì¡´ì¬í•œë‹¤. ì¤‘ì•™ì— ìˆëŠ” ë…¸ë“œëŠ” ë‹¤ë¥¸ ë…¸ë“œë“¤ê³¼ì˜ ì—°ë™ì„ í•´ì•¼ í•˜ë¯€ë¡œ ê°€ì¥ í•µì‹¬ì ì¸ ì—­í• ì´ë‹¤.

ê°ê°ì˜ ë…¸ë“œ, í† í”½, ì„œë¹„ìŠ¤, ì•¡ì…˜ì€ ê³ ìœ ì˜ ì´ë¦„ì„ ê°€ì§€ê³  ìˆë‹¤.

- `argument` : *arithmetic_argument* **í† í”½** ì´ë¦„ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ê³¼ ë³€ìˆ˜ a,bë¥¼ **í¼ë¸”ë¦¬ì‹œ**í•œë‹¤.
- `operator` : *arithmetic_operator* **ì„œë¹„ìŠ¤** ì´ë¦„ìœ¼ë¡œ calculator ë…¸ë“œì—ê²Œ ì—°ì‚°ì(+-*/)ë¥¼ **ì„œë¹„ìŠ¤** ìš”ì²­ê°’ìœ¼ë¡œ ë³´ë‚¸ë‹¤.
- `calculator`
    - **í† í”½**ì´ ìƒì„±ëœ ì‹œê°„ê³¼ ë³€ìˆ˜ a,bë¥¼ *arithmetic_argument* ì´ë¦„ì˜ í† í”½ì„ **ì„œë¸ŒìŠ¤í¬ë¼ì´ë¸Œ**í•œë‹¤.
    - ë°›ì€ ë³€ìˆ˜ a,bì™€ operator ë…¸ë“œë¡œë¶€í„° ìš”ì²­ê°’ìœ¼ë¡œ ë°›ì€ ì—°ì‚°ìë¥¼ í†µí•´ **ê³„ì‚°**í•˜ê³ (a ì—°ì‚°ì b), operator ë…¸ë“œì—ê²Œ ê²°ê´ê°’ì„ *arithmetic_operator* ì´ë¦„ìœ¼ë¡œ **ì„œë¹„ìŠ¤ ì‘ë‹µê°’**ì„ ë³´ë‚¸ë‹¤.
    - checker ë…¸ë“œë¡œë¶€í„° **ì•¡ì…˜ ëª©í‘œê°’**(â‘  action goal)ì„ ë°›ì€ í›„ë¶€í„° ì €ì¥ëœ ë³€ìˆ˜(a,b,ì—°ì‚°ì)ë¥¼ ê°€ì§€ê³  ì—°ì‚°í•œ ê°’ì„ í•©í•œë‹¤. ê·¸ë¦¬ê³  ì—°ì‚°ì´ ëë‚œ ê³„ì‚°ì‹ì„ *arithmetic_checker* ì´ë¦„ìœ¼ë¡œ **ì•¡ì…˜ í”¼ë“œë°±**(â‘¡ action feedback)ì„ checker ë…¸ë“œë¡œ ë³´ë‚¸ë‹¤. ì—°ì‚°ê°’ì˜ í•©ì´ ì•¡ì…˜ ëª©í‘œê°’ì„ ë„˜ê¸°ë©´ ìµœì¢… ì—°ì‚° í•©ê³„ë¥¼ *arithmetic_checker* ì´ë¦„ìœ¼ë¡œ **ì•¡ì…˜ ê²°ê´ê°’**(â‘¢ action result)ì„ checker ë…¸ë“œë¡œ ë³´ë‚¸ë‹¤.
- `checker` : ì—°ì‚°ê°’ì˜ í•©ê³„ì˜ **í•œê³„ì¹˜**ë¥¼ *arithmetic_checker* **ì•¡ì…˜** ì´ë¦„ìœ¼ë¡œ **ì•¡ì…˜** ëª©í‘œê°’ìœ¼ë¡œ **ì „ë‹¬**í•œë‹¤.

&nbsp;

&nbsp;

## ROS íŒ¨í‚¤ì§€ ì„¤ì •

ğŸ”¥ ì£¼ì˜ : ì•„ë˜ íŒŒì¼ë“¤ì€ ì½”ë“œë¥¼ ì„¤ëª…í•˜ê¸° ìœ„í•´ì„œë§Œ ë³´ê³ , ì¶”í›„ git cloneì„ ìˆ˜í–‰í•  ì˜ˆì •ì´ë¯€ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì§ì ‘ ìƒì„±í•˜ì§€ ì•Šê¸°ë¥¼ ë°”ë€ë‹¤. ë§Œì•½ íŒ¨í‚¤ì§€ë¥¼ ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ìƒì„±í•  ê²½ìš° ë¹Œë“œì— ë¬¸ì œê°€ ìƒê¸°ë¯€ë¡œ, ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ê±°ë‚˜, cloneí•œ ê²ƒì„ ì‚¬ìš©í•˜ê¸¸ ë°”ë€ë‹¤.

&nbsp;

- package.xml

```xml
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?>

<!-- ROS2 íŒ¨í‚¤ì§€ ì„¤ì •íŒŒì¼ì˜ package formatì´ ì„¸ë²ˆì§¸ ë²„ì „ì´ë¯€ë¡œ 3 -->
<package format="3">
  <!-- íŒ¨í‚¤ì§€ ì´ë¦„ -->
  <name>topic_service_action_rclcpp_example</name>
  <version>0.2.0</version>

  <!-- ì„¤ëª… -->
  <description>ROS 2 rclcpp example package for the topic, service, action</description> 
  <maintainer email="jhyoon@todo.todo">jhyoon</maintainer>
  <!-- ë¼ì´ì„ ìŠ¤ -->
  <license>Apache License 2.0</license>
  <author email="passionvirus@gmail.com">Pyo</author>
  <author email="routiful@gmail.com">Darby Lim</author>

  <!-- ë¹Œë“œíˆ´ : ament_cmake -->
  <buildtool_depend>ament_cmake</buildtool_depend>

  <!-- dependency -->
  <!-- ros2ì—ì„œ ì‚¬ìš©í•˜ëŠ” cppíˆ´ -->
  <depend>rclcpp</depend>
  <!-- cppíˆ´ì—ì„œ action ì‚¬ìš©í•˜ê¸° ìœ„í•¨ -->
  <depend>rclcpp_action</depend>
  <!-- í† í”½,ì„œë¹„ìŠ¤,ì•¡ì…˜ ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ -->
  <depend>msg_srv_action_interface_example</depend>

  <!-- ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” Lint íŒ¨í‚¤ì§€, í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ìœ„í•œ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ -->
  <test_depend>ament_lint_auto</test_depend>
  <test_depend>ament_lint_common</test_depend>

  <export>
    <!-- build type : ament_cmake -->
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

&nbsp;

- CMakeLists.txt

CMakelistì—ëŠ” í¬ê²Œ cmake ì„¤ì •, ì˜ì¡´ì„± ëª…ì‹œ, ë¹Œë“œ, ì„¤ì¹˜, í…ŒìŠ¤íŠ¸, ament package ë§¤í¬ë¡œ ì„¤ì •ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤.

```cpp
# Set minimum required version of cmake, project name and compile options
cmake_minimum_required(VERSION 3.5)

# project name
project(topic_service_action_rclcpp_example)

# Cì–¸ì–´ì˜ ë²„ì „ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ C99ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©
if(NOT CMAKE_C_STANDARD)
  set(CMAKE_C_STANDARD 99)
endif()

# C++ì˜ ë²„ì „ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ C++ 14ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

# GNUë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ë§Œ, Clang ì»´íŒŒì¼ëŸ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# Find dependencies
# REQUIRED : íŒ¨í‚¤ì§€ë¥¼ ì°¾ê³ , ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚˜ë„ë¡ í•˜ëŠ” ì˜µì…˜
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(msg_srv_action_interface_example REQUIRED)
find_package(rclcpp_action REQUIRED)

# header íŒŒì¼ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ë””ë ‰í† ë¦¬
include_directories(include)

# Build
# ì‹¤ì œë¡œ ì‹¤í–‰í•˜ëŠ” íŒŒì¼ (node_name file_directory)
add_executable(argument src/arithmetic/argument.cpp)
# í”„ë¡œê·¸ë¨ ì‹¤í–‰ì„ ìœ„í•´ í•„ìš”í•œ ì˜ì¡´ì„± íŒ¨í‚¤ì§€
ament_target_dependencies(argument
  msg_srv_action_interface_example
  rclcpp
)

add_executable(calculator src/calculator/main.cpp src/calculator/calculator.cpp)
# calculatorì—ì„œëŠ” actionë„ ì§„í–‰ë˜ê¸°ì— ì˜ì¡´ì„± íŒ¨í‚¤ì§€ì— ì¶”ê°€
ament_target_dependencies(calculator
  msg_srv_action_interface_example
  rclcpp
  rclcpp_action
)

add_executable(checker src/checker/main.cpp src/checker/checker.cpp)
ament_target_dependencies(checker
  msg_srv_action_interface_example
  rclcpp
  rclcpp_action
)

add_executable(operator src/arithmetic/operator.cpp)
ament_target_dependencies(operator
  msg_srv_action_interface_example
  rclcpp
)

# Install
install(TARGETS
  argument
  calculator
  checker
  operator
  DESTINATION lib/${PROJECT_NAME}
)

# ì—¬ê¸°ì„œ ë³¼ ìˆ˜ ìˆë“¯ launch ì™€ paramì€ share í´ë” ì•„ë˜ì— ì €ì¥í•´ì•¼ í•œë‹¤.
install(DIRECTORY launch param
  DESTINATION share/${PROJECT_NAME}
)

# Test
# testì‹œ í•„ìš”í•œ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤, ì¶”í›„ testì‹œ colcon test ë¥¼ í†µí•´ ì‚¬ìš© ê°€ëŠ¥
# ament_lint_auto_find_test_dependenicesë¥¼ í†µí•´ cpplintë¼ëŠ” ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ì ê²€í•´ì£¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©
if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  ament_lint_auto_find_test_dependencies()
endif()

# Macro for ament package
# ament íŒ¨í‚¤ì§€ë¥¼ ìœ„í•œ ë§¤í¬ë¡œ í•¨ìˆ˜ë¥¼ ì ì–´ì£¼ì–´ì•¼ í•¨
ament_package()
```

&nbsp;

&nbsp;

## ì½”ë“œ ë‹¤ìš´ë¡œë“œ ë° ë¹Œë“œ

`source ~/robot_ws/install/local_setup.bash`ëŠ” ~/.bashrcì— ì—†ìœ¼ë©´ ì¶”ê°€í•˜ê³ , ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

```bash
$ cd ~/robot_ws/src
$ git clone https://github.com/robotpilot/ros2-seminar-examples.git
$ cd ~/robot_ws && colcon build --symlink-install
Starting >>> msg_srv_action_interface_example
Starting >>> logging_rclpy_example
Finished <<< logging_rclpy_example [1.26s]
Starting >>> my_first_ros_rclcpp_pkg
Finished <<< my_first_ros_rclcpp_pkg [13.8s]
Starting >>> my_first_ros_rclpy_pkg
...

$ echo 'source ~/robot_ws/install/local_setup.bash' >> ~/.bashrc
$ source ~/.bashrc

$ . ~/robot_ws/install/local_setup.bash
```

`. ~/robot_ws/install/local_setup.bash` ë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ íŒ¨í‚¤ì§€ë¥¼ ì°¾ì§€ ëª»í•œë‹¤ëŠ” ì—ëŸ¬ê°€ ëœ¨ë‹ˆ ì£¼ì˜í•˜ì.

&nbsp;

ë¹Œë“œê°€ ëë‚˜ê³ , ë¬¸ì œê°€ ì—†ë‹¤ë©´ `~/robot_ws/install/topic_service_action_rclcpp_example` í´ë” ì•ˆì— ìš°ë¦¬ê°€ ì‘ì„±í•œ ROS ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ íŒŒì¼ë“¤ì´ ì €ì¥ë  ê²ƒì´ë‹¤.

```bash
$ ls ~/robot_ws/install
COLCON_IGNORE             logging_rclpy_example             rqt_example          tf2_rclpy_example
local_setup.bash          msg_srv_action_interface_example  setup.bash           time_rclcpp_example
local_setup.ps1           my_first_ros_rclcpp_pkg           setup.ps1            time_rclpy_example
local_setup.sh            my_first_ros_rclpy_pkg            setup.sh             topic_service_action_rclcpp_example
_local_setup_util_ps1.py  rclcpp_tutorial                   setup.zsh            topic_service_action_rclpy_example
_local_setup_util_sh.py   rclpy_tutorial                    testbot_description
local_setup.zsh           ros2env                           tf2_rclcpp_example


$ ls ~/robot_ws/install/topic_service_action_rclcpp_example/lib/topic_service_action_rclcpp_example/
argument    calculator  checker     operator

$ ls ~/robot_ws/install/topic_service_action_rclcpp_example/share/topic_service_action_rclcpp_example/
cmake/            launch/           local_setup.sh    package.dsv       package.xml
environment/      local_setup.bash  local_setup.zsh   package.ps1       package.zsh
hook/             local_setup.dsv   package.bash      package.sh        param/
```

ì´ì™€ ê°™ì´ argument, operator, calculator, checkerì™€ ê°™ì€ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ê°€ ìƒì„±ë˜ì—ˆë‹¤. ê·¸ë¦¬ê³  share í´ë” ì•ˆì—ëŠ” launchí´ë”ì™€ param í´ë”ê°€ ìƒì„±ë˜ì—ˆê³ , ê° í´ë” ì•ˆì—ëŠ” arithmetic.launch.pyì™€ arithmetic_config.yamlê°€ ìœ„ì¹˜í•œë‹¤.

```bash
$ ls ~/robot_ws/install/topic_service_action_rclcpp_example/share/topic_service_action_rclcpp_example/launch/
arithmetic.launch.py

$ ls ~/robot_ws/install/topic_service_action_rclcpp_example/share/topic_service_action_rclcpp_example/param/
arithmetic_config.yaml
```

&nbsp;

&nbsp;

## ì‹¤í–‰

- calculator ë…¸ë“œ ì‹¤í–‰

ì´ ë…¸ë“œëŠ” í† í”½ ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„, ì„œë¹„ìŠ¤ ì„œë²„, ì•¡ì…˜ ì„œë²„ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.

```bash
$ ros2 run topic_service_action_rclcpp_example calculator
[INFO]: Run calculator
```

ì‹¤í–‰í–ˆì§€ë§Œ, ì•„ì§ ë°›ëŠ” í† í”½ì´ë‚˜ ì„œë¹„ìŠ¤, ì•¡ì…˜ì´ ì—†ìœ¼ë¯€ë¡œ ë™ì‘ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤.

&nbsp;

- argument ë…¸ë“œ ì‹¤í–‰

ì´ ë…¸ë“œëŠ” í† í”½ í¼ë¸”ë¦¬ì…” ì—­í• ì„ í•œë‹¤. ì´ë¥¼ ì‹¤í–‰í•˜ë©´ í¼ë¸”ë¦¬ì‹œí•˜ê³  ìˆëŠ” argument a, argument bê°€ í‘œì‹œë  ê²ƒì´ê³ , ì´ë¥¼ í†µí•´ calculator ë…¸ë“œì—ì„œëŠ” argument a, argument bì™€ í•¨ê»˜ ìˆ˜ì‹  ë°›ì€ ì‹œê°„ ì •ë³´ê°€ ì¶œë ¥ë  ê²ƒì´ë‹¤.

```bash
$ ros2 run topic_service_action_rclcpp_example argument
[INFO]: Published argument_a 4.73
[INFO]: Published argument_b 7.43
[INFO]: Published argument_a 1.55
[INFO]: Published argument_b 6.38
[INFO]: Published argument_a 7.09
[INFO]: Published argument_b 5.89
[INFO]: Published argument_a 5.90
[INFO]: Published argument_b 8.21
```

```bash
ros2 run  topic_service_action_rclcpp_example calculator
[INFO]: Run calculator
[INFO]: Timestamp of the message: sec 1658859718 nanosec 500974826
[INFO]: Subscribed argument a: 4.73
[INFO]: Subscribed argument b: 7.43
[INFO]: Timestamp of the message: sec 1658859719 nanosec 500985640
[INFO]: Subscribed argument a: 1.55
[INFO]: Subscribed argument b: 6.38
[INFO]: Timestamp of the message: sec 1658859720 nanosec 501005719
[INFO]: Subscribed argument a: 7.09
[INFO]: Subscribed argument b: 5.89
[INFO]: Timestamp of the message: sec 1658859721 nanosec 500910222
[INFO]: Subscribed argument a: 5.90
[INFO]: Subscribed argument b: 8.21
[INFO]: Timestamp of the message: sec 1658859722 nanosec 501017918
[INFO]: Subscribed argument a: 2.57
[INFO]: Subscribed argument b: 8.50
[INFO]: Timestamp of the message: sec 1658859723 nanosec 500904549
[INFO]: Subscribed argument a: 4.43
[INFO]: Subscribed argument b: 4.86
```

&nbsp;

- operator ë…¸ë“œ ì‹¤í–‰

ì´ ë…¸ë“œëŠ” ì„œë¹„ìŠ¤ í´ë¼ì´ì–¸íŠ¸ ì—­í• ì„ í•œë‹¤. calculator ë…¸ë“œì—ê²Œ ëœë¤ìœ¼ë¡œ ì„ íƒí•œ ì—°ì‚°ìë¥¼ ì„œë¹„ìŠ¤ ìš”ì²­ê°’ìœ¼ë¡œ ë³´ë‚´ê³ , ì—°ì‚°ëœ ê²°ê³¼ê°’ì„ ë°›ì•„ í„°ë¯¸ë„ ì°½ì— í‘œì‹œí•œë‹¤. ì‹¤ì œ ê³„ì‚°ì‹ì€ calculator ë…¸ë“œê°€ ì‹¤í–‰ ì¤‘ì¸ ì°½ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
$ ros2 run topic_service_action_rclcpp_example operator
[INFO]: Result 13.79
Press Enter for next service call.
[INFO]: Result 9.57
Press Enter for next service call.
[INFO]: Result 0.30
Press Enter for next service call.
[INFO]: Result 0.71
Press Enter for next service call.
```

```bash
$ ros2 run topic_service_action_rclcpp_example calculator
[INFO]: 2.224688 + 7.350139 = 9.57483
[INFO]: 2.224688 / 7.350139 = 0.302673

[INFO]: Timestamp of the message: sec 1658859884 nanosec 500955814
[INFO]: Subscribed argument a: 5.25
[INFO]: Subscribed argument b: 7.38
[INFO]: 5.247090 / 7.383574 = 0.710644
[INFO]: 5.247090 / 7.383574 = 0.710644
```

Entor í‚¤ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.

&nbsp;

- checker ë…¸ë“œ ì‹¤í–‰

ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ë…¸ë“œëŠ” ë¨¼ì € ì—°ì‚°ê°’ì˜ í•©ê³„ í•œê³„ì¹˜ë¥¼ ì•¡ì…˜ ëª©í‘œê°’ìœ¼ë¡œ calculator ë…¸ë“œì— ì „ë‹¬í•œë‹¤. ì´í›„ checker ë…¸ë“œëŠ” calculator ë…¸ë“œì—ê²Œ ì•¡ì…˜ í”¼ë“œë°±ì„ ë°›ëŠ”ë°, ê·¸ í”¼ë“œë°±ì€ ê° ì—°ì‚°ê³¼ ê·¸ ê²°ê³¼ì˜ stringíƒ€ì…ì´ë‹¤. ì§€ì •í•œ ì—°ì‚°ê°’ì˜ í•©ê³„ê°€ ëª©í‘œ í•©ê³„ë¥¼ ë„˜ê¸°ë©´ checker ë…¸ë“œëŠ” ì•¡ì…˜ ê²°ê³¼ê°’ìœ¼ë¡œ calculator ë…¸ë“œë¡œë¶€í„° ìµœì¢… ì—°ì‚° í•©ê³„ë¥¼ ì „ë‹¬ë°›ëŠ”ë‹¤.

```bash
$ ros2 run topic_service_action_rclcpp_example checker
goal_total_sum : 50
[INFO]: Action goal accepted.
[INFO]: Action feedback:
[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]: Action feedback:
[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]: Action feedback:
[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]: Action feedback:
[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644
```

```bash
$ ros2 run topic_service_action_rclcpp_example calculator
[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644

[INFO]:         5.247090 / 7.383574 = 0.710644
```

ë™ì¼í•œ loggingì´ ì¶œë ¥ë˜ëŠ”ë°, ì´ëŠ” ëª©í‘œ í•©ê³„ë¥¼ ë„˜ê²¼ì„ ë•Œ,  calculator ë…¸ë“œê°€ checker ë…¸ë“œì—ê²Œ ìµœì¢… ì—°ì‚° í•©ê³„ë¥¼ ì „ë‹¬í•˜ê¸° ë•Œë¬¸ì´ë‹¤. í•©ê³„ì˜ í•œê³„ì¹˜ëŠ” ê¸°ë³¸ìœ¼ë¡œ 50ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤. ì´ë¥¼ ìˆ˜ì •í•˜ê³ ì í•œë‹¤ë©´ checker ë…¸ë“œë¥¼ ì‹¤í–‰ì‹œí‚¬ ë•Œ ì‹¤í–‰ ì¸ìë¡œ `-g 100` ì´ë¼ ì…ë ¥í•˜ë©´ GOAL_TOTAL_SUM  ì´ë¼ëŠ” í•©ê³„ í•œê³„ì¹˜ ì¸ìê°€ 100ìœ¼ë¡œ í• ë‹¹ëœë‹¤.

```bash
ros2 run topic_service_action_rclcpp_example checker -g 100
```

&nbsp;

- launch íŒŒì¼ ì‹¤í–‰

launch íŒŒì¼ì„ í†µí•´ argument ë…¸ë“œì™€ calculator ë…¸ë“œë¥¼ í•œë²ˆì— ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤. launchíŒŒì¼ì€ `arithmetic.launch.py` íŒŒì¼ì´ë‹¤.

```bash
ros2 launch topic_service_action_rclcpp_example arithmetic.launch.py
```

&nbsp;

&nbsp;

## ROS í† í”½ ëœ¯ì–´ë³´ê¸°

ì´ì œëŠ” ìœ„ì˜ íŒ¨í‚¤ì§€ì—ì„œ í† í”½ì— ëŒ€í•´ ë” ìì„¸íˆ ëœ¯ì–´ë³´ê³ ì í•œë‹¤. 

&nbsp;

í† í”½ì€ ë¹„ë™ê¸°ì‹ ë‹¨ë°©í–¥ ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  ë°©ì‹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ëŠ” í¼ë¸”ë¦¬ì…”ì™€ ë©”ì‹œì§€ë¥¼ êµ¬ë…í•˜ëŠ” ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ ê°„ì˜ í†µì‹ ì´ë‹¤. ì´ëŠ” 1:1 í†µì‹ ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ì§€ë§Œ, 1:N, N:1, N:Në„ ê°€ëŠ¥í•˜ë‹¤.

ìœ„ì—ì„œ í† í”½ì€ argument ë…¸ë“œì—ì„œ calculator ë…¸ë“œë¡œì˜ argument a, argument b, í† í”½ì„ ìƒì„±í•œ ì‹œê°„ì— ëŒ€í•œ ë©”ì‹œì§€ ì „ë‹¬ì´ë‹¤.

<img src="/assets/img/ros2/package/topic.png">

&nbsp;

ë”°ë¼ì„œ í¼ë¸”ë¦¬ì…”ì™€ ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ë¥¼ ì§ì ‘ ì‘ì„±í•´ë³´ê³ ì í•œë‹¤.

ì½”ë“œëŠ” ì†ŒìŠ¤ íŒŒì¼ê³¼ í—¤ë” íŒŒì¼ì´ ì¡´ì¬í•˜ê³ , ê°ê° src í´ë”ì™€ include í´ë”ì— ìœ„ì¹˜í•œë‹¤.

í¼ë¸”ë¦¬ì…”
- topic_service_action_rclcpp_example/src/arithmetic/argument.cpp
- topic_service_action_rclcpp_example/include/arithmetic/argument.hpp

&nbsp;

ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„
- topic_service_action_rclcpp_example/src/arithmetic/argument.cpp
- topic_service_action_rclcpp_example/include/arithmetic/argument.hpp

&nbsp;

### í¼ë¸”ë¦¬ì…”

í† í”½ í¼ë¸”ë¦¬ì…” ë…¸ë“œëŠ” argument ë…¸ë“œì´ë‹¤.

1. Node ì„¤ì •
2. QoS ì„¤ì •
3. create_publisher ì„¤ì • (timer ì„¤ì •)
4. í¼ë¸”ë¦¬ì‹œ í•¨ìˆ˜ ì‘ì„±

&nbsp;

- í—¤ë” íŒŒì¼

```cpp
#ifndef ARITHMETIC__ARGUMENT_HPP_
#define ARITHMETIC__ARGUMENT_HPP_

// ì‹œê°„ì„ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <chrono>

// ë™ì  ë©”ëª¨ë¦¬ë¥¼ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <memory>

// ë¬¸ìì—´ì„ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <string>

// ì„œë¡œë‹¤ë¥¸ ë„ë©”ì¸ì„ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <utility>

// rclcpp APIë¥¼ ë‹´ê³  ìˆëŠ” rclcpp í—¤ë”íŒŒì¼
#include "rclcpp/rclcpp.hpp"

// ë§Œë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‹´ê³  ìˆëŠ” í—¤ë”íŒŒì¼
#include "msg_srv_action_interface_example/msg/arithmetic_argument.hpp"

// rclcppì˜ Node í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ëŠ” Argument í´ë˜ìŠ¤
class Argument : public rclcpp::Node
{
public:
  using ArithmeticArgument = msg_srv_action_interface_example::msg::ArithmeticArgument;

  // Argument í´ë˜ìŠ¤ì˜ ìƒì„±ìëŠ” rclcppì˜ NodeOptionsë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤. NodeOptionsì—ëŠ” context, arguments, intra process communication, parameter, allocatorì™€ ê°™ì€ Node ìƒì„±ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì˜µì…˜ì´ ì¡´ì¬
  explicit Argument(const rclcpp::NodeOptions & node_options = rclcpp::NodeOptions());
  virtual ~Argument();

private:
  void publish_random_arithmetic_arguments();
  void update_parameter();

  // í† í”½ ë©”ì‹œì§€ì— ë‹´ì„ ëœë¤ ë³€ìˆ˜ì˜ ë²”ìœ„
  float min_random_num_;
  float max_random_num_;

  // publisherì™€ timerbase ë©¤ë²„ë³€ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆë‹¤.
  rclcpp::Publisher<ArithmeticArgument>::SharedPtr arithmetic_argument_publisher_;
  rclcpp::TimerBase::SharedPtr timer_;
  rclcpp::Subscription<rcl_interfaces::msg::ParameterEvent>::SharedPtr parameter_event_sub_;
  rclcpp::AsyncParametersClient::SharedPtr parameters_client_;
};
#endif  // ARITHMETIC__ARGUMENT_HPP_
```

&nbsp;

- ì†ŒìŠ¤ íŒŒì¼

```cpp
// Cì–¸ì–´ í‘œì¤€ ì¸í’‹ ì•„ì›ƒí’‹ ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <cstdio>
#include <memory>
#include <string>
#include <utility>

// ëœë¤ ìˆ«ì ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <random>

#include "rclcpp/rclcpp.hpp"

/// í”„ë¡œê·¸ë¨ ì‹¤í–‰ì‹œ ë„˜ê²¨ë°›ì€ ì¸ìë¥¼ ë‹¤ë£¨ëŠ” ROS2 ë¼ì´ë¸ŒëŸ¬ë¦¬
#include "rcutils/cmdline_parser.h"

// ìœ„ì—ì„œ ìƒì„±í•œ argument í—¤ë” íŒŒì¼
#include "arithmetic/argument.hpp"

using namespace std::chrono_literals;

// Argument í´ë˜ìŠ¤, ë¶€ëª¨ í´ë˜ìŠ¤ì¸ rclcpp:Nodeë¥¼ ì„ ì–¸í•´ì£¼ì—ˆëŠ”ë°, ì²«ë²ˆì§¸ ì¸ìì—ëŠ” ë…¸ë“œ ì´ë¦„ì„, ë‘ë²ˆì§¸ ì¸ìì—ëŠ” ë…¸ë“œ ì˜µì…˜ ë³€ìˆ˜ë¥¼ ëª…ì‹œí•œë‹¤.
Argument::Argument(const rclcpp::NodeOptions & node_options)
: Node("argument", node_options),
  min_random_num_(0.0),
  max_random_num_(0.0)
{
  // QoSëŠ” QoS ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ depthë¥¼ 10ìœ¼ë¡œ í•œë‹¤. 
  this->declare_parameter("qos_depth", 10);
  int8_t qos_depth = this->get_parameter("qos_depth").get_value<int8_t>();

  // ëœë¤ê°’ ì¤‘ ìµœì†Œê°’ë¡œ 0ì„¤ì •
  this->declare_parameter("min_random_num", 0.0);
  min_random_num_ = this->get_parameter("min_random_num").get_value<float>();

  // ëœë¤ê°’ ì¤‘ ìµœëŒ€ê°’ë¡œ 9ì„¤ì •
  this->declare_parameter("max_random_num", 9.0);
  max_random_num_ = this->get_parameter("max_random_num").get_value<float>();

  this->update_parameter();

  /*
  - History ì˜µì…˜: KeepLast(depth : 10)
  - Reliability ì˜µì…˜: reliable
  - Durability ì˜µì…˜: volatile
  */
  const auto QOS_RKL10V =
    rclcpp::QoS(rclcpp::KeepLast(qos_depth)).reliable().durability_volatile();

  // QoSëŠ” publisherë¥¼ ì´ˆê¸°í™”í•  ë•Œ ë‘ë²ˆì§¸ ì¸ìë¡œ ë“¤ì–´ê°€ê³ , ì²«ë²ˆì§¸ ì¸ìëŠ” ë©”ì‹œì§€ í†µì‹ ì— ì‚¬ìš©ë  í† í”½ëª…
  arithmetic_argument_publisher_ =
    this->create_publisher<ArithmeticArgument>("arithmetic_argument", QOS_RKL10V);

  // 1ì´ˆë‹¹ 1ë²ˆì”© publisher_random_arithmetic_arguments ë©¤ë²„í•¨ìˆ˜ê°€ í˜¸ì¶œí•˜ë„ë¡ ì„¤ì •
  timer_ =
    this->create_wall_timer(1s, std::bind(&Argument::publish_random_arithmetic_arguments, this));
}

Argument::~Argument()
{
}

// timerì— ì˜í•´ 1ì´ˆë‹¹ 1ë²ˆì”© í˜¸ì¶œ
void Argument::publish_random_arithmetic_arguments()
{
  std::random_device rd;
  std::mt19937 gen(rd());

  // ROS2 íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ ì–»ì€ ìˆ«ìê°€ min(0) ê³¼ max(9) ì‚¬ì´ì˜ ëœë¤í•œ ê°’ìœ¼ë¡œ ìˆ«ìë¥¼ ìƒì„±
  std::uniform_real_distribution<float> distribution(min_random_num_, max_random_num_);

  // msg_srv_action_interface_example íŒ¨í‚¤ì§€ì— ìˆëŠ” msg ì¸í„°í˜ì´ìŠ¤ë¥¼ ì„ ì–¸
  msg_srv_action_interface_example::msg::ArithmeticArgument msg;

  // time-stamp
  msg.stamp = this->now();

  // argument a
  msg.argument_a = distribution(gen);

  // argument b
  msg.argument_b = distribution(gen);

  // í† í”½ ë°œí–‰
  arithmetic_argument_publisher_->publish(msg);

  // logging
  RCLCPP_INFO(this->get_logger(), "Published argument_a %.2f", msg.argument_a);
  RCLCPP_INFO(this->get_logger(), "Published argument_b %.2f", msg.argument_b);
}


void Argument::update_parameter()
{
  parameters_client_ = std::make_shared<rclcpp::AsyncParametersClient>(this);
  while (!parameters_client_->wait_for_service(1s)) {
    if (!rclcpp::ok()) {
      RCLCPP_ERROR(this->get_logger(), "Interrupted while waiting for the service. Exiting.");
      return;
    }
    RCLCPP_INFO(this->get_logger(), "service not available, waiting again...");
  }

  auto param_event_callback =
    [this](const rcl_interfaces::msg::ParameterEvent::SharedPtr event) -> void
    {
      for (auto & changed_parameter : event->changed_parameters) {
        if (changed_parameter.name == "min_random_num") {
          auto value = rclcpp::Parameter::from_parameter_msg(changed_parameter).as_double();
          min_random_num_ = value;
        } else if (changed_parameter.name == "max_random_num") {
          auto value = rclcpp::Parameter::from_parameter_msg(changed_parameter).as_double();
          max_random_num_ = value;
        }
      }
    };

  parameter_event_sub_ = parameters_client_->on_parameter_event(param_event_callback);
}

// help
void print_help()
{
  printf("For argument node:\n");
  printf("node_name [-h]\n");
  printf("Options:\n");
  printf("\t-h Help           : Print this help function.\n");
}


int main(int argc, char * argv[])
{
  // cmdline_parser ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬, ë§Œì•½ ëª…ë ¹ ì¸ìì— -h ê°€ ìˆì„ ê²½ìš° print_help í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ì¢…ë£Œ
  if (rcutils_cli_option_exist(argv, argv + argc, "-h")) {
    print_help();
    return 0;
  }

  // ì´ˆê¸°í™”
  rclcpp::init(argc, argv);
  
  // Argument í´ë˜ìŠ¤ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™”
  auto argument = std::make_shared<Argument>();
  
  // publish_random_arithmetic_arguments ì‹¤í–‰
  rclcpp::spin(argument);
  
  // ctrl+cì™€ ê°™ì€ ì‹œê·¸ë„ì„ í†µí•´ ë…¸ë“œ ì¢…ë£Œë¥¼ ì¢…ë£Œ
  rclcpp::shutdown();

  return 0;
}
```

íŒŒë¼ë¯¸í„°ì™€ ê´€ë ¨ëœ ë¶€ë¶„ì€ ì¶”í›„ ë‹¤ë£¨ë„ë¡ í•œë‹¤.

&nbsp;

### ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„

í† í”½ ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ ë…¸ë“œëŠ” calculator ë…¸ë“œì´ë‹¤. calculatorì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” í† í”½ ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„, ì„œë¹„ìŠ¤ ì„œë²„, ì•¡ì…˜ ì„œë²„ë¥¼ ëª¨ë‘ í¬í•¨í•˜ê³  ìˆì–´ì„œ ë§¤ìš° ê¸¸ì–´ì„œ í† í”½ ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ì™€ ê´€ë ¨ëœ ë¶€ë¶„ë§Œ ì‚´í´ë³´ë„ë¡ í•œë‹¤.

calculator í´ë˜ìŠ¤ëŠ” í† í”½ í¼ë¸”ë¦¬ì…” ë…¸ë“œì™€ ë§ˆì°¬ê°€ì§€ë¡œ rclcpp::nodeë¥¼ ìƒì†í•˜ê³ , ìƒì„±ìì—ì„œ calculatorë¼ëŠ” ë…¸ë“œ ì´ë¦„ìœ¼ë¡œ ì´ˆê¸°í™”ëœë‹¤. ê·¸ë¦¬ê³  ìœ„ì—ì„œì™€ ë™ì¼í•˜ê²Œ QoSë¥¼ ìƒì„±í•œë‹¤.

ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ëŠ” `create_subscription`ì„ í†µí•´ ì´ˆê¸°í™”ë˜ê³ , í•´ë‹¹ í•¨ìˆ˜ëŠ” í† í”½ëª…ê³¼ QoS, ì½œë°±í•¨ìˆ˜ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤. ì²«ë²ˆì§¸, ë‘ë²ˆì§¸ ì¸ìëŠ” Argument í´ë˜ìŠ¤ì™€ ë™ì¼í•˜ê²Œ ë„£ê³ , ì½œë°±í•¨ìˆ˜ëŠ” std::bindê°€ ì•„ë‹Œ **ëŒë‹¤ í‘œí˜„ì‹**ì„ ì‚¬ìš©í–ˆë‹¤. ì½œë°±í•¨ìˆ˜ë¥¼ ë³´ë©´ ì¸ìë¥¼ í†µí•´ ìˆ˜ì‹ ë°›ì€ ë©”ì‹œì§€ì— ì ‘ê·¼í•˜ì—¬ ë©¤ë²„ ë³€ìˆ˜ì— ì €ì¥í•œë‹¤.

&nbsp;

1. Node ì„¤ì •
2. QoS ì„¤ì •
3. create_subscription ì„¤ì •
4. ì„œë¸ŒìŠ¤í¬ë¼ì´ë¸Œ í•¨ìˆ˜ ì‘ì„±

&nbsp;

- ì†ŒìŠ¤íŒŒì¼

```cpp
  // QoS ì„¤ì • - history : KeepLast, Reliability : reliable, Durability : volatile
  const auto QOS_RKL10V =
    rclcpp::QoS(rclcpp::KeepLast(qos_depth)).reliable().durability_volatile();
  
  // ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ ì´ˆê¸°í™”, [í† í”½ëª…, QoS]
  arithmetic_argument_subscriber_ = this->create_subscription<ArithmeticArgument>(
    "arithmetic_argument",
    QOS_RKL10V,
    [this](const ArithmeticArgument::SharedPtr msg) -> void
    {
      argument_a_ = msg->argument_a;
      argument_b_ = msg->argument_b;
      
      // logging - timestamp
      RCLCPP_INFO(
        this->get_logger(),
        "Subscribed at: sec %ld nanosec %ld",
        msg->stamp.sec,
        msg->stamp.nanosec);
      
      // logging - argument a, argument b
      RCLCPP_INFO(this->get_logger(), "Subscribed argument a : %.2f", argument_a_);
      RCLCPP_INFO(this->get_logger(), "Subscribed argument b : %.2f", argument_b_);
    }
  );
```

&nbsp;

&nbsp;

### ì‹¤í–‰

ì‹¤í–‰í•˜ê¸° ì „ì— CMakeLists.txtë¥¼ í™•ì¸í•´ì„œ add_executable íƒœê·¸ì— ì•Œë§ê²Œ ë“¤ì–´ê°€ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

```txt
add_executable(argument src/arithmetic/argument.cpp)
add_executable(calculator src/calculator/main.cpp src/calculator/calculator.cpp)
```

ì²«ë²ˆì§¸ ì¸ìëŠ” ì‹¤í–‰ëª…, ê·¸ ë‹¤ìŒ ì¸ìë¶€í„°ëŠ” ì‹¤í–‰í•  ì†ŒìŠ¤íŒŒì¼ì´ë‹¤.

&nbsp;

ì‹¤í–‰ì€ `run`ê³¼ `launch` ë‘ê°€ì§€ ë°©ì‹ì´ ìˆë‹¤.

```bash
$ ros2 run topic_service_action_rclcpp_example calculator
```

```bash
$ ros2 run topic_service_action_rclcpp_example argument
```

&nbsp;

```bash
$ ros2 launch topic_service_action_rclcpp_example arithmetic.launch.py
```

&nbsp;

ë‘ ë°©ë²• ëª¨ë‘ ë™ì‘í•˜ëŠ” ê²ƒì€ ë™ì¼í•˜ë‹¤.

&nbsp;